<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MENITI SEJARAH Perlawanan Daerah</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Desain yang lebih modern - Dominan Merah */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937; /* Latar belakang gelap */
            background-image: linear-gradient(135deg, #1f1f1f 0%, #0f0f0f 100%); /* Warna yang lebih gelap */
        }
        .container-card {
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .container-card:hover {
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.7);
        }
        .pulsate {
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .mission-button {
            transition: all 0.3s ease;
        }
        /* Mengubah warna hover dari Indigo ke Merah */
        .mission-button:hover {
            transform: scale(1.02);
            background-color: #ef4444; /* red-500 */
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.5);
        }
        .option-button {
            transition: all 0.2s;
            border-radius: 0.5rem;
        }
        .option-button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        /* Gaya spesifik untuk tombol grid (Benar/Salah) */
        .grid-option-btn {
            @apply p-2 rounded-lg text-sm font-semibold transition duration-150;
            @apply flex items-center justify-center;
            min-width: 60px;
        }
    </style>
</head>
<!-- Anti-Cheating: Disabling right-click, copy, and select start -->
<body class="p-4 md:p-8 min-h-screen flex justify-center items-start md:items-center" oncontextmenu="return false;" oncopy="return false;" onselectstart="return false;">

    <!-- Kontainer Utama Aplikasi -->
    <div id="app" class="w-full max-w-2xl bg-gray-800 p-6 md:p-10 rounded-xl container-card text-white">
        <h1 class="text-4xl font-extrabold text-center text-red-500 mb-2 tracking-wide">MENITI SEJARAH</h1>
        <p class="text-xl font-light text-center text-gray-300 mb-8">Perlawanan Rakyat Daerah</p>

        <!-- Area Status & Permainan -->
        <div id="game-container">
            
            <!-- LAYAR PEMUATAN GLOBAL -->
            <div id="loading-screen" class="text-center py-10 hidden">
                <p class="text-xl font-semibold text-red-400 mb-4 pulsate">Memuat Data Game...</p>
                <div class="w-16 h-16 border-4 border-red-200 border-t-red-500 rounded-full animate-spin mx-auto mb-4"></div>
                <p id="loading-detail" class="text-sm text-gray-400">Menyiapkan struktur soal...</p>
            </div>

            <!-- LAYAR 0: INTRO / PROFILE INPUT -->
            <div id="intro-screen" class="hidden">
                <h2 class="text-3xl font-bold text-center mb-6 text-white">Selamat Datang, Pahlawan!</h2>
                
                <div class="bg-gray-700 p-6 rounded-xl mb-8 shadow-2xl border border-red-500/50">
                    <h3 class="text-xl font-extrabold mb-4 text-red-400 border-b border-red-700 pb-2">Instruksi Misi</h3>
                    
                    <div class="grid md:grid-cols-2 gap-4 text-gray-300 text-sm">
                        
                        <!-- Kolom 1: Struktur & Navigasi -->
                        <div class="space-y-3">
                            <div class="flex items-start">
                                <span class="text-red-400 font-extrabold mr-2 mt-[-3px] text-lg">&bull;</span>
                                <span>Anda wajib menyelesaikan <strong>4 misi</strong> yang tersedia.</span>
                            </div>
                            <div class="flex items-start">
                                <span class="text-red-400 font-extrabold mr-2 mt-[-3px] text-lg">&bull;</span>
                                <span>Setiap misi terdiri dari <strong>10 soal</strong> dengan beragam tipe.</span>
                            </div>
                            <div class="flex items-start">
                                <span class="text-red-400 font-extrabold mr-2 mt-[-3px] text-lg">&bull;</span>
                                <span>Tingkat kesulitan soal berjenjang, dari <strong>Mudah</strong> hingga <strong>HOTS</strong> (Analisis Kritis).</span>
                            </div>
                            <div class="flex items-start">
                                <span class="text-red-400 font-extrabold mr-2 mt-[-3px] text-lg">&bull;</span>
                                <span>Gunakan tombol "<strong>Lewati Soal</strong>" untuk mengerjakan soal secara non-linear (soal yang dilewati dapat dikerjakan kembali).</span>
                            </div>
                        </div>

                        <!-- Kolom 2: Scoring & Aturan -->
                        <div class="space-y-3">
                            <div class="flex items-start">
                                <span class="text-red-400 font-extrabold mr-2 mt-[-3px] text-lg">&bull;</span>
                                <span>Skor maksimal yang dapat Anda raih per misi adalah <strong>100 Poin</strong>.</span>
                            </div>
                            <div class="flex items-start">
                                <span class="text-red-400 font-extrabold mr-2 mt-[-3px] text-lg">&bull;</span>
                                <span>Waktu pengerjaan akan dicatat. Jawab dengan cermat dan raih skor tertinggi!</span>
                            </div>
                            <div class="flex items-start font-semibold text-yellow-400">
                                <span class="text-red-500 font-extrabold mr-2 mt-[-3px] text-lg">&bull;</span>
                                <span class="text-red-300">Aturan Pelanggaran: Anda hanya memiliki <strong>2 kali kesempatan pelanggaran</strong> (Pindah Tab/Aplikasi). Pelanggaran ke-3 akan mengakhiri game secara paksa.</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label for="nama-input" class="block text-sm font-medium text-gray-300 mb-1">Nama Lengkap:</label>
                        <input type="text" id="nama-input" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:ring-red-500 focus:border-red-500" placeholder="Contoh: R.A. Kartini">
                    </div>
                    <div>
                        <label for="jurusan-input" class="block text-sm font-medium text-gray-300 mb-1">Jurusan:</label>
                        <select id="jurusan-input" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-red-500 focus:border-red-500">
                            <option value="" disabled selected>-- Pilih Jurusan --</option>
                            <option value="FARMASI 1">FARMASI 1</option>
                            <option value="FARMASI 2">FARMASI 2</option>
                            <option value="KEPERAWATAN 1">KEPERAWATAN 1</option>
                            <option value="KEPERAWATAN 2">KEPERAWATAN 2</option>
                            <option value="TJKT 1">TJKT 1</option>
                            <option value="TJKT 2">TJKT 2</option>
                            <option value="TKR">TKR</option>
                            <option value="TBSM 1">TBSM 1</option>
                            <option value="TBSM 2">TBSM 2</option>
                        </select>
                    </div>
                    <div>
                        <label for="kelas-input" class="block text-sm font-medium text-gray-300 mb-1">Kelas:</label>
                        <select id="kelas-input" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-red-500 focus:border-red-500">
                            <option value="" disabled selected>-- Pilih Kelas --</option>
                            <option value="X">X</option>
                            <option value="XI">XI</option>
                            <option value="XII">XII</option>
                        </select>
                    </div>
                </div>
                
                <button id="start-profile-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 mt-8 disabled:bg-red-400">
                    Mulai Misi Sejarah
                </button>
            </div>

            <!-- LAYAR PILIH MISI -->
            <div id="mission-select-screen" class="hidden">
                <h2 class="text-3xl font-bold mb-8 text-center text-white">Pilih Medan Perang Anda</h2>
                <div class="bg-gray-700 p-4 rounded-lg mb-6 text-center">
                    <span class="text-lg font-semibold text-red-400">Status Game: </span>
                    <span id="game-progress-display" class="text-lg text-white">0/4 Misi Selesai</span>
                </div>
                <div id="mission-list" class="space-y-4">
                    <!-- Tombol Misi di-render oleh JS -->
                </div>
            </div>
            
            <!-- LAYAR DALAM MISI -->
            <div id="in-mission-screen" class="hidden">
                <div class="bg-gray-700 p-3 rounded-lg mb-6 flex justify-between items-center text-sm">
                    <div>
                        <span class="text-red-400 font-semibold">Peserta:</span> 
                        <span id="user-name-display" class="text-white"></span>
                    </div>
                    <div>
                        <span class="text-red-400 font-semibold">Waktu Misi:</span> 
                        <span id="mission-time-display" class="text-white font-mono">00:00</span>
                    </div>
                </div>
                <!-- SKOR SEMENTARA MISI INI -->
                <div class="bg-red-900/50 p-3 rounded-lg mb-6 text-center">
                    <span class="text-red-300 font-semibold">SKOR MISI INI:</span> 
                    <span id="mission-current-score" class="text-yellow-300 font-extrabold text-xl">0</span>
                    <span class="text-red-300 font-semibold">/ 100</span>
                </div>

                <h2 class="text-3xl font-bold text-center text-red-400 mb-4" id="mission-title"></h2>
                
                <!-- Navigasi Soal (Non-Linear) -->
                <div id="question-navigation" class="flex flex-wrap justify-center space-x-2 space-y-2 mb-6 p-3 bg-gray-700 rounded-xl shadow-lg">
                    <!-- Navbol Misi di-render oleh JS -->
                </div>

                <div id="question-card" class="bg-gray-700 p-6 rounded-xl shadow-2xl border border-red-500/50">
                    <p class="text-sm font-medium text-gray-400 mb-3 flex justify-between">
                        <span id="question-type-display"></span>
                        <span id="question-difficulty" class="font-bold text-yellow-300"></span>
                    </p>
                    <p class="text-2xl font-semibold text-white mb-4" id="question-text"></p>
                    
                    <button id="play-audio-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 mb-4 flex items-center justify-center disabled:bg-red-400">
                        <svg class="w-5 h-5 mr-2 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.26a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Dengarkan Audio Soal
                    </button>

                    <div id="question-input-area" class="space-y-3 mb-6">
                        <!-- Area Input/Opsi Jawaban (dinamis) -->
                    </div>

                    <div id="feedback-message" class="text-center text-lg font-extrabold mt-4"></div>
                </div>

                <div class="flex justify-between mt-6">
                    <button id="skip-btn" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-4 rounded-lg transition duration-200 disabled:opacity-50">
                        Lewati Soal
                    </button>
                    <!-- Tombol Tanya Ahli (Hidden by default) -->
                    <button id="consult-expert-btn" class="hidden bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                        Tanya Ahli (Max 5 Poin)
                    </button>
                    <button id="submit-answer-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 disabled:bg-green-300">
                        Jawab dan Lanjutkan
                    </button>
                </div>
                <button id="finish-mission-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 mt-4 hidden">
                    Selesaikan Misi
                </button>
            </div>

            <!-- LAYAR PELANGGARAN ATURAN BARU -->
            <div id="penalty-screen" class="hidden text-center py-10 bg-gray-700 rounded-xl container-card">
                <h2 class="text-4xl font-extrabold text-red-600 mb-4">PELANGGARAN TERDETEKSI! ⚠️</h2>
                <p class="text-xl text-gray-300 mb-6">Anda telah melanggar aturan game.</p>
                <div class="p-8 bg-gray-800 rounded-xl shadow-lg inline-block border-2 border-yellow-600">
                    <p class="text-3xl font-bold text-red-400 mb-2" id="penalty-reason"></p>
                    <p class="text-base text-gray-400">Pelanggaran ke: <span id="penalty-count" class="text-red-400 font-bold">1</span> dari <span class="text-red-400 font-bold">2</span></p>
                </div>
                <div class="mt-8">
                    <button id="penalty-continue-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200">
                        Lanjutkan Misi
                    </button>
                </div>
            </div>

            <!-- LAYAR AKHIR MISI -->
            <div id="final-screen" class="hidden text-center py-10 bg-gray-700 rounded-xl container-card">
                <h2 class="text-4xl font-extrabold text-red-400 mb-4">Misi Selesai! 🎉</h2>
                <p class="text-xl text-gray-300 mb-6">Skor Akhir <span id="mission-final-title" class="text-red-400 font-bold"></span>:</p>
                <div class="p-8 bg-gray-800 rounded-xl shadow-lg inline-block border-2 border-red-600">
                    <!-- MAX SCORE 100 -->
                    <p class="text-6xl font-extrabold text-green-400" id="mission-final-score">0</p>
                    <p class="text-base text-gray-400 mt-2">Poin dari <span id="max-game-score"></span> Maksimal</p>
                    <p class="text-sm text-gray-400 mt-4">Waktu Total Pengerjaan: <span id="total-time-display">00:00</span></p>
                </div>
                <div class="mt-8">
                    <p class="text-sm text-gray-400 mb-4">Terima kasih, <span id="final-user-info"></span>!</p>
                    <!-- Tombol Awal: Pilih Misi Lain. Diganti jika Game Selesai -->
                    <button id="next-action-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 mr-3">
                        Pilih Misi Lain
                    </button>
                </div>
            </div>
        </div>

        <!-- Area Notifikasi Modal -->
        <div id="modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-50">
            <div class="bg-gray-800 p-6 rounded-xl shadow-xl max-w-sm w-full border border-red-500">
                <h3 class="text-xl font-bold mb-3 text-red-400" id="modal-title">Kesalahan</h3>
                <p id="modal-body" class="mb-4 text-gray-300">Terjadi kesalahan.</p>
                <button id="modal-close-btn" class="bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition duration-150">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Script Firebase & Logic Game -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // --- Konfigurasi dan Setup Firebase (Hanya untuk User ID) ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app, auth;
        let userId = 'anon'; 
        let currentAudio = null; 
        let userInfo = { nama: '', jurusan: '', kelas: '' }; 
        
        // --- KONFIGURASI GOOGLE APPS SCRIPT ---
        // NOTE: Ganti URL ini dengan URL Web App Google Apps Script Anda untuk menyimpan hasil
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxMp_1DplyWKRpvXsj7psoIZhvDxa8FB1DY5Ug7JXAZrncMozummp1G_tJww6Sz-UK02w/exec'; 
        
        // --- KUNCI API TTS ---
        const TTS_API_KEY = ""; 
        
        // --- Timer State ---
        let missionActiveStartTimestamp = null; // Menyimpan waktu saat terakhir kali state di-save/diaktifkan
        let timerInterval = null;
        let totalTimeSeconds = 0;
        
        // --- Global State dan Flags ---
        // PENTING: Gunakan flag ini untuk mencegah deteksi pelanggaran saat loading
        let isAppInitializing = true; 
        
        // --- Haptics and Sound ---
        const triggerHaptics = (duration = 50) => {
            if (navigator.vibrate) {
                navigator.vibrate(duration);
            }
        }

        // --- Data Misi dan Soal ---
        const POINTS_PER_QUESTION = 10;
        const CONSULT_HINT_SCORE = 5;
        const MAX_CHEATING_ATTEMPTS = 3;
        
        const SCORE_MAP = {
            'narrative_mc': POINTS_PER_QUESTION, 
            'multiple_choice': POINTS_PER_QUESTION, 
            'true_false': POINTS_PER_QUESTION,
            'multiple_correct': POINTS_PER_QUESTION,
            'matching': POINTS_PER_QUESTION,
            'essay': POINTS_PER_QUESTION,
            'grid_tf': POINTS_PER_QUESTION, // NEW: Score untuk soal grid
        };
        const MAX_MISSION_SCORE = 100; // Disesuaikan untuk 10 soal
        const MAX_GAME_SCORE = 400; // Disesuaikan untuk 4 misi x 100

        // --- Konten Soal Baru (10 Soal per Misi) ---
        const missionData = {
            "Perlawanan Aceh": [
                { id: 'aceh_1', type: 'narrative_mc', question: "Selamat datang di Misi Perlawanan Aceh. Dengarkan baik-baik narasi berikut: Setelah jatuhnya Malaka ke tangan Portugis pada tahun 1511, banyak pedagang Muslim memindahkan kegiatan mereka ke Aceh. Sultan Ali Mughayat Syah kemudian memimpin Aceh untuk merebut kembali wilayah penting seperti Pasai dan memimpin serangan pertama terhadap Portugis di Malaka untuk mengamankan posisi Aceh sebagai pusat perdagangan Islam yang baru. Berdasarkan narasi, apa peran utama Sultan Ali Mughayat Syah setelah jatuhnya Malaka?", difficulty: 'MUDAH', options: ["Membuat perjanjian damai dengan Portugis", "Mendirikan pusat militer di Pulau Weh", "Mempimpin Aceh merebut wilayah Pasai dan menyerang Portugis", "Mengekspor rempah-rempah langsung ke Eropa"], answer: "Mempimpin Aceh merebut wilayah Pasai dan menyerang Portugis", points: SCORE_MAP.narrative_mc }, 
                // Grid TF 1
                { 
                    id: 'aceh_2', 
                    type: 'grid_tf', 
                    question: "Narasi: Kesultanan Aceh, yang berkembang setelah jatuhnya Malaka, memiliki ambisi besar untuk menguasai jalur perdagangan Selat Malaka. Perlawanan terhadap Portugis tidak hanya bermotif ekonomi, tetapi juga keagamaan, di mana Aceh berupaya menjadi pusat penyebaran Islam yang kuat di Nusantara.\n\nTandai Benar atau Salah untuk setiap pernyataan berdasarkan narasi di atas:", 
                    difficulty: 'SEDANG', 
                    gridItems: [
                        { text: "Keinginan menguasai Selat Malaka sebagai jalur perdagangan utama adalah motif perlawanan.", answer: true }, 
                        { text: "Upaya membalas dendam atas kekalahan Kesultanan Demak di Jawa adalah pendorong utama.", answer: false }, 
                        { text: "Perlawanan Aceh hanya didorong oleh faktor murni ekonomi tanpa motif keagamaan.", answer: false }, 
                        { text: "Aceh berhasil merebut Malaka kembali dari Portugis pada masa Sultan Ali Mughayat Syah.", answer: false }
                    ],
                    points: SCORE_MAP.grid_tf
                },
                { id: 'aceh_3', type: 'true_false', question: "Benar atau salah: Aceh dan Turki Utsmani pernah menjalin hubungan diplomatik untuk meminta bantuan militer.", difficulty: 'MUDAH', answer: true, points: SCORE_MAP.true_false }, 
                { id: 'aceh_4', type: 'multiple_choice', question: "Faktor utama yang mendorong Sultan-Sultan Aceh untuk terus melawan Portugis adalah monopoli perdagangan di:", difficulty: 'MUDAH', options: ["Laut Jawa", "Laut Banda", "Selat Sunda", "Selat Malaka"], answer: "Selat Malaka", points: SCORE_MAP.multiple_choice }, 
                { id: 'aceh_5', type: 'multiple_choice', question: "Pasukan maritim Aceh yang terkenal di masa Sultan Iskandar Muda bernama?", difficulty: 'SEDANG', options: ["Panglima Armada", "Pasukan Iskandar", "Cakra Donya", "Gajah Putih"], answer: "Cakra Donya", points: SCORE_MAP.multiple_choice }, 
                { id: 'aceh_6', type: 'multiple_correct', question: "Pilih dua cara yang dilakukan Sultan Iskandar Muda untuk memajukan Kesultanan Aceh?", difficulty: 'SEDANG', options: ["Menciptakan Undang-Undang 'Adat Meukuta Alam'", "Menguatkan ajaran agama Islam di Aceh", "Mengadakan perjanjian dengan VOC di Batavia", "Mengembangkan industri minyak bumi"], correctAnswers: ["Menciptakan Undang-Undang 'Adat Meukuta Alam'", "Menguatkan ajaran agama Islam di Aceh"], points: SCORE_MAP.multiple_correct }, 
                { id: 'aceh_7', type: 'matching', question: "Cocokkan tokoh dengan perannya dalam perlawanan abad ke-16.", difficulty: 'SEDANG', matches: [{ prompt: "Sultan Ali Mughayat Syah", target: "Pendiri dan Pemimpin Serangan Pertama ke Portugis" }, { prompt: "Sultan Iskandar Muda", target: "Penguasa Masa Keemasan Aceh" }, { prompt: "Fatahillah", target: "Pahlawan Perlawanan Demak" }], points: SCORE_MAP.matching },
                // Grid TF 2
                { 
                    id: 'aceh_8', 
                    type: 'grid_tf', 
                    question: "Narasi: Meskipun Aceh terkenal dengan kekuatan armada lautnya yang besar pada masa Iskandar Muda, VOC tetap berusaha menanamkan pengaruh. VOC tahu bahwa cara terbaik untuk melemahkan Aceh adalah dengan menguasai jalur ekspor lada dan timah di pantai timur Sumatera, bukan dengan menyerang pusat kekuasaan di Banda Aceh.\n\nTandai Benar atau Salah untuk setiap pernyataan berdasarkan narasi di atas:", 
                    difficulty: 'SULIT', 
                    gridItems: [
                        { text: "VOC takut menyerang Aceh secara langsung karena kekuatan armada laut Aceh.", answer: true }, 
                        { text: "Strategi VOC berfokus pada perebutan jalur ekspor rempah-rempah daripada ibu kota Aceh.", answer: true }, 
                        { text: "Aceh selalu berhasil mengusir semua serangan VOC di sepanjang pantai timur Sumatera.", answer: false }, 
                        { text: "Puncak kekalahan Aceh terjadi saat VOC berhasil memblokade total Selat Malaka.", answer: false }
                    ],
                    points: SCORE_MAP.grid_tf
                },
                { id: 'aceh_9', type: 'multiple_correct', question: "Pilih dua kerajaan di Nusantara yang pernah menjadi sekutu Aceh dalam upaya melawan Portugis?", difficulty: 'SULIT', options: ["Kesultanan Demak", "Kesultanan Ternate", "Kerajaan Johor", "Kesultanan Mataram"], correctAnswers: ["Kesultanan Ternate", "Kerajaan Johor"], points: SCORE_MAP.multiple_correct }, 
                { id: 'aceh_10', type: 'essay', question: "Analisis: Mengapa serangan masif Sultan Iskandar Muda ke Malaka pada 1629, meskipun gagal menaklukkan benteng Portugis, tetap dianggap sebagai pencapaian militer dan politik yang signifikan bagi Kesultanan Aceh?", difficulty: 'HOTS', minWords: 30, points: SCORE_MAP.essay } 
            ],
            "Perlawanan Maluku (Pattimura)": [
                { id: 'maluku_1', type: 'narrative_mc', question: "Selamat datang di Misi Perlawanan Maluku. Dengarkan baik-baik narasi berikut: Setelah Inggris menyerahkan Maluku kepada Belanda pada tahun 1817, Belanda segera mengaktifkan kembali praktik monopoli rempah-rempah yang sangat merugikan rakyat, menghapus uang kertas, dan menghapus hak-hak masyarakat adat. Kebijakan ini, ditambah dengan wajib militer dan kerja rodi, memicu kemarahan massal. Berdasarkan narasi, apa kebijakan ekonomi Belanda yang sangat membebani rakyat Maluku pasca kedatangan kembali Inggris?", difficulty: 'MUDAH', options: ["Monopoli cengkeh dan pala", "Kewajiban kerja paksa di tambang batu bara", "Pajak tanah yang sangat tinggi", "Larangan berlayar di Laut Banda"], answer: "Monopoli cengkeh dan pala", points: SCORE_MAP.narrative_mc }, 
                // Grid TF 1
                { 
                    id: 'maluku_2', 
                    type: 'grid_tf', 
                    question: "Narasi: Pada tahun 1817, di bawah kepemimpinan Thomas Matulessy (Pattimura), rakyat Maluku melakukan perlawanan besar yang diawali dengan perebutan Benteng Duurstede di Saparua, di mana Residen Van den Berg tewas. Perlawanan ini terkenal karena memiliki dukungan lintas agama yang kuat, melibatkan tokoh Kristen maupun Muslim.\n\nTandai Benar atau Salah untuk setiap pernyataan berdasarkan narasi di atas:", 
                    difficulty: 'SEDANG', 
                    gridItems: [
                        { text: "Benteng Duurstede berhasil direbut oleh pasukan Pattimura.", answer: true }, 
                        { text: "Pattimura adalah nama asli Thomas Matulessy.", answer: true }, 
                        { text: "Residen Belanda yang tewas adalah Jenderal De Kock.", answer: false }, 
                        { text: "Perlawanan ini hanya didukung oleh komunitas Kristen di Maluku.", answer: false }
                    ],
                    points: SCORE_MAP.grid_tf
                },
                { id: 'maluku_3', type: 'true_false', question: "Benar atau salah: Perlawanan Pattimura di Maluku terjadi sebelum masa penjajahan Inggris di Nusantara.", difficulty: 'MUDAH', answer: false, points: SCORE_MAP.true_false }, 
                { id: 'maluku_4', type: 'multiple_choice', question: "Tokoh perempuan yang ikut berjuang bersama Pattimura di Pulau Nusalaut adalah?", difficulty: 'MUDAH', options: ["Dewi Sartika", "Martha Christina Tiahahu", "Cut Nyak Dhien", "R.A. Kartini"], answer: "Martha Christina Tiahahu", points: SCORE_MAP.multiple_choice }, 
                { id: 'maluku_5', type: 'multiple_choice', question: "Di benteng manakah Pattimura dihukum gantung oleh Belanda?", difficulty: 'SEDANG', options: ["Benteng Duurstede", "Benteng Victoria", "Benteng Rotterdam", "Benteng Oranye"], answer: "Benteng Victoria", points: SCORE_MAP.multiple_choice }, 
                { id: 'maluku_6', type: 'multiple_correct', question: "Pilih dua alasan kembalinya Belanda ke Maluku (setelah Inggris) sangat memicu kemarahan rakyat?", difficulty: 'SEDANG', options: ["Sistem penyerahan wajib rempah-rempah yang merusak ekonomi", "Pengangkatan raja-raja lokal yang sepihak oleh Belanda", "Pemerintah Belanda mewajibkan seluruh rakyat Maluku menjadi tentara", "Tingginya pajak garam dan gula"], correctAnswers: ["Sistem penyerahan wajib rempah-rempah yang merusak ekonomi", "Pengangkatan raja-raja lokal yang sepihak oleh Belanda"], points: SCORE_MAP.multiple_correct }, 
                { id: 'maluku_7', type: 'matching', question: "Cocokkan tokoh dengan perannya dalam perlawanan 1817.", difficulty: 'SEDANG', matches: [{ prompt: "Pattimura", target: "Pemimpin Perlawanan di Saparua" }, { prompt: "Residen Van den Berg", target: "Kepala Benteng Duurstede" }, { prompt: "Said Perintah", target: "Tokoh Muslim Perlawanan" }], points: SCORE_MAP.matching }, 
                // Grid TF 2
                { 
                    id: 'maluku_8', 
                    type: 'grid_tf', 
                    question: "Narasi: Perjuangan Pattimura berakhir setelah Belanda mengerahkan pasukan besar dari Ambon dan menangkap Pattimura karena pengkhianatan. Ia kemudian dieksekusi di Benteng Victoria. Namun, pengorbanan ini justru menyulut semangat perlawanan yang lebih besar, menjadikan Pattimura simbol perlawanan lintas agama di Maluku.\n\nTandai Benar atau Salah untuk setiap pernyataan berdasarkan narasi di atas:", 
                    difficulty: 'SULIT', 
                    gridItems: [
                        { text: "Pattimura dihukum gantung di Pulau Saparua.", answer: false }, 
                        { text: "Faktor penangkapan Pattimura adalah pengkhianatan yang dilakukan oleh orang lokal.", answer: true }, 
                        { text: "Eksekusi Pattimura secara signifikan meredam semangat perlawanan rakyat Maluku.", answer: false }, 
                        { text: "Perlawanan ini secara politis dianggap simbol persatuan agama di Maluku.", answer: true }
                    ],
                    points: SCORE_MAP.grid_tf
                },
                { id: 'maluku_9', type: 'multiple_correct', question: "Pilih dua tokoh yang berperan sebagai pemimpin perlawanan selain Pattimura?", difficulty: 'SULIT', options: ["Said Perintah", "Anthony Ribok", "Sultan Nuku", "Laksamana Malahayati"], correctAnswers: ["Said Perintah", "Anthony Ribok"], points: SCORE_MAP.multiple_correct }, 
                { id: 'maluku_10', type: 'essay', question: "Analisis: Mengapa Pattimura pada akhirnya harus dihukum mati, dan mengapa hukuman mati tersebut justru meningkatkan semangat perlawanan di kalangan rakyat Maluku?", difficulty: 'HOTS', minWords: 30, points: SCORE_MAP.essay } 
            ],
            "Perlawanan Banten (Sultan Ageng Tirtayasa)": [
                { id: 'banten_1', type: 'narrative_mc', question: "Selamat datang di Misi Perlawanan Banten. Dengarkan baik-baik narasi berikut: Sultan Ageng Tirtayasa dikenal sebagai sultan yang gigih melawan VOC, karena ia menentang keras upaya monopoli. Beliau berusaha menjadikan Banten sebagai pelabuhan internasional yang bebas dari campur tangan VOC, bersaing langsung dengan Batavia. Inilah yang membuat VOC murka dan memicu konflik berkelanjutan. Berdasarkan narasi, apa fokus utama kebijakan Sultan Ageng Tirtayasa yang bertentangan dengan kepentingan VOC?", difficulty: 'MUDAH', options: ["Memperluas lahan pertanian tebu", "Membangun armada laut modern untuk perdagangan bebas", "Menciptakan aliansi dengan Kesultanan Demak", "Memindahkan pusat pemerintahan ke pedalaman"], answer: "Membangun armada laut modern untuk perdagangan bebas", points: SCORE_MAP.narrative_mc }, 
                // Grid TF 1
                { 
                    id: 'banten_2', 
                    type: 'grid_tf', 
                    question: "Narasi: Sultan Ageng Tirtayasa terkenal menentang VOC karena ia ingin Banten tetap menjadi pelabuhan dagang bebas yang menyaingi Batavia. Konflik memuncak ketika VOC memanfaatkan ambisi takhta putra Sultan Ageng, yaitu Sultan Haji. Perpecahan ayah dan anak ini dimanfaatkan VOC sebagai senjata andalan, politik *Devide et Impera*.\n\nTandai Benar atau Salah untuk setiap pernyataan berdasarkan narasi di atas:", 
                    difficulty: 'SEDANG', 
                    gridItems: [
                        { text: "Fokus utama perlawanan Banten adalah menentang monopoli VOC.", answer: true }, 
                        { text: "Sultan Haji adalah pemimpin perlawanan Banten melawan VOC.", answer: false }, 
                        { text: "Konflik internal antara Sultan Ageng dan putranya menjadi celah bagi VOC.", answer: true }, 
                        { text: "Ambisi Sultan Ageng adalah menjadikan Banten pusat militer di Jawa Barat.", answer: false }
                    ],
                    points: SCORE_MAP.grid_tf
                },
                { id: 'banten_3', type: 'true_false', question: "Benar atau salah: Konflik antara Sultan Ageng Tirtayasa dan Sultan Haji terjadi karena perbedaan keyakinan agama.", difficulty: 'MUDAH', answer: false, points: SCORE_MAP.true_false }, 
                { id: 'banten_4', type: 'multiple_choice', question: "Apa kebijakan Sultan Ageng yang paling membuat Banten disegani sebagai kekuatan maritim di abad ke-17?", difficulty: 'MUDAH', options: ["Menciptakan aliansi dengan Mataram", "Memperluas lahan tebu", "Menciptakan armada laut modern", "Mendatangkan pekerja dari China"], answer: "Menciptakan armada laut modern", points: SCORE_MAP.multiple_choice }, 
                { id: 'banten_5', type: 'multiple_choice', question: "Apa nama strategi VOC yang paling merusak internal Kesultanan Banten?", difficulty: 'SEDANG', options: ["Cultuurstelsel", "Devide et Impera", "Benteng Stelsel", "Pax Neerlandica"], answer: "Devide et Impera", points: SCORE_MAP.multiple_choice }, 
                { id: 'banten_6', type: 'multiple_correct', question: "Pilih dua cara yang digunakan Sultan Ageng Tirtayasa untuk melemahkan dominasi VOC di Batavia?", difficulty: 'SEDANG', options: ["Menutup total akses Banten ke pelabuhan Sunda Kelapa", "Mengembangkan bandar perdagangan tandingan yang bebas", "Mengirim mata-mata dan pasukan gerilya untuk mengganggu Batavia", "Membuat perjanjian dagang dengan Spanyol"], correctAnswers: ["Mengembangkan bandar perdagangan tandingan yang bebas", "Mengirim mata-mata dan pasukan gerilya untuk mengganggu Batavia"], points: SCORE_MAP.multiple_correct }, 
                { id: 'banten_7', type: 'matching', question: "Cocokkan nama tokoh dengan hubungannya di masa konflik Banten.", difficulty: 'SEDANG', matches: [{ prompt: "Sultan Ageng Tirtayasa", target: "Penganut Perdagangan Bebas" }, { prompt: "Sultan Haji", target: "Putra Sultan Ageng" }, { prompt: "VOC", target: "Pemicu Konflik Internal" }], points: SCORE_MAP.matching },
                // Grid TF 2
                { 
                    id: 'banten_8', 
                    type: 'grid_tf', 
                    question: "Narasi: Dengan bantuan VOC, Sultan Haji berhasil merebut istana Surosowan. Sultan Ageng Tirtayasa terpaksa mundur ke Tirtayasa dan memimpin perlawanan gerilya yang gigih. Namun, VOC tidak tinggal diam, mereka berhasil menangkap Sultan Ageng melalui tipu muslihat, menandai kekalahan besar Kesultanan Banten. \n\nTandai Benar atau Salah untuk setiap pernyataan berdasarkan narasi di atas:", 
                    difficulty: 'SULIT', 
                    gridItems: [
                        { text: "Benteng Surosowan adalah pusat gerilya Sultan Ageng setelah kekalahan.", answer: false }, 
                        { text: "Kekalahan utama terjadi ketika Sultan Ageng tertangkap melalui tipu muslihat.", answer: true }, 
                        { text: "Sultan Haji mendapat pengakuan sebagai Sultan Banten yang sah setelah membantu VOC.", answer: true }, 
                        { text: "Perlawanan Banten berakhir sepenuhnya setelah Sultan Ageng dieksekusi di Batavia.", answer: false }
                    ],
                    points: SCORE_MAP.grid_tf
                },
                { id: 'banten_9', type: 'multiple_correct', question: "Pilih dua kondisi yang ditawarkan VOC kepada Sultan Haji agar ia bersedia bersekutu melawan ayahnya (Sultan Ageng)?", difficulty: 'SULIT', options: ["Pengakuan sebagai Sultan Banten yang sah", "Pemberian wilayah kekuasaan di Jawa Timur", "Hak monopoli lada di Banten untuk VOC", "Bantuan militer untuk menguasai istana Surosowan"], correctAnswers: ["Pengakuan sebagai Sultan Banten yang sah", "Bantuan militer untuk menguasai istana Surosowan"], points: SCORE_MAP.multiple_correct }, 
                { id: 'banten_10', type: 'essay', question: "Analisis: Banten adalah salah satu perlawanan yang sangat terpengaruh oleh 'politik adu domba' VOC. Analisislah mengapa VOC sangat berhasil menerapkan strategi ini di Banten dibandingkan di Maluku atau Aceh?", difficulty: 'HOTS', minWords: 30, points: SCORE_MAP.essay } 
            ],
            "Perlawanan Gowa (Sultan Hasanuddin)": [
                { id: 'gowa_1', type: 'narrative_mc', question: "Selamat datang di Misi Perlawanan Gowa. Dengarkan baik-baik narasi berikut: Sultan Hasanuddin, yang dijuluki Ayam Jantan dari Timur oleh Belanda, adalah penguasa Kesultanan Gowa yang keras menentang monopoli perdagangan VOC di Indonesia Timur. Gowa dikenal sebagai pusat maritim yang memegang prinsip perdagangan bebas. Konfrontasi ini memuncak dalam Perang Makassar yang sangat merugikan Belanda. Berdasarkan narasi, apa julukan yang diberikan Belanda kepadanya karena keberanian dan kegigihannya melawan VOC?", difficulty: 'MUDAH', options: ["Raja Berani", "Benteng Pertahanan Timur", "Ayam Jantan dari Timur", "Pedang Makassar"], answer: "Ayam Jantan dari Timur", points: SCORE_MAP.multiple_choice }, 
                // Grid TF 1
                { 
                    id: 'gowa_2', 
                    type: 'grid_tf', 
                    question: "Narasi: Kesultanan Gowa yang dipimpin Sultan Hasanuddin (Ayam Jantan dari Timur) adalah musuh utama VOC di Indonesia Timur karena Gowa teguh memegang prinsip perdagangan bebas dan menentang monopoli. VOC kemudian memprovokasi konflik internal dengan sekutu lokal, Arung Palakka dari Bone, yang memiliki dendam pribadi terhadap Gowa.\n\nTandai Benar atau Salah untuk setiap pernyataan berdasarkan narasi di atas:", 
                    difficulty: 'SEDANG', 
                    gridItems: [
                        { text: "Motif utama VOC menyerang Gowa adalah monopoli perdagangan rempah-rempah.", answer: true }, 
                        { text: "Gowa terkenal sebagai pendukung utama kebijakan monopoli dagang.", answer: false }, 
                        { text: "Arung Palakka bersekutu dengan VOC karena alasan politik adu domba.", answer: true }, 
                        { text: "Julukan Ayam Jantan dari Timur diberikan oleh Sultan Bone sebagai bentuk pujian.", answer: false }
                    ],
                    points: SCORE_MAP.grid_tf
                },
                { id: 'gowa_3', type: 'true_false', question: "Benar atau salah: Gowa merupakan salah satu pusat perdagangan maritim terbesar di Indonesia Timur.", difficulty: 'MUDAH', answer: true, points: SCORE_MAP.true_false }, 
                { id: 'gowa_4', type: 'multiple_choice', question: "Pada tahun berapa Perjanjian Bongaya ditandatangani?", difficulty: 'SEDANG', options: ["1660", "1667", "1678", "1700"], answer: "1667", points: SCORE_MAP.multiple_choice }, 
                { id: 'gowa_5', type: 'multiple_correct', question: "Pilih dua alasan utama Sultan Hasanuddin menolak keras monopoli VOC?", difficulty: 'SEDANG', options: ["Gowa adalah pusat maritim dan perdagangan bebas", "VOC sering merusak kapal dagang milik Gowa", "Gowa takut kehilangan kedaulatan di laut", "Sultan Hasanuddin sakit-sakitan"], correctAnswers: ["Gowa adalah pusat maritim dan perdagangan bebas", "Gowa takut kehilangan kedaulatan di laut"], points: SCORE_MAP.multiple_correct }, 
                { id: 'gowa_6', type: 'matching', question: "Cocokkan tokoh dengan peran utamanya dalam Perang Gowa.", difficulty: 'SEDANG', matches: [{ prompt: "Sultan Hasanuddin", target: "Memimpin Perlawanan Gowa" }, { prompt: "Cornelis Speelman", target: "Pemimpin Armada VOC" }, { prompt: "Arung Palakka", target: "Sekutu VOC dari Bone" }], points: SCORE_MAP.matching },
                { id: 'gowa_7', type: 'matching', question: "Cocokkan lokasi dengan fungsinya pasca Perjanjian Bongaya.", difficulty: 'SULIT', matches: [{ prompt: "Benteng Somba Opu", target: "Benteng Pertahanan Gowa" }, { prompt: "Benteng Rotterdam", target: "Markas Besar VOC" }, { prompt: "Pelabuhan Makassar", target: "Pusat Monopoli Rempah" }], points: SCORE_MAP.matching },
                // Grid TF 2
                { 
                    id: 'gowa_8', 
                    type: 'grid_tf', 
                    question: "Narasi: Kekalahan Gowa dalam Perang Makassar pada tahun 1667 memaksa Sultan Hasanuddin menandatangani Perjanjian Bongaya. Perjanjian ini secara efektif mengakhiri kejayaan Gowa sebagai kekuatan maritim bebas. Isi perjanjian tersebut sangat merugikan Gowa, termasuk hilangnya hak dagang dan kedaulatan atas wilayah yang luas.\n\nTandai Benar atau Salah untuk setiap pernyataan berdasarkan narasi di atas:", 
                    difficulty: 'SULIT', 
                    gridItems: [
                        { text: "Perjanjian Bongaya adalah puncak kemenangan Gowa atas VOC.", answer: false }, 
                        { text: "Gowa harus mengakui hak monopoli VOC setelah perjanjian ditandatangani.", answer: true }, 
                        { text: "Salah satu dampak perjanjian adalah wilayah kekuasaan Gowa menyusut drastis.", answer: true }, 
                        { text: "Benteng Somba Opu diserahkan ke VOC setelah Perjanjian Bongaya.", answer: false } // Benteng Somba Opu dihancurkan, Benteng Rotterdam yang jadi markas VOC
                    ],
                    points: SCORE_MAP.grid_tf
                },
                { id: 'gowa_9', type: 'multiple_correct', question: "Pilih dua dampak utama bagi Gowa setelah Perjanjian Bongaya ditandatangani?", difficulty: 'SULIT', options: ["Gowa harus mengakui hak monopoli VOC", "Benteng pertahanan Gowa harus dihancurkan", "Sultan Hasanuddin diasingkan ke Ambon", "Wilayah kekuasaan Gowa menyusut drastis"], correctAnswers: ["Gowa harus mengakui hak monopoli VOC", "Wilayah kekuasaan Gowa menyusut drastis"], points: SCORE_MAP.multiple_correct }, 
                { id: 'gowa_10', type: 'essay', question: "Analisis: Dampak utama kekalahan Gowa adalah hilangnya kemerdekaan ekonomi. Jelaskan dua cara spesifik yang dilakukan VOC untuk memastikan Kerajaan Gowa tidak lagi menjadi kekuatan maritim setelah Perjanjian Bongaya.", difficulty: 'HOTS', minWords: 30, points: SCORE_MAP.essay } 
            ]
        };

        // State Global Aplikasi
        let appState = {
            screen: 'loading', 
            currentMission: null,
            questions: [], 
            currentQuestionId: null,
            scores: {}, 
            cheatingCount: 0,
            isCheatingListenerActive: false, // Kontrol Kunci Anti-Cheating
        };

        const audioCache = new Map();
        const STORAGE_KEY = 'menitiSejarahAppState';
        
        // --- FUNGSI PERSISTENSI (LocalStorage) ---

        const saveAppState = () => {
            // Pastikan missionActiveStartTimestamp tersimpan
            if (appState.screen === 'inMission' && !missionActiveStartTimestamp) {
                missionActiveStartTimestamp = Date.now();
            } else if (appState.screen !== 'inMission' && appState.screen !== 'penalty') {
                // HANYA reset timestamp jika BUKAN di inMission atau penalty
                missionActiveStartTimestamp = null;
            }
            
            try {
                const stateToSave = {
                    appState: {
                        ...appState,
                        missionActiveStartTimestamp: missionActiveStartTimestamp,
                    },
                    userInfo,
                    totalTimeSeconds,
                    scores: JSON.parse(JSON.stringify(appState.scores)), 
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(stateToSave));
            } catch (e) {
                console.error('Gagal menyimpan state:', e);
            }
        }

        const loadAppState = () => {
            try {
                const savedState = localStorage.getItem(STORAGE_KEY);
                if (!savedState) return false;

                const loadedData = JSON.parse(savedState);

                // Memulihkan data inti
                // isCheatingListenerActive selalu false saat load
                appState = loadedData.appState || appState;
                appState.isCheatingListenerActive = false; 

                userInfo = loadedData.userInfo || userInfo;
                totalTimeSeconds = loadedData.totalTimeSeconds || 0;
                
                // --- PERBAIKAN WAKTU SESI ---
                const savedTimestamp = loadedData.appState.missionActiveStartTimestamp;
                if ((appState.screen === 'inMission' || appState.screen === 'penalty') && savedTimestamp) {
                    // Hitung waktu yang terlelewat saat user refresh/pindah tab (karena timer berhenti)
                    const timeLostSeconds = Math.floor((Date.now() - savedTimestamp) / 1000);
                    // Tambahkan waktu yang hilang ke total waktu
                    totalTimeSeconds += timeLostSeconds;
                    // Atur ulang timestamp aktif agar timer berjalan dari waktu sekarang
                    missionActiveStartTimestamp = Date.now();
                } else {
                    missionActiveStartTimestamp = null;
                }
                // --- END PERBAIKAN WAKTU SESI ---

                // Memulihkan skor & currentAnswer
                if (loadedData.scores) {
                    for (const missionName in loadedData.scores) {
                        if (missionData[missionName]) {
                             Object.keys(loadedData.scores[missionName]).forEach(qId => {
                                 // Hanya memulihkan data yang sudah ada di struktur misi saat ini
                                 if (appState.scores[missionName] && appState.scores[missionName][qId]) {
                                     Object.assign(appState.scores[missionName][qId], loadedData.scores[missionName][qId]);
                                 }
                             });
                        }
                    }
                }
                
                // Pemulihan input profil (untuk tampilan)
                if (userInfo.nama) {
                    document.getElementById('nama-input').value = userInfo.nama;
                    document.getElementById('jurusan-input').value = userInfo.jurusan;
                    document.getElementById('kelas-input').value = userInfo.kelas;
                    checkProfileInputs();
                }

                console.log('State berhasil dimuat dari LocalStorage.');
                return true;
            } catch (e) {
                console.error('Kesalahan memuat state, memulai sesi baru:', e);
                localStorage.removeItem(STORAGE_KEY);
                return false;
            }
        }
        
        
        // --- Helpers API dan Audio ---
        
        const base64ToArrayBuffer = (base64) => {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        const pcmToWav = (pcm16, sampleRate = 24000) => {
            const buffer = new ArrayBuffer(44 + pcm16.length * 2);
            const view = new DataView(buffer);

            // RIFF chunk descriptor
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcm16.length * 2, true);
            writeString(view, 8, 'WAVE');

            // FMT sub-chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); 
            view.setUint16(22, 1, true); 
            view.setUint32(24, sampleRate, true); 
            view.setUint32(28, sampleRate * 2, true); 
            view.setUint16(32, 2, true); 
            view.setUint16(34, 16, true); 

            // data sub-chunk
            writeString(view, 36, 'data');
            view.setUint32(40, pcm16.length * 2, true);

            // Write the PCM data
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++, offset += 2) {
                view.setInt16(offset, pcm16[i], true);
            }

            return new Blob([buffer], { type: 'audio/wav' });
        }

        const writeString = (view, offset, string) => {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }
        
        const generateAudioBlob = async (text) => {
            // Check if API Key is configured. If not, it relies on canvas injection
            const apiKey = TTS_API_KEY;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: text }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            let lastDelay = 1000;
            const maxRetries = 3;

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const part = result?.candidates?.[0]?.content?.parts?.[0];
                        const audioData = part?.inlineData?.data;
                        const mimeType = part?.inlineData?.mimeType;

                        if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                            const sampleRate = 24000;
                            const pcmData = base64ToArrayBuffer(audioData);
                            const pcm16 = new Int16Array(pcmData);
                            return pcmToWav(pcm16, sampleRate);
                        } else {
                            throw new Error("Respons API tidak mengandung data audio yang valid.");
                        }
                    } else {
                        if (response.status === 429 || response.status >= 500) {
                            throw new Error(`Server error (${response.status}), retrying...`);
                        } else {
                            const errorResult = await response.json();
                            throw new Error(`API call failed: ${JSON.stringify(errorResult)}`);
                        }
                    }
                } catch (error) {
                    if (attempt < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, lastDelay));
                        lastDelay *= 2;
                    } else {
                        throw error;
                    }
                }
            }
            throw new Error("Gagal mendapatkan audio dari API setelah beberapa kali percobaan.");
        }
        
        const formatTime = (seconds) => {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            const pad = (num) => String(num).padStart(2, '0');
            return `${pad(minutes)}:${pad(remainingSeconds)}`;
        }
        
        // FIX BUG WAKTU SESI: Memperbarui logika startMissionTimer untuk memperhitungkan waktu yang sudah berjalan
        const startMissionTimer = () => {
            stopMissionTimer(); 
            
            // Jika missionActiveStartTimestamp belum disetel, setel sekarang
            if (!missionActiveStartTimestamp) {
                missionActiveStartTimestamp = Date.now();
            }

            const timeDisplay = document.getElementById('mission-time-display');
            
            // Tampilkan waktu yang benar segera setelah timer dimulai
            const initialElapsedSinceStart = Math.floor((Date.now() - missionActiveStartTimestamp) / 1000);
            timeDisplay.textContent = formatTime(totalTimeSeconds + initialElapsedSinceStart);

            timerInterval = setInterval(() => {
                // Total waktu yang ditampilkan = Waktu yang sudah diakumulasi + Waktu yang berlalu sejak sesi aktif dimulai
                const elapsedSinceStart = Math.floor((Date.now() - missionActiveStartTimestamp) / 1000);
                const currentTotalTime = totalTimeSeconds + elapsedSinceStart;
                timeDisplay.textContent = formatTime(currentTotalTime);
            }, 1000);
        }

        const stopMissionTimer = () => {
            if (timerInterval) {
                // Sebelum menghentikan, hitung dan akumulasikan waktu yang telah berlalu
                if (missionActiveStartTimestamp) {
                    const elapsedSinceStart = Math.floor((Date.now() - missionActiveStartTimestamp) / 1000);
                    totalTimeSeconds += elapsedSinceStart;
                    missionActiveStartTimestamp = null; // Reset start time
                }
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
        
        const stopCurrentAudio = () => {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio = null;
            }
        }

        let modalCloseCallback = null;

        const hideModal = () => {
            document.getElementById('modal').classList.add('hidden');
            document.getElementById('modal').classList.remove('flex');
            if (modalCloseCallback) {
                modalCloseCallback();
                modalCloseCallback = null;
            }
        }

        const showModal = (title, body, onClose = null) => {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').textContent = body;
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modal').classList.add('flex');
            modalCloseCallback = onClose;
        }

        // FUNGSI BARU: Mengambil status input saat ini untuk disimpan (Fitur 4)
        const trackInputChanges = () => {
            if (!appState.currentMission || !appState.currentQuestionId) return;

            const q = missionData[appState.currentMission].find(item => item.id === appState.currentQuestionId);
            const qState = appState.scores[appState.currentMission][q.id];
            
            if (qState.completed) return; // Tidak perlu melacak yang sudah selesai

            const inputArea = document.getElementById('question-input-area');
            let currentAnswer = null;

            if (q.type === 'narrative_mc' || q.type === 'multiple_choice' || q.type === 'true_false') {
                const selectedButton = inputArea.querySelector('.option-button.bg-red-600');
                if (selectedButton) {
                    currentAnswer = selectedButton.getAttribute('data-value');
                }
            } else if (q.type === 'multiple_correct') {
                currentAnswer = Array.from(inputArea.querySelectorAll('input[name="multicorrect"]:checked')).map(cb => cb.value);
            } else if (q.type === 'matching') {
                currentAnswer = Array.from(inputArea.querySelectorAll('select')).map(select => select.value);
            } else if (q.type === 'essay') {
                const textarea = document.getElementById('essay-answer');
                currentAnswer = textarea ? textarea.value : '';
            } else if (q.type === 'grid_tf') { // NEW: Logic untuk soal grid
                const selections = {};
                inputArea.querySelectorAll('.grid-row').forEach(row => {
                    const itemId = row.getAttribute('data-id');
                    const selectedBtn = row.querySelector('.grid-option-btn.bg-red-600');
                    selections[itemId] = selectedBtn ? selectedBtn.getAttribute('data-value') : null;
                });
                currentAnswer = selections;
            }


            qState.currentAnswer = currentAnswer;
            saveAppState();
        }


        const initGameData = () => {
            for (const missionName in missionData) {
                appState.scores[missionName] = {}; 
                missionData[missionName].forEach(q => {
                    q.missionName = missionName;
                    appState.questions.push(q);
                    
                    appState.scores[missionName][q.id] = { 
                        score: 0, 
                        completed: false, 
                        skipped: false, 
                        isConsulted: false,
                        shuffledOptions: [], 
                        shuffledMatches: [],
                        currentAnswer: q.type === 'grid_tf' ? {} : null, // Initialize currentAnswer for grid type
                    };
                    
                    const qState = appState.scores[missionName][q.id];

                    if (q.type === 'narrative_mc' || q.type === 'multiple_choice' || q.type === 'true_false') {
                        let options = q.type === 'true_false' ? ["Benar", "Salah"] : [...q.options];
                        if (options.length > 0 && q.type !== 'true_false') {
                            qState.shuffledOptions = shuffleArray(options);
                        } else {
                            qState.shuffledOptions = options;
                        }
                    }

                    if (q.type === 'matching') {
                        const targets = q.matches.map(m => m.target);
                        qState.shuffledMatches = shuffleArray(targets);
                    }
                    // No shuffling needed for grid_tf items
                });
            }
        }

        const shuffleArray = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        const originalButtonContent = '<svg class="w-5 h-5 mr-2 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.26a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Dengarkan Audio Soal';

        const playQuestionAudio = async (questionId) => {
            stopCurrentAudio();
            const playBtn = document.getElementById('play-audio-btn');
            playBtn.disabled = true;
            playBtn.innerHTML = '<div class="w-5 h-5 border-2 border-white border-t-red-500 rounded-full animate-spin mr-2"></div> Memuat Audio...';
            
            const q = missionData[appState.currentMission].find(item => item.id === questionId);
            
            if (!q) {
                 playBtn.disabled = false;
                 playBtn.innerHTML = originalButtonContent;
                 console.error("ERROR: Objek soal tidak ditemukan untuk ID:", questionId);
                 showModal('Kesalahan Internal', 'Soal tidak ditemukan. Coba kembali ke Menu Misi.');
                 return;
            }
            
            const fullText = q.question;
            let audioBlob;
            
            if (audioCache.has(questionId)) {
                audioBlob = audioCache.get(questionId);
            } else {
                try {
                    audioBlob = await generateAudioBlob(fullText);
                    audioCache.set(questionId, audioBlob);
                } catch (error) {
                    console.error("Gagal mendapatkan audio dari API:", error);
                    playBtn.disabled = false;
                    playBtn.innerHTML = originalButtonContent;
                    let errorMessage = `Terjadi kesalahan saat membuat audio. Ini mungkin karena pembatasan keamanan browser atau masalah koneksi.`;
                    showModal('Gagal Memuat Audio', errorMessage);
                    return;
                }
            }

            if (audioBlob) {
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                currentAudio = audio; 

                audio.onended = () => {
                    playBtn.disabled = false;
                    playBtn.innerHTML = originalButtonContent;
                    currentAudio = null; 
                    URL.revokeObjectURL(audioUrl);
                }
                audio.onerror = (e) => {
                    console.error("Gagal memutar audio:", e);
                    playBtn.disabled = false;
                    playBtn.innerHTML = originalButtonContent;
                    currentAudio = null; 
                    URL.revokeObjectURL(audioUrl);
                    showModal('Kesalahan Pemutaran', `Browser memblokir pemutaran media. Coba buka aplikasi di tab browser utama.`);
                };

                playBtn.innerHTML = '<svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M10 16.5l6-4.5-6-4.5v9zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg> Sedang Memutar...';
                audio.play().catch(e => {
                    console.warn("Kesalahan Playback/Autoplay diblokir:", e);
                    playBtn.disabled = false;
                    playBtn.innerHTML = originalButtonContent;
                    currentAudio = null;
                    URL.revokeObjectURL(audioUrl);
                    showModal('Pemutaran Ditolak oleh Browser', 'Browser menolak pemutaran media secara otomatis. Mohon coba buka aplikasi di tab browser utama.');
                });
            }
        }

        // --- Perender dan Navigator Layar ---

        const updateAppScreen = () => {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('intro-screen').classList.add('hidden'); 
            document.getElementById('mission-select-screen').classList.add('hidden');
            document.getElementById('in-mission-screen').classList.add('hidden');
            document.getElementById('final-screen').classList.add('hidden');
            document.getElementById('penalty-screen').classList.add('hidden');

            
            if (appState.screen === 'loading') {
                document.getElementById('loading-screen').classList.remove('hidden');
            } else if (appState.screen === 'intro') { 
                document.getElementById('intro-screen').classList.remove('hidden');
            } else if (appState.screen === 'missionSelect') {
                document.getElementById('mission-select-screen').classList.remove('hidden');
                renderMissionSelect();
            } else if (appState.screen === 'inMission') {
                document.getElementById('in-mission-screen').classList.remove('hidden');
                renderMissionState();
            } else if (appState.screen === 'finished') {
                document.getElementById('final-screen').classList.remove('hidden');
                renderFinalScreen();
            } else if (appState.screen === 'penalty') {
                document.getElementById('penalty-screen').classList.remove('hidden');
            }
            
            saveAppState();
        }
        
        const calculateGameScore = () => {
             let totalScore = 0;
             const missionNames = Object.keys(missionData);
             missionNames.forEach(name => {
                 totalScore += calculateMissionScore(name);
             });
             return totalScore;
        }

        const isGameCompleted = () => {
            const missionNames = Object.keys(missionData);
            // Jumlah soal per misi disesuaikan menjadi 10
            return missionNames.every(name => Object.values(appState.scores[name]).filter(q => q.completed).length === 10); 
        }

        const renderMissionSelect = () => {
            stopMissionTimer(); 
            // Anti-kecurangan tidak berlaku di sini
            appState.isCheatingListenerActive = false; 

            const missionList = document.getElementById('mission-list');
            missionList.innerHTML = '';
            
            const missionNames = Object.keys(missionData);
            const completedCount = missionNames.filter(isMissionCompleted).length;
            
            document.getElementById('game-progress-display').textContent = `${completedCount}/${missionNames.length} Misi Selesai`;
            
            if (isGameCompleted()) {
                const finalTime = formatTime(totalTimeSeconds);
                document.getElementById('total-time-display').textContent = finalTime;
                
                appState.screen = 'finished';
                return updateAppScreen();
            }

            missionNames.forEach(name => {
                const totalScore = calculateMissionScore(name);
                const isCompleted = isMissionCompleted(name);
                
                const button = document.createElement('button');
                button.className = `mission-button w-full text-left p-5 rounded-xl transition duration-300 border border-red-700/50 flex justify-between items-center ${
                    isCompleted ? 'bg-green-700/30 text-green-300' : 'bg-gray-700 hover:bg-red-600 text-white'
                }`;
                button.innerHTML = `
                    <span class="font-extrabold text-xl">${name}</span>
                    <span class="text-sm font-semibold p-1 px-3 rounded-full ${isCompleted ? 'bg-green-500' : 'bg-gray-600'}">
                        ${isCompleted ? 'SELESAI' : 'SKOR: ' + totalScore + ' / ' + MAX_MISSION_SCORE}
                    </span>
                `;
                button.onclick = () => selectMission(name);
                missionList.appendChild(button);
            });
        }
        
        const selectMission = (name) => {
            triggerHaptics();
            stopCurrentAudio();
            appState.currentMission = name;
            
            // AKTIFKAN LISTENER KECURANGAN SAAT MASUK MISI
            appState.isCheatingListenerActive = true; 
            startMissionTimer();
            
            const firstUncompletedQuestion = missionData[name].find(q => !appState.scores[name][q.id].completed);
            
            if (firstUncompletedQuestion) {
                goToQuestion(firstUncompletedQuestion.id);
            } else {
                goToQuestion(missionData[name][0].id);
            }
            appState.screen = 'inMission';
            updateAppScreen();
        }
        
        const calculateMissionScore = (missionName) => {
            if (!appState.scores[missionName]) return 0;
            return Object.values(appState.scores[missionName]).reduce((sum, qScore) => sum + qScore.score, 0);
        }

        const isMissionCompleted = (missionName) => {
            if (!appState.scores[missionName]) return false;
            // Jumlah soal per misi disesuaikan menjadi 10
            return Object.values(appState.scores[missionName]).filter(q => q.completed).length === 10;
        }

        // --- NAVIGATION & HINT HELPERS ---

        const renderQuestionNavigation = (missionQ) => {
            const navContainer = document.getElementById('question-navigation');
            navContainer.innerHTML = '';
            
            // Menampilkan hanya 10 tombol navigasi (sesuai jumlah soal baru)
            missionQ.slice(0, 10).forEach((q, index) => {
                const qState = appState.scores[appState.currentMission][q.id];
                const btn = document.createElement('button');
                
                let bgColor = 'bg-gray-600 text-gray-300'; 
                if (q.id === appState.currentQuestionId) {
                    bgColor = 'bg-red-500 text-white shadow-lg'; 
                } else if (qState.completed) {
                    bgColor = 'bg-green-500 text-white'; 
                } else if (qState.skipped && !qState.completed) {
                    bgColor = 'bg-yellow-500 text-gray-900'; 
                }

                btn.className = `w-10 h-10 rounded-full font-bold transition duration-150 transform hover:scale-110 ${bgColor}`;
                btn.textContent = index + 1;
                btn.onclick = () => goToQuestion(q.id);
                // Semua tombol dapat diklik agar user bisa melihat kembali jawaban yang sudah disimpan (completed atau currentAnswer)
                navContainer.appendChild(btn);
            });
        }

        const getExpertHint = (q) => {
            switch (q.id) {
                // Aceh
                case 'aceh_1': return `Fokus narasi: Coba ingat tujuan Sultan Ali Mughayat Syah, yaitu mengamankan jalur dagang setelah Malaka jatuh ke Portugis.`;
                case 'aceh_2': return `Fokus: Ingatlah lokasi strategis Aceh dan alasan utama Sultan Iskandar Muda.`; // grid 1
                case 'aceh_3': return `Benar/Salah: Aceh menjalin hubungan dengan Turki Utsmani untuk bantuan militer melawan Portugis.`;
                case 'aceh_4': return `Faktor utama adalah perebutan Selat Malaka.`;
                case 'aceh_5': return `Pasukan maritim Aceh yang terkenal di masa Sultan Iskandar Muda bernama Cakra Donya.`;
                case 'aceh_6': return `Pilih dua: 'Adat Meukuta Alam' dan penguatan agama Islam.`;
                case 'aceh_7': return `Pattimura (Pemimpin di Saparua), Residen Van den Berg (Kepala Benteng Duurstede), Said Perintah (Tokoh Muslim).`; // matching
                case 'aceh_8': return `Fokus: Ingatlah VOC tidak berani menyerang Aceh secara langsung, fokus melemahkan dari jalur dagang.`; // grid 2
                case 'aceh_9': return `Sekutu Aceh melawan Portugis adalah Kerajaan Johor dan Kesultanan Ternate.`;
                case 'aceh_10': return `Analisis: Jelaskan mengapa kegagalan serangan 1629 tetap signifikan (demonstrasi kekuatan).`; // essay

                // Maluku
                case 'maluku_1': return `Fokus narasi: Kebijakan ekonomi monopoli cengkeh dan pala yang sangat merugikan rakyat.`;
                case 'maluku_2': return `Fokus: Perhatikan persatuan agama dan nasib Benteng Duurstede.`; // grid 1
                case 'maluku_3': return `Benar/Salah: Perlawanan terjadi setelah Inggris menyerahkan Maluku ke Belanda (1817).`;
                case 'maluku_4': return `Tokoh perempuan adalah Martha Christina Tiahahu.`;
                case 'maluku_5': return `Di benteng manakah Pattimura dihukum gantung? Benteng Victoria.`;
                case 'maluku_6': return `Pilih dua: Sistem penyerahan wajib rempah-rempah yang merusak ekonomi dan pengangkatan raja-raja lokal yang sepihak oleh Belanda.`;
                case 'maluku_7': return `Pattimura (Pemimpin di Saparua), Residen Van den Berg (Kepala Benteng Duurstede), Said Perintah (Tokoh Muslim).`; // matching
                case 'maluku_8': return `Fokus: Pattimura dieksekusi di Benteng Victoria, Ambon, dan hal itu justru menyulut perlawanan.`; // grid 2
                case 'maluku_9': return `Pemimpin perlawanan selain Pattimura: Said Perintah dan Anthony Ribok.`;
                case 'maluku_10': return `Analisis: Mengapa Pattimura dihukum mati, dan mengapa hukuman mati tersebut justru meningkatkan semangat perlawanan?`; // essay

                // Banten
                case 'banten_1': return `Fokus narasi: Sultan Ageng ingin Banten menjadi pelabuhan internasional yang bebas (perdagangan bebas) untuk menyaingi Batavia.`;
                case 'banten_2': return `Fokus: Konflik terjadi antara Sultan Ageng dan putranya, Sultan Haji.`; // grid 1
                case 'banten_3': return `Benar/Salah: Konflik terjadi bukan karena keyakinan, tetapi karena pandangan ekonomi: perdagangan bebas vs. monopoli.`;
                case 'banten_4': return `Kebijakan utama Sultan Ageng: Menciptakan armada laut modern.`;
                case 'banten_5': return `Strategi VOC yang paling merusak internal Kesultanan Banten: Devide et Impera.`;
                case 'banten_6': return `Pilih dua: Mengembangkan bandar perdagangan tandingan dan mengirim pasukan gerilya untuk mengganggu Batavia.`;
                case 'banten_7': return `Sultan Ageng Tirtayasa (Perdagangan Bebas), Sultan Haji (Putra Sultan Ageng), VOC (Pemicu Konflik Internal).`; // matching
                case 'banten_8': return `Fokus: Kekalahan disebabkan penangkapan melalui tipu muslihat. Banten tidak berakhir sepenuhnya dengan eksekusi.`; // grid 2
                case 'banten_9': return `Pilih dua kondisi: Pengakuan sebagai Sultan Banten yang sah dan Bantuan militer untuk menguasai istana Surosowan.`;
                case 'banten_10': return `Analisis: Mengapa VOC berhasil menerapkan Devide et Impera di Banten (konflik suksesi) dibandingkan tempat lain?`; // essay

                // Gowa
                case 'gowa_1': return `Fokus narasi: Julukan Ayam Jantan dari Timur diberikan Belanda karena kegigihan Sultan Hasanuddin.`;
                case 'gowa_2': return `Fokus: Perhatikan fokus wilayah Gowa (Makassar) dan peran Arung Palakka.`; // grid 1
                case 'gowa_3': return `Benar atau salah: Gowa adalah pusat perdagangan maritim terbesar di Indonesia Timur.`;
                case 'gowa_4': return `Perjanjian Bongaya ditandatangani pada tahun 1667.`;
                case 'gowa_5': return `Pilih dua: Gowa adalah pusat maritim perdagangan bebas dan Gowa takut kehilangan kedaulatan di laut.`;
                case 'gowa_6': return `Sultan Hasanuddin (Perlawanan Gowa), Cornelis Speelman (Pemimpin Armada VOC), Arung Palakka (Sekutu VOC).`; // matching
                case 'gowa_7': return `Benteng Somba Opu (Pertahanan Gowa), Benteng Rotterdam (Markas VOC), Pelabuhan Makassar (Pusat Monopoli).`; // matching
                case 'gowa_8': return `Fokus: Perjanjian Bongaya mengakhiri kemerdekaan Gowa. Lihat isi perjanjian yang merugikan.`; // grid 2
                case 'gowa_9': return `Pilih dua dampak: Gowa harus mengakui hak monopoli VOC dan Wilayah kekuasaan Gowa menyusut drastis.`;
                case 'gowa_10': return `Analisis: Jelaskan dua cara spesifik VOC memastikan Kerajaan Gowa tidak lagi menjadi kekuatan maritim setelah Perjanjian Bongaya.`; // essay

                default: return `Maaf, petunjuk ahli tidak dapat ditemukan. Coba fokus pada hubungan sebab-akibat tokoh dan peristiwa.`;
            }
        }
        // --- END NAVIGATION & HINT HELPERS ---


        const renderMissionState = () => {
            if (!appState.currentMission || !appState.currentQuestionId) {
                return navigateToMissionSelect();
            }
            
            const missionQ = missionData[appState.currentMission];
            const currentQ = missionQ.find(q => q.id === appState.currentQuestionId);
            const currentQState = appState.scores[appState.currentMission][appState.currentQuestionId];
            
            const isAudioQuestion = currentQ.type === 'narrative_mc';
            const isCompleted = currentQState.completed;
            const currentMissionScore = calculateMissionScore(appState.currentMission);

            document.getElementById('user-name-display').textContent = `${userInfo.nama} (${userInfo.kelas} ${userInfo.jurusan})`;
            document.getElementById('mission-current-score').textContent = currentMissionScore;
            document.getElementById('mission-title').textContent = appState.currentMission;
            
            document.getElementById('question-type-display').textContent = `Tipe Soal: ${currentQ.type.toUpperCase().replace('_', ' ')}`;
            
            const difficultyDisplay = document.getElementById('question-difficulty');
            difficultyDisplay.textContent = `Kesulitan: ${currentQ.difficulty}`;
            
            if (currentQ.difficulty === 'MUDAH') difficultyDisplay.className = 'font-bold text-green-400';
            else if (currentQ.difficulty === 'SEDANG') difficultyDisplay.className = 'font-bold text-yellow-400';
            else if (currentQ.difficulty === 'SULIT') difficultyDisplay.className = 'font-bold text-orange-400';
            else if (currentQ.difficulty === 'HOTS') difficultyDisplay.className = 'font-bold text-red-500';


            const questionTextElement = document.getElementById('question-text');
            // Cek jika tipe soalnya GRID TF, tampilkan narasi panjang sebagai teks soal
            if (currentQ.type === 'grid_tf' && currentQ.question.includes('Narasi:')) {
                const parts = currentQ.question.split('\n\n');
                questionTextElement.textContent = parts[0]; // Tampilkan hanya narasi
                questionTextElement.classList.remove('italic', 'text-red-400');
                questionTextElement.classList.add('text-xl', 'text-gray-200'); // Teks soal dinormalisasi
            } else if (isAudioQuestion) {
                 questionTextElement.textContent = "Dengarkan narasi soal dari tombol audio di atas, lalu pilih jawaban di bawah.";
                 questionTextElement.classList.add('italic', 'text-red-400', 'text-xl');
                 questionTextElement.classList.remove('text-2xl', 'text-white');
            } else {
                 questionTextElement.textContent = currentQ.question;
                 questionTextElement.classList.remove('italic', 'text-red-400', 'text-xl');
                 questionTextElement.classList.add('text-2xl', 'text-white');
            }
            
            document.getElementById('feedback-message').textContent = '';

            renderQuestionNavigation(missionQ); 
            renderQuestionInput(currentQ, currentQState); 

            // Cek apakah semua 10 soal sudah selesai
            document.getElementById('finish-mission-btn').classList.toggle('hidden', !isMissionCompleted(appState.currentMission));

            const playBtn = document.getElementById('play-audio-btn');
            playBtn.classList.add('bg-red-600', 'hover:bg-red-700', 'disabled:bg-red-400');
            // Hanya tampilkan tombol audio jika tipe soalnya narrative_mc
            playBtn.classList.toggle('hidden', !isAudioQuestion || isCompleted);
            
            playBtn.innerHTML = originalButtonContent;

            document.getElementById('submit-answer-btn').classList.toggle('hidden', isCompleted);
            document.getElementById('skip-btn').classList.toggle('hidden', isCompleted);
            document.getElementById('consult-expert-btn').classList.add('hidden'); 

            document.getElementById('submit-answer-btn').disabled = isCompleted;
            document.getElementById('skip-btn').disabled = isCompleted; 

            if (isCompleted) {
                document.getElementById('feedback-message').textContent = `Soal Selesai. Skor: ${currentQState.score}`;
                document.getElementById('feedback-message').classList.remove('text-red-400', 'text-yellow-500', 'text-orange-400');
                document.getElementById('feedback-message').classList.add('text-green-400');
            } else if (!isCompleted && currentQState.isConsulted) {
                document.getElementById('submit-answer-btn').classList.remove('hidden');
                document.getElementById('skip-btn').classList.remove('hidden');
                document.getElementById('submit-answer-btn').disabled = false;
                document.getElementById('skip-btn').disabled = false;
                document.getElementById('feedback-message').textContent = `Anda menggunakan Bantuan Ahli (Max ${CONSULT_HINT_SCORE} Poin). Pilih Jawaban Anda.`;
                document.getElementById('feedback-message').classList.add('text-orange-400');
            } else if (!isCompleted && !currentQState.isConsulted && currentQState.currentAnswer !== null) {
                // Saat kembali dari soal yang sudah dijawab (salah), tampilkan tombol jawab lagi
                document.getElementById('submit-answer-btn').classList.remove('hidden');
                document.getElementById('skip-btn').classList.remove('hidden');
                document.getElementById('submit-answer-btn').disabled = false;
                document.getElementById('skip-btn').disabled = false;
            }
        }
        
        const renderQuestionInput = (q, qState) => {
            const inputArea = document.getElementById('question-input-area');
            inputArea.innerHTML = '';
            inputArea.dataset.type = q.type;

            if (q.type === 'narrative_mc' || q.type === 'multiple_choice' || q.type === 'true_false') {
                const options = qState.shuffledOptions;
                options.forEach((option) => {
                    const btn = document.createElement('button');
                    btn.textContent = option;
                    
                    let btnClass = 'bg-gray-800 hover:bg-gray-600 text-white';
                    
                    if (qState.completed) {
                        // Logika untuk menampilkan Jawaban Benar setelah submit
                        const isAnswer = (q.type === 'true_false') 
                            ? (option === 'Benar' ? q.answer : !q.answer) 
                            : (option === q.answer);
                        
                        if (isAnswer) {
                            btnClass = 'bg-green-700 text-white border-green-500';
                        } else if (option === qState.currentAnswer) { // Jawaban user yang salah
                            btnClass = 'bg-red-900 text-red-300 border-red-500';
                        } else {
                            btnClass = 'bg-gray-800 text-gray-400';
                        }
                    } else if (qState.currentAnswer === option) { // Fitur 4: Muat jawaban sementara
                        btnClass = 'bg-red-600 border-red-500';
                    }

                    btn.className = `option-button w-full text-left p-3 rounded-lg border border-gray-600 ${btnClass} shadow-md`;
                    btn.setAttribute('data-value', option);
                    btn.onclick = () => { selectOption(btn); trackInputChanges(); }; // Tambah trackInput
                    btn.disabled = qState.completed;
                    inputArea.appendChild(btn);
                });
                
            } else if (q.type === 'multiple_correct') {
                const currentAnswerArray = qState.currentAnswer || []; // Fitur 4: Muat jawaban sementara
                q.options.forEach((option) => {
                    const isCorrect = q.correctAnswers.includes(option);
                    let labelClass = 'bg-gray-800 hover:bg-gray-600';
                    
                    if (qState.completed && isCorrect) {
                        labelClass = 'bg-green-700/50 hover:bg-green-700/50';
                    } else if (qState.completed && currentAnswerArray.includes(option) && !isCorrect) {
                         labelClass = 'bg-red-900/50 hover:bg-red-900/50'; // Jawaban salah yang dipilih
                    } else if (qState.completed) {
                        labelClass = 'bg-gray-700';
                    }

                    const label = document.createElement('label');
                    label.className = `flex items-center p-3 rounded-lg border border-gray-600 shadow-md transition duration-150 ${labelClass}`;
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.name = 'multicorrect';
                    checkbox.value = option;
                    checkbox.checked = currentAnswerArray.includes(option); // Fitur 4: Muat status checked
                    checkbox.className = 'w-5 h-5 text-red-500 border-gray-600 rounded focus:ring-red-500 bg-gray-700';
                    checkbox.disabled = qState.completed;
                    
                    checkbox.onchange = trackInputChanges; // Tambah trackInput

                    const span = document.createElement('span');
                    span.textContent = option;
                    span.className = 'ml-3 text-gray-200';
                    if (qState.completed && isCorrect) {
                        span.textContent += ' (BENAR)';
                    } else if (qState.completed && currentAnswerArray.includes(option) && !isCorrect) {
                        span.textContent += ' (SALAH)';
                    }

                    label.appendChild(checkbox);
                    label.appendChild(span);
                    inputArea.appendChild(label);
                });
                
            } else if (q.type === 'matching') {
                const shuffledTargets = qState.shuffledMatches || q.matches.map(m => m.target); 
                const currentAnswerArray = qState.currentAnswer || []; // Fitur 4: Muat jawaban sementara
                
                q.matches.forEach((match, index) => {
                    const matchDiv = document.createElement('div');
                    matchDiv.className = 'flex flex-col md:flex-row items-center justify-between p-3 border-b border-gray-600';
                    
                    const promptText = document.createElement('span');
                    promptText.textContent = match.prompt;
                    promptText.className = 'font-medium text-gray-300 w-full md:w-1/2 mb-2 md:mb-0';
                    
                    const select = document.createElement('select');
                    select.name = `matching-${index}`;
                    select.className = 'w-full md:w-1/2 p-2 border border-gray-600 rounded-lg bg-gray-700 text-white focus:ring-red-500 focus:border-red-500';
                    select.disabled = qState.completed;
                    select.onchange = trackInputChanges; // Tambah trackInput

                    const defaultOption = document.createElement('option');
                    defaultOption.textContent = '-- Pilih Pasangan --';
                    defaultOption.value = '';
                    select.appendChild(defaultOption);

                    shuffledTargets.forEach(target => {
                        const option = document.createElement('option');
                        option.textContent = target;
                        option.value = target;
                        
                        let isUsersAnswer = false;
                        if (!qState.completed && currentAnswerArray[index] === target) {
                            isUsersAnswer = true;
                        }
                        
                        if (qState.completed && target === match.target) {
                             option.selected = true;
                             option.classList.add('bg-green-700', 'text-white');
                        } else if (isUsersAnswer) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                    
                    matchDiv.appendChild(promptText);
                    matchDiv.appendChild(select);
                    inputArea.appendChild(matchDiv);
                });
                
            } else if (q.type === 'essay') {
                const textarea = document.createElement('textarea');
                textarea.id = 'essay-answer';
                textarea.rows = 6;
                textarea.placeholder = `Tuliskan jawaban Anda di sini. Jawaban minimal ${q.minWords} kata. Soal HOTS ini memerlukan analisis mendalam.`;
                textarea.className = 'w-full p-3 border border-gray-600 rounded-lg focus:ring-red-500 focus:border-red-500 bg-gray-700 text-white';
                textarea.disabled = qState.completed;
                textarea.value = qState.currentAnswer || ''; // Fitur 4: Muat teks sementara
                textarea.addEventListener('input', trackInputChanges); // Tambah trackInput
                inputArea.appendChild(textarea);
                
                const wordCount = document.createElement('p');
                wordCount.id = 'word-count';
                wordCount.className = 'text-sm text-gray-400 mt-2';

                // Hitung kata awal saat dimuat
                const initialWordCount = textarea.value.trim() ? textarea.value.trim().split(/\s+/).filter(word => word.length > 0).length : 0;
                wordCount.textContent = `${initialWordCount} / ${q.minWords} Kata`;
                wordCount.classList.toggle('text-red-400', initialWordCount < q.minWords);
                wordCount.classList.toggle('text-green-400', initialWordCount >= q.minWords);


                textarea.addEventListener('input', () => {
                    const text = textarea.value.trim();
                    const words = text ? text.split(/\s+/).filter(word => word.length > 0) : [];
                    wordCount.textContent = `${words.length} / ${q.minWords} Kata`;
                    wordCount.classList.toggle('text-red-400', words.length < q.minWords);
                    wordCount.classList.toggle('text-green-400', words.length >= q.minWords);
                });
                
                inputArea.appendChild(wordCount); // Memastikan wordCount ditambahkan

                if (qState.completed) {
                    const scoreDisplay = document.createElement('div');
                    scoreDisplay.className = 'mt-4 p-3 bg-red-800 rounded-lg text-sm';
                    scoreDisplay.textContent = `Jawaban Esai Dicatat. Skor: ${qState.score} Poin.`;
                    inputArea.appendChild(scoreDisplay);
                }
            } else if (q.type === 'grid_tf') { // NEW: Logic untuk soal grid
                // Ambil instruksi pertanyaan utama
                const instruction = q.question.split('\n\n').pop();
                
                // Tambahkan instruksi di luar tabel
                const instructionEl = document.createElement('p');
                instructionEl.className = 'text-base font-semibold text-gray-300 mb-3';
                instructionEl.textContent = instruction;
                inputArea.appendChild(instructionEl);

                const table = document.createElement('div');
                table.className = 'w-full border border-gray-600 rounded-lg overflow-hidden';
                
                // Header
                const header = document.createElement('div');
                header.className = 'grid grid-cols-3 bg-red-900/70 font-extrabold text-sm border-b border-red-700';
                header.innerHTML = `
                    <div class="p-3 text-red-300">Pernyataan</div>
                    <div class="p-3 text-center text-green-300 border-l border-red-700">Benar</div>
                    <div class="p-3 text-center text-red-300 border-l border-red-700">Salah</div>
                `;
                table.appendChild(header);

                const currentSelections = qState.currentAnswer || {};

                q.gridItems.forEach((item, index) => {
                    const row = document.createElement('div');
                    row.className = 'grid grid-cols-3 items-center border-b border-gray-700 last:border-b-0 grid-row';
                    row.setAttribute('data-id', index);

                    const textDiv = document.createElement('div');
                    textDiv.className = 'p-3 text-sm text-gray-200';
                    textDiv.textContent = item.text;
                    row.appendChild(textDiv);

                    // Buat wadah untuk tombol Benar/Salah
                    ['true', 'false'].forEach((value, colIndex) => {
                        const btnContainer = document.createElement('div');
                        btnContainer.className = `p-2 flex justify-center border-l border-gray-700`;

                        const btn = document.createElement('button');
                        btn.className = `grid-option-btn w-16`;
                        btn.setAttribute('data-value', value);
                        btn.textContent = value === 'true' ? 'B' : 'S'; // Menggunakan B/S untuk hemat ruang

                        const isSelected = currentSelections[index] === value;
                        const isCorrect = item.answer === (value === 'true');

                        if (qState.completed) {
                            btn.disabled = true;
                            if (isCorrect) {
                                // Jawaban yang benar (terlepas dari pilihan user)
                                btn.classList.add('bg-green-700', 'text-white', 'opacity-100');
                            } else if (isSelected && !isCorrect) {
                                // Pilihan user yang salah
                                btn.classList.add('bg-red-800', 'text-red-300', 'opacity-100');
                            } else {
                                // Pilihan yang tidak dipilih dan salah
                                btn.classList.add('bg-gray-800', 'text-gray-500');
                            }
                        } else {
                            btn.disabled = false;
                            if (isSelected) {
                                btn.classList.add('bg-red-600', 'text-white');
                            } else {
                                btn.classList.add('bg-gray-800', 'hover:bg-gray-600', 'text-white');
                            }
                            
                            btn.onclick = () => selectGridOption(row, value);
                        }

                        btnContainer.appendChild(btn);
                        row.appendChild(btnContainer);
                    });

                    table.appendChild(row);
                });

                inputArea.appendChild(table);
            }
        }
        
        // NEW: Handler untuk memilih opsi di Grid TF
        const selectGridOption = (rowElement, value) => {
            triggerHaptics(20);
            rowElement.querySelectorAll('.grid-option-btn').forEach(btn => {
                btn.classList.remove('bg-red-600', 'text-white');
                btn.classList.add('bg-gray-800', 'text-white');
            });

            const selectedBtn = rowElement.querySelector(`[data-value="${value}"]`);
            selectedBtn.classList.remove('bg-gray-800');
            selectedBtn.classList.add('bg-red-600', 'text-white');
            
            trackInputChanges();
        }

        const selectOption = (button) => {
            triggerHaptics(20);
            const inputArea = document.getElementById('question-input-area');
            inputArea.querySelectorAll('.option-button').forEach(btn => {
                btn.classList.remove('bg-red-600', 'border-red-500'); 
            });
            button.classList.add('bg-red-600', 'border-red-500'); 
            // saveAppState() dipanggil di trackInputChanges()
        }

        const goToQuestion = (questionId) => {
            // Mengatur layar ke 'inMission' untuk mengatasi transisi dari 'penalty'
            if (appState.screen === 'penalty') {
                appState.screen = 'inMission';
                updateAppScreen(); // Panggil updateAppScreen di sini untuk render transisi
            }
            
            stopCurrentAudio(); 
            // Waktu dicatat sebelum berpindah soal
            stopMissionTimer(); 
            startMissionTimer();
            
            triggerHaptics(50);
            appState.currentQuestionId = questionId;
            renderMissionState();
            document.getElementById('in-mission-screen').scrollIntoView({ behavior: 'smooth' });
            saveAppState();
        }

        const navigateToNextQuestion = () => {
            // FIX Bug 1: Akumulasi waktu dan reset start time
            stopMissionTimer(); 
            startMissionTimer();

            const missionQ = missionData[appState.currentMission];
            const currentIndex = missionQ.findIndex(q => q.id === appState.currentQuestionId);

            
            // Cari soal berikutnya yang BELUM Selesai (completed: false)
            let nextQ = missionQ.slice(currentIndex + 1).find(q => !appState.scores[appState.currentMission][q.id].completed);

            if (!nextQ) {
                // Jika tidak ada di depan, cari soal yang belum selesai dari awal
                nextQ = missionQ.slice(0, currentIndex).find(q => !appState.scores[appState.currentMission][q.id].completed);
            }
            
            if (nextQ) {
                goToQuestion(nextQ.id);
            } else {
                 navigateToMissionSelect();
            }
            saveAppState();
        }
        
        const handleConsultExpert = () => {
            triggerHaptics(200);
            stopCurrentAudio();

            const q = missionData[appState.currentMission].find(item => item.id === appState.currentQuestionId);
            const qState = appState.scores[appState.currentMission][q.id];

            qState.isConsulted = true; 
            
            const expertHint = getExpertHint(q);

            showModal('Bantuan Ahli (Konsekuensi: Max 5 Poin)', 
                     `Anda memilih menggunakan bantuan ahli. Skor maksimal untuk soal ini sekarang adalah ${CONSULT_HINT_SCORE} poin. \n\nPetunjuk Ahli: ${expertHint}`, 
                     () => {
                             document.getElementById('submit-answer-btn').disabled = false;
                             document.getElementById('skip-btn').disabled = false;
                             document.getElementById('play-audio-btn').disabled = false;
                             document.getElementById('consult-expert-btn').classList.add('hidden');
                             renderMissionState();
                             saveAppState();
                      }
            );

            // Sementara menonaktifkan semua aksi
            document.getElementById('submit-answer-btn').disabled = true;
            document.getElementById('skip-btn').disabled = true;
            document.getElementById('play-audio-btn').disabled = true;
            document.getElementById('consult-expert-btn').classList.add('hidden');
            saveAppState();
        }

        // --- Penilaian dan Penanganan Jawaban ---

        const handleSubmit = () => {
            triggerHaptics(100);
            stopCurrentAudio(); 
            
            const q = missionData[appState.currentMission].find(item => item.id === appState.currentQuestionId);
            const qState = appState.scores[appState.currentMission][q.id];
            const inputArea = document.getElementById('question-input-area');
            let score = 0;
            let feedback = '';
            let isCorrect = false;

            const maxScoreForQuestion = qState.isConsulted ? CONSULT_HINT_SCORE : q.points;

            // Pastikan input terakhir dicatat sebelum disubmit
            trackInputChanges();

            if (q.type === 'essay') {
                const text = qState.currentAnswer || ''; // Ambil dari state
                const wordCount = text ? text.split(/\s+/).filter(word => word.length > 0).length : 0;
                
                if (wordCount < q.minWords) {
                    showModal('Peringatan', `Jawaban esai Anda harus minimal ${q.minWords} kata. Kata saat ini: ${wordCount}.`);
                    return;
                }
                score = maxScoreForQuestion; 
                isCorrect = true;
                feedback = `Jawaban Anda (${wordCount} kata) telah dicatat. Mendapatkan ${score} poin.`;

            } else if (q.type === 'grid_tf') { // NEW: Logic penilaian untuk soal grid
                const userSelections = qState.currentAnswer || {};
                const totalItems = q.gridItems.length;
                let correctCount = 0;

                // Cek apakah semua item sudah dijawab
                const allAnswered = totalItems > 0 && Object.keys(userSelections).length === totalItems && Object.values(userSelections).every(v => v !== null);

                if (!allAnswered) {
                    showModal('Peringatan', 'Mohon lengkapi jawaban Benar/Salah untuk semua pernyataan di tabel.');
                    return;
                }

                q.gridItems.forEach((item, index) => {
                    const userAnswerValue = userSelections[index];
                    const correctAnswerValue = item.answer ? 'true' : 'false';
                    if (userAnswerValue === correctAnswerValue) {
                        correctCount++;
                    }
                });

                // Penilaian parsial: skor = (jumlah benar / total item) * maxScore
                score = Math.round((correctCount / totalItems) * maxScoreForQuestion);
                isCorrect = (correctCount === totalItems);
                
            } else { 
                let userAnswer = qState.currentAnswer;

                if (q.type === 'narrative_mc' || q.type === 'multiple_choice' || q.type === 'true_false') {
                    if (!userAnswer) {
                        showModal('Peringatan', 'Pilih salah satu jawaban terlebih dahulu.');
                        return;
                    }
                    isCorrect = (q.type === 'true_false') ? (userAnswer === 'Benar' ? q.answer : !q.answer) : (userAnswer === q.answer);
                    score = isCorrect ? maxScoreForQuestion : 0;
                    
                } else if (q.type === 'multiple_correct') {
                    const checkedBoxes = userAnswer || [];
                    const correctAnswers = q.correctAnswers;
                    const correctlySelected = checkedBoxes.filter(val => correctAnswers.includes(val)).length;
                    const incorrectlySelected = checkedBoxes.filter(val => !correctAnswers.includes(val)).length;
                    
                    if (correctAnswers.length > 0) {
                        if (incorrectlySelected === 0 && correctlySelected === correctAnswers.length) {
                            score = maxScoreForQuestion; isCorrect = true;
                        } else if (incorrectlySelected === 0 && correctlySelected > 0) {
                            const ratio = (correctlySelected / correctAnswers.length);
                            score = Math.round(ratio * maxScoreForQuestion); isCorrect = false;
                        } else { score = 0; isCorrect = false; }
                    }

                } else if (q.type === 'matching') {
                    const selectedTargets = userAnswer || [];
                    if (selectedTargets.some(s => s === '' || s === undefined || s === null)) {
                        showModal('Peringatan', 'Mohon lengkapi semua pasangan pencocokan terlebih dahulu.');
                        return;
                    }
                    let correctMatches = 0;
                    q.matches.forEach((match, index) => {
                        if (selectedTargets[index] === match.target) correctMatches++;
                    });
                    score = Math.round((correctMatches / q.matches.length) * maxScoreForQuestion);
                    isCorrect = (score === maxScoreForQuestion);
                }
            }
                
            if (isCorrect) {
                 feedback = qState.isConsulted ? `Jawaban Benar dengan Bantuan Ahli! Mendapat ${score} Poin.` : 'Jawaban Benar! 🎉';
            } else {
                 if (qState.isConsulted) {
                      feedback = `Jawaban salah, meskipun sudah menggunakan Ahli. Mendapat ${score} Poin.`;
                 } else {
                      feedback = 'Jawaban Salah. Anda bisa coba Tanya Ahli (Max 5 Poin), atau Lewati Soal.';
                 }
            }

            document.getElementById('feedback-message').textContent = feedback;
            document.getElementById('feedback-message').classList.toggle('text-green-400', isCorrect || qState.isConsulted);
            document.getElementById('feedback-message').classList.toggle('text-red-400', !isCorrect && !qState.isConsulted);
            document.getElementById('feedback-message').classList.remove('text-yellow-500', 'text-orange-400');
            document.getElementById('feedback-message').classList.toggle('text-orange-400', qState.isConsulted && !isCorrect);

            if (isCorrect || qState.isConsulted || q.type === 'essay') {
                appState.scores[appState.currentMission][q.id].score = score;
                appState.scores[appState.currentMission][q.id].completed = true;
                appState.scores[appState.currentMission][q.id].skipped = false;
                appState.scores[appState.currentMission][q.id].currentAnswer = qState.currentAnswer; // Simpan jawaban final

                renderQuestionInput(q, appState.scores[appState.currentMission][q.id]);
                
                if (isMissionCompleted(appState.currentMission)) {
                    navigateToMissionSelect();
                } else {
                    navigateToNextQuestion();
                }

            } else {
                if (q.type === 'essay') {
                    // Logic ini sudah ditangani di bagian atas sebelum pengecekan if (isCorrect || qState.isConsulted...)
                    // Untuk jaga-jaga (esay tanpa batas kata), tetap jalankan nextQ
                    appState.scores[appState.currentMission][q.id].score = 0;
                    appState.scores[appState.currentMission][q.id].completed = true;
                    navigateToNextQuestion();
                } else {
                    document.getElementById('submit-answer-btn').disabled = true;
                    document.getElementById('skip-btn').disabled = false; // Boleh dilewati
                    document.getElementById('play-audio-btn').disabled = true;
                    if (!qState.isConsulted) {
                        document.getElementById('consult-expert-btn').classList.remove('hidden');
                    }
                }
            }
            saveAppState();
        }
        
        const handleSkip = () => {
            triggerHaptics(50);
            stopCurrentAudio();
            
            const q = missionData[appState.currentMission].find(item => item.id === appState.currentQuestionId);
            
            // Simpan jawaban sementara sebelum dilewati
            trackInputChanges();

            // Tandai skipped, tidak completed, skor 0
            appState.scores[appState.currentMission][q.id].score = 0;
            appState.scores[appState.currentMission][q.id].completed = false; 
            appState.scores[appState.currentMission][q.id].skipped = true;

            document.getElementById('feedback-message').textContent = 'Soal dilewati. Mendapat 0 Poin. Anda dapat kembali mengerjakannya.';
            document.getElementById('feedback-message').classList.add('text-yellow-500');
            document.getElementById('feedback-message').classList.remove('text-green-400', 'text-red-400');
            
            document.getElementById('consult-expert-btn').classList.add('hidden'); 

            navigateToNextQuestion();
        }

        const sendDataToGoogleSheet = async (data) => {
            console.log("Mencoba mengirim data ke Google Sheets...");
            if (APPS_SCRIPT_URL.includes('GANTI_DENGAN_URL')) {
                console.error("ERROR: Harap ganti APPS_SCRIPT_URL dengan URL Web App Anda.");
                showModal('Peringatan Data', 'URL Apps Script belum diatur. Data tidak disimpan.');
                return;
            }

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });
                console.log("Data berhasil dikirim ke Apps Script (asumsi berhasil karena no-cors).");

            } catch (error) {
                console.error("Gagal mengirim data ke Apps Script:", error);
                showModal('Kesalahan Penyimpanan', 'Gagal terhubung ke server penyimpanan (Apps Script). Cek koneksi atau URL Web App Anda.');
            }
        }
        
        const clearInputFields = () => {
            document.getElementById('nama-input').value = '';
            document.getElementById('jurusan-input').value = '';
            document.getElementById('kelas-input').value = '';
            checkProfileInputs();
            saveAppState();
        }

        const resetGameStateAndUser = () => {
            userInfo = { nama: '', jurusan: '', kelas: '' };
            totalTimeSeconds = 0;
            appState.cheatingCount = 0;
            missionActiveStartTimestamp = null; // Reset timestamp
            appState.isCheatingListenerActive = false; // Pastikan non-aktif
            clearInputFields();
            
            Object.keys(missionData).forEach(missionName => {
                missionData[missionName].forEach(q => {
                    // Reset currentAnswer: null for single answer types, {} for grid
                    const initialAnswer = q.type === 'grid_tf' ? {} : null;
                    appState.scores[missionName][q.id] = { score: 0, completed: false, skipped: false, isConsulted: false, currentAnswer: initialAnswer }; 
                });
            });
            
            localStorage.removeItem(STORAGE_KEY);
        }
        
        // --- Perbaikan Anti-kecurangan (Stabilisasi Inisialisasi) ---
        const handleCheatingAttempt = (message) => {
            // Cek jika sedang inisialisasi, ABAIKAN event.
            if (isAppInitializing) {
                console.warn('[AC] Diabaikan (INIT): Event terjadi saat aplikasi memuat ulang.');
                return;
            }
            
            // Periksa jika sudah di layar penalty
            if (appState.screen === 'penalty') {
                return;
            }

            // Pemeriksaan ganda untuk memastikan hanya aktif saat misi berjalan
            if (appState.screen !== 'inMission' || !appState.isCheatingListenerActive || document.getElementById('modal').classList.contains('flex')) {
                 return; 
            }

            console.warn(`[AC] PELANGGARAN TERDETEKSI: ${message}. Count: ${appState.cheatingCount + 1}`);

            stopCurrentAudio();
            stopMissionTimer(); // Hentikan timer dan akumulasikan waktu
            appState.cheatingCount++;
            
            if (appState.cheatingCount >= MAX_CHEATING_ATTEMPTS) {
                const failureMessage = 'ANDA TELAH MELEBIHI BATAS PELANGGARAN!'; 
                
                // Matikan listener saat game berakhir karena kecurangan
                appState.isCheatingListenerActive = false; 

                showModal(failureMessage, 
                        `Anda telah melakukan ${MAX_CHEATING_ATTEMPTS} pelanggaran. Pengerjaan dihentikan dan dicatat.`, 
                        () => {
                               // Tandai semua soal yang belum selesai sebagai selesai (skor 0)
                               Object.keys(missionData).forEach(mName => {
                                   missionData[mName].forEach(q => {
                                       // Hanya soal yang ID-nya ada di daftar 10 soal yang harus ditandai selesai
                                       const isIncludedIn10 = missionData[mName].slice(0, 10).some(item => item.id === q.id);
                                       if (isIncludedIn10 && !appState.scores[mName][q.id].completed) {
                                           appState.scores[mName][q.id] = { 
                                                score: 0, 
                                                completed: true, 
                                                skipped: true, 
                                                isConsulted: false, 
                                                currentAnswer: q.type === 'grid_tf' ? {} : null // Reset currentAnswer
                                           };
                                       }
                                   });
                               });
                               appState.screen = 'finished';
                               updateAppScreen();
                         }
                );
                return;
            }
            
            // Pergi ke layar penalty
            document.getElementById('penalty-reason').textContent = message;
            document.getElementById('penalty-count').textContent = appState.cheatingCount;
            appState.screen = 'penalty'; 
            updateAppScreen();
        }
        // --- End Perbaikan Anti-kecurangan ---

        const renderFinalScreen = async () => {
            stopMissionTimer();
            // Nonaktifkan listener saat selesai
            appState.isCheatingListenerActive = false; 

            const finalScore = calculateGameScore(); 
            const missionName = 'Seluruh Misi Perlawanan Daerah';

            document.getElementById('mission-final-title').textContent = missionName;
            document.getElementById('mission-final-score').textContent = finalScore;
            document.getElementById('max-game-score').textContent = MAX_GAME_SCORE;
            document.getElementById('final-user-info').textContent = `${userInfo.nama} dari ${userInfo.jurusan} (${userInfo.kelas})`;
            document.getElementById('total-time-display').textContent = formatTime(totalTimeSeconds);
            
            const nextActionBtn = document.getElementById('next-action-btn');
            
            if (isGameCompleted() || appState.cheatingCount >= MAX_CHEATING_ATTEMPTS) {
                nextActionBtn.textContent = 'Keluar & Mulai Sesi Baru';
                nextActionBtn.onclick = () => {
                    triggerHaptics(50);
                    resetGameStateAndUser(); 
                    appState.screen = 'intro';
                    updateAppScreen();
                };
            } else {
                nextActionBtn.textContent = 'Pilih Misi Lain';
                nextActionBtn.onclick = navigateToMissionSelect;
            }

            const dataToSave = {
                timestamp: new Date().toLocaleString('id-ID'),
                nama_lengkap: userInfo.nama,
                kelas: userInfo.kelas,
                jurusan: userInfo.jurusan,
                skor_total: finalScore,
                waktu_total: formatTime(totalTimeSeconds),
                skor_aceh: calculateMissionScore("Perlawanan Aceh"),
                skor_maluku: calculateMissionScore("Perlawanan Maluku (Pattimura)"),
                skor_banten: calculateMissionScore("Perlawanan Banten (Sultan Ageng Tirtayasa)"),
                skor_gowa: calculateMissionScore("Perlawanan Gowa (Sultan Hasanuddin)"),
                status: appState.cheatingCount >= MAX_CHEATING_ATTEMPTS ? `GAGAL KARENA ${appState.cheatingCount} PELANGGARAN` : 'SELESAI NORMAL',
            };
            
            sendDataToGoogleSheet(dataToSave);
        }

        const navigateToMissionSelect = () => {
            stopCurrentAudio(); 
            stopMissionTimer(); 
            triggerHaptics();
            appState.screen = 'missionSelect';
            updateAppScreen();
        }

        // --- Profile Logic & Event Listeners ---
        const checkProfileInputs = () => {
            const nama = document.getElementById('nama-input').value.trim();
            const jurusan = document.getElementById('jurusan-input').value;
            const kelas = document.getElementById('kelas-input').value;
            
            const startBtn = document.getElementById('start-profile-btn');
            
            if (nama && jurusan && kelas) {
                startBtn.disabled = false;
            } else {
                startBtn.disabled = true;
            }
        }
        
        const handleProfileStart = () => {
            const nama = document.getElementById('nama-input').value.trim();
            const jurusan = document.getElementById('jurusan-input').value;
            const kelas = document.getElementById('kelas-input').value;

            if (nama && jurusan && kelas) {
                triggerHaptics(100);
                userInfo = { nama, jurusan, kelas };
                totalTimeSeconds = 0; 
                appState.cheatingCount = 0;
                
                initGameData();
                appState.screen = 'missionSelect';
                updateAppScreen();
            } else {
                 showModal('Informasi Kurang', 'Mohon lengkapi semua data (Nama, Jurusan, Kelas) sebelum memulai misi.');
            }
        }

        document.getElementById('play-audio-btn').addEventListener('click', () => {
            triggerHaptics(30);
            if (appState.currentQuestionId) {
                playQuestionAudio(appState.currentQuestionId);
            }
        });
        document.getElementById('submit-answer-btn').addEventListener('click', handleSubmit);
        document.getElementById('skip-btn').addEventListener('click', handleSkip);
        document.getElementById('consult-expert-btn').addEventListener('click', handleConsultExpert);
        document.getElementById('finish-mission-btn').addEventListener('click', () => {
            triggerHaptics(150);
            navigateToMissionSelect();
        });
        
        document.getElementById('next-action-btn').addEventListener('click', function() {
            if (isGameCompleted() || appState.cheatingCount >= MAX_CHEATING_ATTEMPTS) {
                triggerHaptics(50);
                resetGameStateAndUser(); 
                appState.screen = 'intro';
                updateAppScreen();
            } else {
                navigateToMissionSelect();
            }
        });
        
        // --- Perbaikan Tombol Lanjutkan Misi (Fix Final) ---
        document.getElementById('penalty-continue-btn').addEventListener('click', () => {
            triggerHaptics(150);
            
            // Pastikan kita punya misi aktif untuk dilanjutkan
            if (!appState.currentMission || !appState.currentQuestionId) {
                // Pindah ke menu jika tidak ada state misi yang tersimpan
                return navigateToMissionSelect();
            }
            
            // AKTIFKAN KEMBALI LISTENER ANTI-KECURANGAN
            appState.isCheatingListenerActive = true; 
            
            // Set layar kembali ke inMission dan render ulang menggunakan goToQuestion.
            // goToQuestion akan secara otomatis memulai timer dan merender state
            // Penting: Memanggil goToQuestion akan mengurus appState.screen = 'inMission' dan updateAppScreen()
            goToQuestion(appState.currentQuestionId); 
        });
        // --- End Perbaikan Tombol Lanjutkan Misi ---

        document.getElementById('nama-input').addEventListener('input', checkProfileInputs);
        document.getElementById('jurusan-input').addEventListener('change', checkProfileInputs); 
        document.getElementById('kelas-input').addEventListener('change', checkProfileInputs); 
        document.getElementById('start-profile-btn').addEventListener('click', handleProfileStart);
        document.getElementById('start-profile-btn').disabled = true; 
        
        // Event listener untuk melacak perubahan input non-tombol (multiple correct, essay, matching, grid_tf)
        document.getElementById('question-input-area').addEventListener('input', (e) => {
             // Pastikan event ini hanya mencakup elemen input non-tombol (checkbox/textarea/select)
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                trackInputChanges();
            }
        });
        
        document.getElementById('modal-close-btn').addEventListener('click', hideModal);

        // --- Anti-Cheating Event Listeners (Memanggil handleCheatingAttempt) ---
        
        document.addEventListener('visibilitychange', () => {
            // Hanya deteksi jika state benar-benar hidden dan misi aktif
            // Pengecualian inisialisasi dilakukan di handleCheatingAttempt
            if (document.visibilityState === 'hidden' && appState.screen === 'inMission') {
                handleCheatingAttempt("Anda terdeteksi berpindah Tab/Aplikasi saat misi berlangsung. Sesi dibatalkan dan skor direset.");
            }
        });

        window.addEventListener('blur', () => {
            // Deteksi jika jendela kehilangan fokus (pindah ke aplikasi lain atau split-screen)
            // Pengecualian inisialisasi dilakukan di handleCheatingAttempt, dan hanya terjadi jika TIDAK ADA MODAL AKTIF
            if (appState.screen === 'inMission' && !document.getElementById('modal').classList.contains('flex')) {
                // KODE KRITIS: Cek fokus untuk mencegah false positive yang terjadi saat loading/refresh
                if (!isAppInitializing && !document.hasFocus()) {
                    handleCheatingAttempt("Anda terdeteksi berpindah Aplikasi atau Split-Screen saat misi berlangsung. Sesi dibatalkan dan skor direset.");
                } else if (isAppInitializing) {
                    console.warn('[AC] Diabaikan (INIT-BLUR): Event terjadi saat aplikasi memuat ulang.');
                }
            }
        });

        document.addEventListener('keyup', (e) => {
            // Deteksi upaya screenshot (PrintScreen keycode 44)
            if (appState.screen === 'inMission' && (e.key === 'PrintScreen' || e.keyCode === 44)) {
                handleCheatingAttempt("Anda terdeteksi mencoba mengambil tangkapan layar (screenshot). Sesi dibatalkan dan skor direset.");
            }
        });
        
        // --- Inisialisasi Aplikasi (Urutan Eksekusi yang Tepat) ---
        window.onload = () => {
            if (Object.keys(firebaseConfig).length > 0) {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);

                async function authenticate() {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                        userId = auth.currentUser?.uid || crypto.randomUUID();
                    } catch (error) {
                        console.error("Gagal autentikasi Firebase:", error);
                    }
                }
                authenticate();
            } else {
                console.warn("Firebase config tidak tersedia.");
            }
            
            // 1. Inisialisasi data game sebelum memuat state lama
            initGameData();

            let shouldStartTimer = false;
            
            // 2. Muat state yang tersimpan
            if (loadAppState()) {
                if (appState.cheatingCount >= MAX_CHEATING_ATTEMPTS) {
                   console.log("[AC] Status Gagal Ditemukan saat Load. Memaksa ke layar 'finished'.");
                   appState.screen = 'finished';
                   appState.isCheatingListenerActive = false;
                } else if (appState.screen === 'inMission' || appState.screen === 'penalty') {
                    // Jika misi dilanjutkan, set flag untuk memulai timer setelah render
                    shouldStartTimer = true;
                    // Jika layar terakhir adalah penalty, tetap tampilkan penalty
                    if (appState.screen === 'penalty') {
                       document.getElementById('penalty-reason').textContent = "Peringatan! Anda kembali dari pelanggaran.";
                       document.getElementById('penalty-count').textContent = appState.cheatingCount;
                       // isCheatingListenerActive tetap FALSE saat di layar penalty. Tombol Lanjutkan Misi yang akan mengaktifkannya.
                    } else if (appState.screen === 'inMission') {
                       appState.isCheatingListenerActive = true;
                    }
                }
            } else {
                // Data baru
                appState.screen = 'intro';
                clearInputFields();
            }

            // 3. Render layar awal
            updateAppScreen();
            
            // 4. Jika harus memulai timer, jalankan (khusus untuk pemulihan inMission)
            if (shouldStartTimer && appState.screen === 'inMission') {
                startMissionTimer();
            }


            // 5. SETEL isAppInitializing = false setelah semua loading SANGAT JELAS selesai.
            // Menggunakan timeout 500ms untuk stabilitas Vercel/lingkungan eksternal
            setTimeout(() => {
                isAppInitializing = false; 
                console.log("[AC] Inisialisasi Selesai. Anti-Cheating Aktif.");
            }, 500); // Penundaan 500ms untuk stabilitas
        }

    </script>
</body>
</html>
