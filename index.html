<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QUIZ: Biaya Produksi & BEP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Desain yang lebih modern - Dominan Merah */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937; /* Latar belakang gelap */
            background-image: linear-gradient(135deg, #1f1f1f 0%, #0f0f0f 100%); /* Warna yang lebih gelap */
        }
        .container-card {
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .container-card:hover {
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.7);
        }
        .pulsate {
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .mission-button {
            transition: all 0.3s ease;
        }
        .mission-button:hover {
            transform: scale(1.02);
            background-color: #ef4444; /* red-500 */
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.5);
        }
        .option-button {
            transition: all 0.2s;
            border-radius: 0.5rem;
        }
        .option-button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        /* Gaya spesifik untuk tombol grid (Benar/Salah) */
        .grid-option-btn {
            @apply p-2 rounded-lg text-sm font-semibold transition duration-150;
            @apply flex items-center justify-center;
            min-width: 60px;
        }

        /* Navigasi Soal */
        #question-navigation {
            display: flex;
            gap: 8px; 
            flex-wrap: wrap;
            justify-content: center;
        }
        #question-navigation > * {
             margin: 0 !important; 
             flex-shrink: 0;
        }
        /* Style untuk penanda waktu kritis */
        .time-critical {
            color: #f87171; /* red-400 */
            font-weight: bold;
            animation: blink 1s step-start 0s infinite;
        }
        @keyframes blink {
            50% { opacity: 0.5; }
        }
    </style>
</head>
<!-- Anti-Cheating: Disabling right-click, copy, and select start -->
<body class="p-4 md:p-8 min-h-screen flex justify-center items-start md:items-center" oncontextmenu="return false;" oncopy="return false;" onselectstart="return false;">

    <!-- Kontainer Utama Aplikasi -->
    <div id="app" class="w-full max-w-2xl bg-gray-800 p-6 md:p-10 rounded-xl container-card text-white">
        <h1 class="text-4xl font-extrabold text-center text-red-500 mb-2 tracking-wide">QUIZ PRODUKSI & BEP</h1>
        <p class="text-xl font-light text-center text-gray-300 mb-8">Proyek Kreatif dan Kewirausahaan (40 Soal)</p>

        <!-- Area Status & Permainan -->
        <div id="game-container">
            
            <!-- LAYAR PEMUATAN GLOBAL -->
            <div id="loading-screen" class="text-center py-10 hidden">
                <p class="text-xl font-semibold text-red-400 mb-4 pulsate">Memuat Data Game...</p>
                <div class="w-16 h-16 border-4 border-red-200 border-t-red-500 rounded-full animate-spin mx-auto mb-4"></div>
                <p id="loading-detail" class="text-sm text-gray-400">Menyiapkan struktur soal...</p>
            </div>

            <!-- LAYAR 0: INTRO / PROFILE INPUT (START SCREEN) -->
            <div id="intro-screen" class="hidden">
                <h2 class="text-3xl font-bold text-center mb-6 text-white">Siap Menguji Pengetahuan BEP?</h2>
                
                <div class="bg-gray-700 p-6 rounded-xl mb-8 shadow-2xl border border-red-500/50">
                    <h3 class="text-xl font-extrabold mb-4 text-red-400 border-b border-red-700 pb-2">Instruksi Quiz</h3>
                    
                    <div class="grid md:grid-cols-2 gap-4 text-gray-300 text-sm">
                        
                        <!-- Kolom 1: Struktur & Navigasi -->
                        <div class="space-y-3">
                            <div class="flex items-start">
                                <span class="text-red-400 font-extrabold mr-2 mt-[-3px] text-lg">&bull;</span>
                                <span>Anda harus menyelesaikan <strong>40 soal</strong> dalam satu sesi.</span>
                            </div>
                            <div class="flex items-start">
                                <span class="text-red-400 font-extrabold mr-2 mt-[-3px] text-lg">&bull;</span>
                                <span>Total skor maksimal yang dapat diraih adalah <strong>100 Poin</strong>.</span>
                            </div>
                            <div class="flex items-start">
                                <span class="text-red-400 font-extrabold mr-2 mt-[-3px] text-lg">&bull;</span>
                                <span>Soal mencakup berbagai tipe, termasuk <strong>Analisis HOTS</strong> (Esai).</span>
                            </div>
                        </div>

                        <!-- Kolom 2: Scoring & Aturan -->
                        <div class="space-y-3">
                            <div class="flex items-start">
                                <span class="text-red-400 font-extrabold mr-2 mt-[-3px] text-lg">&bull;</span>
                                <span>Waktu pengerjaan total dibatasi <strong>40 menit</strong>.</span>
                            </div>
                            <div class="flex items-start">
                                <span class="text-red-400 font-extrabold mr-2 mt-[-3px] text-lg">&bull;</span>
                                <span>Gunakan "Tanya Ahli" untuk bantuan, namun skor maksimal menjadi **5 Poin** untuk soal tersebut.</span>
                            </div>
                            <div class="flex items-start font-semibold text-yellow-400">
                                <span class="text-red-500 font-extrabold mr-2 mt-[-3px] text-lg">&bull;</span>
                                <span class="text-red-300">Anda memiliki batas <strong>2 kali pelanggaran</strong> (Pindah Tab/Aplikasi). Pelanggaran ke-3 mengakhiri game.</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label for="nama-input" class="block text-sm font-medium text-gray-300 mb-1">Nama Lengkap:</label>
                        <input type="text" id="nama-input" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:ring-red-500 focus:border-red-500" placeholder="Contoh: R.A. Kartini">
                    </div>
                    <div>
                        <label for="jurusan-input" class="block text-sm font-medium text-gray-300 mb-1">Jurusan:</label>
                        <select id="jurusan-input" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-red-500 focus:border-red-500">
                            <option value="" disabled selected>-- Pilih Jurusan --</option>
                            <option value="FARMASI 1">FARMASI 1</option>
                            <option value="FARMASI 2">FARMASI 2</option>
                            <option value="KEPERAWATAN 1">KEPERAWATAN 1</option>
                            <option value="KEPERAWATAN 2">KEPERAWATAN 2</option>
                            <option value="TJKT 1">TJKT 1</option>
                            <option value="TJKT 2">TJKT 2</option>
                            <option value="TKR">TKR</option>
                            <option value="TBSM 1">TBSM 1</option>
                            <option value="TBSM 2">TBSM 2</option>
                        </select>
                    </div>
                    <div>
                        <label for="kelas-input" class="block text-sm font-medium text-gray-300 mb-1">Kelas:</label>
                        <select id="kelas-input" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-red-500 focus:border-red-500">
                            <option value="" disabled selected>-- Pilih Kelas --</option>
                            <option value="X">X</option>
                            <option value="XI">XI</option>
                            <option value="XII">XII</option>
                        </select>
                    </div>
                </div>
                
                <button id="start-profile-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 mt-8 disabled:bg-red-400">
                    Mulai Quiz
                </button>
            </div>

            <!-- LAYAR DALAM MISI (Satu-satunya layar permainan) -->
            <div id="in-mission-screen" class="hidden">
                <div class="bg-gray-700 p-3 rounded-lg mb-6 flex justify-between items-center text-sm">
                    <div>
                        <span class="text-red-400 font-semibold">Peserta:</span> 
                        <span id="user-name-display" class="text-white"></span>
                    </div>
                    <div>
                        <span class="text-red-400 font-semibold">Waktu Tersisa:</span> 
                        <span id="mission-time-display" class="text-white font-mono">40:00</span>
                    </div>
                </div>
                <!-- SKOR SEMENTARA MISI INI -->
                <div class="bg-red-900/50 p-3 rounded-lg mb-6 text-center">
                    <span class="text-red-300 font-semibold">SKOR SAAT INI:</span> 
                    <span id="mission-current-score" class="text-yellow-300 font-extrabold text-xl">0</span>
                    <span class="text-red-300 font-semibold">/ 100</span>
                </div>

                <h2 class="text-3xl font-bold text-center text-red-400 mb-4" id="mission-title">Quiz Biaya Produksi & BEP</h2>
                
                <!-- Navigasi Soal (40 Tombol) -->
                <div id="question-navigation" class="flex flex-wrap justify-center p-3 bg-gray-700 rounded-xl shadow-lg">
                    <!-- Navbol Misi di-render oleh JS -->
                </div>

                <div id="question-card" class="bg-gray-700 p-6 rounded-xl shadow-2xl border border-red-500/50">
                    <p class="text-sm font-medium text-gray-400 mb-3 flex justify-between">
                        <span id="question-type-display"></span>
                        <span id="question-difficulty" class="font-bold text-yellow-300"></span>
                    </p>
                    <p class="text-2xl font-semibold text-white mb-4" id="question-text"></p>
                    
                    <button id="play-audio-btn" class="hidden w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 mb-4 flex items-center justify-center disabled:bg-red-400">
                        <svg class="w-5 h-5 mr-2 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.26a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Dengarkan Audio Soal
                    </button>

                    <div id="question-input-area" class="space-y-3 mb-6">
                        <!-- Area Input/Opsi Jawaban (dinamis) -->
                    </div>

                    <div id="feedback-message" class="text-center text-lg font-extrabold mt-4"></div>
                </div>

                <div class="flex justify-between mt-6">
                    <button id="skip-btn" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-4 rounded-lg transition duration-200 disabled:opacity-50">
                        Lewati Soal
                    </button>
                    <!-- Tombol Tanya Ahli (Hidden by default) -->
                    <button id="consult-expert-btn" class="hidden bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                        Tanya Ahli (Max 5 Poin)
                    </button>
                    <button id="submit-answer-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 disabled:bg-green-300">
                        Jawab dan Lanjutkan
                    </button>
                </div>
                <button id="finish-mission-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 mt-4 hidden">
                    Selesaikan Quiz
                </button>
            </div>

            <!-- LAYAR PELANGGARAN ATURAN BARU -->
            <div id="penalty-screen" class="hidden text-center py-10 bg-gray-700 rounded-xl container-card">
                <h2 class="text-4xl font-extrabold text-red-600 mb-4">PELANGGARAN TERDETEKSI! ‚ö†Ô∏è</h2>
                <p class="text-xl text-gray-300 mb-6">Anda telah melanggar aturan game.</p>
                <div class="p-8 bg-gray-800 rounded-xl shadow-lg inline-block border-2 border-yellow-600">
                    <p class="text-3xl font-bold text-red-400 mb-2" id="penalty-reason"></p>
                    <p class="text-base text-gray-400">Pelanggaran ke: <span id="penalty-count" class="text-red-400 font-bold">1</span> dari <span class="text-red-400 font-bold">2</span></p>
                </div>
                <div class="mt-8">
                    <button id="penalty-continue-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200">
                        Lanjutkan Misi
                    </button>
                </div>
            </div>

            <!-- LAYAR AKHIR MISI -->
            <div id="final-screen" class="hidden text-center py-10 bg-gray-700 rounded-xl container-card">
                <h2 class="text-4xl font-extrabold text-red-400 mb-4">Quiz Selesai! üéâ</h2>
                <p class="text-xl text-gray-300 mb-6">Skor Akhir <span id="mission-final-title" class="text-red-400 font-bold"></span>:</p>
                <div class="p-8 bg-gray-800 rounded-xl shadow-lg inline-block border-2 border-red-600">
                    <!-- MAX SCORE 100 -->
                    <p class="text-6xl font-extrabold text-green-400" id="mission-final-score">0</p>
                    <p class="text-base text-gray-400 mt-2">Poin dari <span id="max-game-score"></span> Maksimal</p>
                    <p class="text-sm text-gray-400 mt-4">Waktu Total Pengerjaan: <span id="total-time-display">00:00</span></p>
                </div>
                <div class="mt-8">
                    <p class="text-sm text-gray-400 mb-4">Terima kasih, <span id="final-user-info"></span>!</p>
                    <button id="next-action-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 mr-3">
                        Keluar & Mulai Sesi Baru
                    </button>
                </div>
            </div>
        </div>

        <!-- Area Notifikasi Modal -->
        <div id="modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-50">
            <div class="bg-gray-800 p-6 rounded-xl shadow-xl max-w-sm w-full border border-red-500">
                <h3 class="text-xl font-bold mb-3 text-red-400" id="modal-title">Kesalahan</h3>
                <p id="modal-body" class="mb-4 text-gray-300">Terjadi kesalahan.</p>
                <button id="modal-close-btn" class="bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition duration-150">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Script Firebase & Logic Game -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // --- KONSTANTA DAN KONFIGURASI GLOBAL ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        // Ganti URL Web App ini dengan URL yang valid setelah Anda deploy Google Apps Script Anda.
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxMp_1DplyWKRpvXsj7psoIZhvDxa8FB1DY5Ug7JXAZrncMozummp1G_tJww6Sz-UK02w/exec'; 
        const TTS_API_KEY = ""; 
        const POINTS_PER_QUESTION = 2.5; // DIUBAH: 10 * 40 = 400. Sekarang 2.5 * 40 = 100.
        const CONSULT_HINT_SCORE = 5;
        const MAX_CHEATING_ATTEMPTS = 3;
        const MAX_QUESTIONS = 40; // Total soal
        const MAX_GAME_SCORE = 100; // DIUBAH: Menggunakan 100 sebagai skor maksimal
        const STORAGE_KEY = 'biayaProduksiQuizState';

        // Batas waktu pengerjaan (40 menit = 2400 detik)
        const MISSION_TIME_LIMIT_SECONDS = 40 * 60; 
        const GRADING_TIMEOUT_MS = 20000; 
        
        // Konstanta Tombol Audio (Dihilangkan di HTML, tapi logicnya dipertahankan jika diperlukan)
        const originalButtonContent = '<svg class="w-5 h-5 mr-2 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.26a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Dengarkan Audio Soal';

        const SCORE_MAP = {
            'narrative_mc': POINTS_PER_QUESTION, 
            'multiple_choice': POINTS_PER_QUESTION, 
            'true_false': POINTS_PER_QUESTION,
            'multiple_correct': POINTS_PER_QUESTION,
            'matching': POINTS_PER_QUESTION,
            'essay': POINTS_PER_QUESTION,
            'grid_tf': POINTS_PER_QUESTION, 
        };

        // --- STATE APLIKASI ---
        let app, auth, userId, currentAudio, missionActiveStartTimestamp, timerInterval, modalCloseCallback;
        let totalTimeSeconds = 0;
        let isAppInitializing = true; 
        
        userId = 'anon'; 
        currentAudio = null; 
        missionActiveStartTimestamp = null; 
        timerInterval = null;
        modalCloseCallback = null;

        let userInfo = { nama: '', jurusan: '', kelas: '' }; 
        
        let appState = {
            screen: 'loading', 
            currentMission: "Biaya Produksi dan BEP", // Tetapkan satu misi
            missions: {}, 
            currentQuestionId: null,
            scores: {}, 
            cheatingCount: 0,
            isCheatingListenerActive: false, 
            missionElapsedTime: 0,
        };
        const audioCache = new Map();
        
        // --- Haptics and Sound ---
        const triggerHaptics = (duration = 50) => {
            if (navigator.vibrate) {
                navigator.vibrate(duration);
            }
        }
        
        // --- DATA SOAL BARU: BIAYA PRODUKSI DAN BEP (40 SOAL) ---
        const missionData = {
            "Biaya Produksi dan BEP": [
                // Q1 - Q5 (MUDAH - MC/TF - Definisi Dasar)
                { id: 'q1_mc', type: 'multiple_choice', question: "Jenis biaya yang jumlahnya TIDAK berubah meskipun volume produksi naik atau turun disebut Biaya apa?", difficulty: 'MUDAH', options: ["Biaya Tetap (Fixed Cost)", "Biaya Variabel (Variable Cost)", "Biaya Operasional", "Biaya Pemasaran"], answer: "Biaya Tetap (Fixed Cost)", points: SCORE_MAP.multiple_choice },
                { id: 'q2_tf', type: 'true_false', question: "Pernyataan: Titik Impas (Break-Even Point/BEP) adalah kondisi di mana perusahaan mengalami keuntungan maksimal.", difficulty: 'MUDAH', answer: false, points: SCORE_MAP.true_false },
                { id: 'q3_mc', type: 'multiple_choice', question: "Biaya bahan baku langsung (raw materials) termasuk dalam kategori biaya?", difficulty: 'MUDAH', options: ["Biaya Tetap", "Biaya Semi-Variabel", "Biaya Variabel", "Biaya Overhead"], answer: "Biaya Variabel", points: SCORE_MAP.multiple_choice },
                { id: 'q4_tf', type: 'true_false', question: "Pernyataan: Gaji bulanan manajer produksi termasuk Biaya Variabel karena harus dibayar setiap bulan.", difficulty: 'MUDAH', answer: false, points: SCORE_MAP.true_false },
                { id: 'q5_mc', type: 'multiple_choice', question: "Tujuan utama seorang wirausaha menghitung BEP adalah untuk mengetahui batas minimum...?", difficulty: 'MUDAH', options: ["Kerugian maksimum", "Penjualan agar tidak rugi", "Modal awal yang dibutuhkan", "Biaya pemasaran"], answer: "Penjualan agar tidak rugi", points: SCORE_MAP.multiple_choice },
                
                // Q6 - Q10 (GRID TF - Konsep & Komponen)
                { id: 'q6_grid', type: 'grid_tf', question: "Narasi: BEP dihitung dengan membandingkan Biaya Tetap (FC) dengan Margin Kontribusi (selisih Harga Jual dan Biaya Variabel per unit).\n\nTandai Benar atau Salah untuk setiap pernyataan:", difficulty: 'SEDANG', gridItems: [
                    { text: "Margin Kontribusi adalah sisa dari harga jual setelah menutup Biaya Tetap.", answer: false }, 
                    { text: "Semakin rendah Biaya Tetap, semakin cepat BEP tercapai.", answer: true }, 
                    { text: "Harga jual produk tidak memengaruhi perhitungan BEP.", answer: false }, 
                    { text: "BEP terjadi ketika Total Penjualan sama dengan Total Biaya.", answer: true }
                ], points: SCORE_MAP.grid_tf },
                { id: 'q7_mc', type: 'multiple_choice', question: "Jika BEP unit menunjukkan 500 unit, apa artinya bagi perusahaan?", difficulty: 'SEDANG', options: ["Perusahaan harus menjual 500 unit untuk mendapat laba.", "Perusahaan harus menjual minimal 500 unit agar tidak rugi.", "Modal awal sebesar 500 unit uang.", "Perusahaan hanya boleh menjual 500 unit maksimal."], answer: "Perusahaan harus menjual minimal 500 unit agar tidak rugi.", points: SCORE_MAP.multiple_choice },
                { id: 'q8_correct', type: 'multiple_correct', question: "Pilih dua (2) contoh yang PALING TEPAT untuk Biaya Tetap (Fixed Cost) dalam usaha kantin sekolah?", difficulty: 'SEDANG', options: ["Biaya sewa tempat selama satu tahun", "Biaya pembelian beras harian", "Gaji pegawai tetap bulanan", "Biaya listrik berdasarkan pemakaian"], correctAnswers: ["Biaya sewa tempat selama satu tahun", "Gaji pegawai tetap bulanan"], points: SCORE_MAP.multiple_correct }, 
                { id: 'q9_matching', type: 'matching', question: "Cocokkan komponen BEP dengan deskripsinya.", difficulty: 'SEDANG', matches: [
                    { prompt: "Fixed Cost (FC)", target: "Biaya yang stabil meskipun volume produksi berubah" }, 
                    { prompt: "Variable Cost (VC)", target: "Biaya yang berubah sesuai volume produksi" }, 
                    { prompt: "Break-Even Point (BEP)", target: "Titik di mana total pendapatan sama dengan total biaya" }
                ], points: SCORE_MAP.matching },
                { id: 'q10_tf', type: 'true_false', question: "Pernyataan: Semakin besar Margin Kontribusi per unit, semakin sedikit unit yang harus dijual untuk mencapai BEP.", difficulty: 'SEDANG', answer: true, points: SCORE_MAP.true_false },

                // Q11 - Q20 (SEDANG - Perhitungan Sederhana & Aplikasi)
                { id: 'q11_mc', type: 'multiple_choice', question: "Jika Biaya Tetap total (FC) Rp 10.000.000 dan Margin Kontribusi per unit Rp 20.000, berapa BEP dalam unit?", difficulty: 'SEDANG', options: ["200 unit", "500 unit", "1.000 unit", "5.000 unit"], answer: "500 unit", points: SCORE_MAP.multiple_choice },
                { id: 'q12_mc', type: 'multiple_choice', question: "Rumus untuk menghitung Break-Even Point dalam Rupiah adalah:", difficulty: 'SEDANG', options: ["FC / Harga Jual", "VC / Harga Jual", "FC / Margin Kontribusi Rasio", "VC / Margin Kontribusi Rasio"], answer: "FC / Margin Kontribusi Rasio", points: SCORE_MAP.multiple_choice },
                { id: 'q13_correct', type: 'multiple_correct', question: "Pilih dua (2) elemen yang harus diketahui sebelum menghitung BEP unit?", difficulty: 'SEDANG', options: ["Total modal pemilik", "Harga jual per unit", "Biaya tetap total", "Total utang perusahaan"], correctAnswers: ["Harga jual per unit", "Biaya tetap total"], points: SCORE_MAP.multiple_correct }, 
                { id: 'q14_mc', type: 'multiple_choice', question: "Total Biaya (Total Cost) adalah penjumlahan dari...", difficulty: 'SEDANG', options: ["Biaya Pemasaran + Biaya Distribusi", "Harga Jual + Laba Kotor", "Biaya Tetap + Biaya Variabel", "Biaya Tenaga Kerja + Biaya Overhead"], answer: "Biaya Tetap + Biaya Variabel", points: SCORE_MAP.multiple_choice },
                { id: 'q15_matching', type: 'matching', question: "Cocokkan biaya dengan contohnya.", difficulty: 'SEDANG', matches: [
                    { prompt: "Gaji staf administrasi", target: "Biaya Tetap" }, 
                    { prompt: "Komisi penjualan", target: "Biaya Variabel" }, 
                    { prompt: "Penyusutan mesin", target: "Biaya Tetap" }
                ], points: SCORE_MAP.matching },
                { id: 'q16_tf', type: 'true_false', question: "Pernyataan: Margin Kontribusi Rasio menunjukkan persentase Margin Kontribusi terhadap Harga Jual.", difficulty: 'SEDANG', answer: true, points: SCORE_MAP.true_false },
                { id: 'q17_mc', type: 'multiple_choice', question: "Langkah pertama yang benar dalam menyusun Biaya Produksi adalah mengidentifikasi dan memisahkan?", difficulty: 'SEDANG', options: ["Modal dan Utang", "Laba dan Rugi", "Biaya Tetap dan Biaya Variabel", "Penjualan dan Pembelian"], answer: "Biaya Tetap dan Biaya Variabel", points: SCORE_MAP.multiple_choice },
                { id: 'q18_correct', type: 'multiple_correct', question: "Pilih dua (2) kondisi yang PALING memengaruhi naiknya titik BEP (Break-Even Point)?", difficulty: 'SEDANG', options: ["Kenaikan Harga Jual", "Kenaikan Biaya Tetap", "Penurunan Biaya Variabel", "Kenaikan Biaya Variabel"], correctAnswers: ["Kenaikan Biaya Tetap", "Kenaikan Biaya Variabel"], points: SCORE_MAP.multiple_correct },
                { id: 'q19_matching', type: 'matching', question: "Pasangkan formula dasar dengan hasilnya.", difficulty: 'SEDANG', matches: [
                    { prompt: "Harga Jual - Biaya Variabel", target: "Margin Kontribusi Unit" }, 
                    { prompt: "Total Penjualan - Total Biaya", target: "Laba (Keuntungan)" }, 
                    { prompt: "Total Biaya Tetap / Margin Kontribusi Unit", target: "BEP Unit" }
                ], points: SCORE_MAP.matching },
                { id: 'q20_tf', type: 'true_false', question: "Pernyataan: Biaya Tenaga Kerja Langsung (Direct Labor) selalu dianggap sebagai Biaya Tetap.", difficulty: 'SEDANG', answer: false, points: SCORE_MAP.true_false },

                // Q21 - Q30 (SULIT - Analisis Kasus/Grid)
                { id: 'q21_grid', type: 'grid_tf', question: "Narasi: Sebuah usaha bakso rumahan memiliki sewa tempat Rp 3 jt/tahun (FC). Biaya variabel (bumbu, daging, gas) per porsi Rp 12.000. Harga jual Rp 20.000/porsi.\n\nTandai Benar atau Salah untuk analisis ini:", difficulty: 'SULIT', gridItems: [
                    { text: "Margin Kontribusi per porsi adalah Rp 8.000.", answer: true }, 
                    { text: "Jika menjual 375 porsi, usaha tersebut sudah balik modal tahunan.", answer: true }, // 3.000.000 / 8.000 = 375
                    { text: "Jika biaya variabel naik menjadi Rp 15.000, BEP akan tetap sama.", answer: false }, 
                    { text: "Sewa tempat dianggap Fixed Cost bulanan dalam perhitungan BEP tahunan ini.", answer: false }
                ], points: SCORE_MAP.grid_tf },
                { id: 'q22_mc', type: 'multiple_choice', question: "Jika sebuah perusahaan berada di bawah titik BEP, tindakan yang paling rasional untuk segera dilakukan adalah?", difficulty: 'SULIT', options: ["Meningkatkan Biaya Tetap", "Mencari utang baru", "Meningkatkan volume penjualan", "Menambah jumlah karyawan administrasi"], answer: "Meningkatkan volume penjualan", points: SCORE_MAP.multiple_choice },
                { id: 'q23_mc', type: 'multiple_choice', question: "Apa yang terjadi pada Margin Kontribusi Rasio (MCR) jika Harga Jual dan Biaya Variabel sama-sama naik sebesar 10%?", difficulty: 'SULIT', options: ["MCR akan naik", "MCR akan turun", "MCR akan tetap sama", "Tidak bisa ditentukan"], answer: "MCR akan tetap sama", points: SCORE_MAP.multiple_choice },
                { id: 'q24_grid', type: 'grid_tf', question: "Narasi: Margin of Safety (MoS) adalah batas aman penjualan di atas BEP, menunjukkan seberapa jauh penurunan penjualan yang masih bisa ditoleransi sebelum rugi.\n\nTandai Benar atau Salah terkait Margin of Safety:", difficulty: 'SULIT', gridItems: [
                    { text: "Margin of Safety dihitung setelah titik BEP ditemukan.", answer: true }, 
                    { text: "Jika Margin of Safety 0%, artinya perusahaan sudah rugi.", answer: false }, 
                    { text: "Semakin tinggi MoS, semakin kecil risiko kerugian perusahaan.", answer: true }, 
                    { text: "MoS hanya berlaku untuk industri manufaktur.", answer: false }
                ], points: SCORE_MAP.grid_tf },
                { id: 'q25_correct', type: 'multiple_correct', question: "Pilih dua (2) cara EFEKTIF untuk menurunkan Break-Even Point (BEP)?", difficulty: 'SULIT', options: ["Menambah Biaya Pemasaran", "Menurunkan Biaya Tetap", "Meningkatkan Harga Jual", "Meningkatkan Biaya Variabel"], correctAnswers: ["Menurunkan Biaya Tetap", "Meningkatkan Harga Jual"], points: SCORE_MAP.multiple_correct }, 
                { id: 'q26_matching', type: 'matching', question: "Cocokkan tujuan perhitungan BEP dengan aplikasinya.", difficulty: 'SULIT', matches: [
                    { prompt: "BEP Unit", target: "Menentukan target produksi minimum" }, 
                    { prompt: "BEP Rupiah", target: "Menentukan target pendapatan minimum" }, 
                    { prompt: "Margin Kontribusi Rasio", target: "Mengukur sensitivitas laba terhadap perubahan penjualan" }
                ], points: SCORE_MAP.matching },
                { id: 'q27_mc', type: 'multiple_choice', question: "Sebuah perusahaan menjual barang Rp 50.000/unit. Biaya variabel Rp 30.000/unit. Biaya tetap Rp 40.000.000. Jika perusahaan menargetkan laba Rp 20.000.000, berapa unit yang harus dijual?", difficulty: 'SULIT', options: ["1.000 unit", "2.000 unit", "3.000 unit", "4.000 unit"], answer: "3.000 unit", points: SCORE_MAP.multiple_choice }, // (40jt + 20jt) / (50k - 30k) = 60jt / 20k = 3000
                { id: 'q28_tf', type: 'true_false', question: "Pernyataan: Analisis BEP mengasumsikan bahwa harga jual dan efisiensi produksi akan selalu tetap stabil meskipun volume penjualan sangat tinggi.", difficulty: 'SULIT', answer: true, points: SCORE_MAP.true_false },
                { id: 'q29_correct', type: 'multiple_correct', question: "Pilih dua (2) variabel utama yang digunakan dalam perhitungan BEP (baik unit maupun Rupiah)?", difficulty: 'SULIT', options: ["Harga beli bahan baku", "Total Biaya Tetap", "Harga Jual", "Laba sebelum pajak"], correctAnswers: ["Total Biaya Tetap", "Harga Jual"], points: SCORE_MAP.multiple_correct },
                { id: 'q30_mc', type: 'multiple_choice', question: "Bagaimana cara Margin Kontribusi Unit (MCU) dihitung?", difficulty: 'SULIT', options: ["Harga Jual - Biaya Tetap", "Harga Jual - Biaya Variabel", "Biaya Tetap / Biaya Variabel", "Total Biaya / Jumlah Unit"], answer: "Harga Jual - Biaya Variabel", points: SCORE_MAP.multiple_choice },

                // Q31 - Q39 (SULIT - Lanjutan & HOTS Non-Esai)
                { id: 'q31_mc', type: 'multiple_choice', question: "Sebuah usaha memiliki BEP unit 500 dan sedang menjual 800 unit. Berapa Margin of Safety (MoS) dalam unit?", difficulty: 'SULIT', options: ["100 unit", "200 unit", "300 unit", "400 unit"], answer: "300 unit", points: SCORE_MAP.multiple_choice },
                { id: 'q32_matching', type: 'matching', question: "Cocokkan dampak perubahan dengan titik BEP.", difficulty: 'SULIT', matches: [
                    { prompt: "Kenaikan Biaya Sewa Pabrik", target: "BEP Naik" }, 
                    { prompt: "Penurunan Harga Jual", target: "BEP Naik" }, 
                    { prompt: "Penemuan Bahan Baku Lebih Murah", target: "BEP Turun" }
                ], points: SCORE_MAP.matching },
                { id: 'q33_mc', type: 'multiple_choice', question: "Jika Margin Kontribusi Rasio adalah 40%, dan Biaya Tetap Rp 20.000.000, berapa BEP dalam Rupiah?", difficulty: 'SULIT', options: ["Rp 5.000.000", "Rp 20.000.000", "Rp 50.000.000", "Rp 80.000.000"], answer: "Rp 50.000.000", points: SCORE_MAP.multiple_choice }, // 20jt / 0.4 = 50jt
                { id: 'q34_grid', type: 'grid_tf', question: "Narasi: PT ABC mengalami peningkatan Fixed Cost karena membeli mesin baru, namun Variable Cost per unit turun karena efisiensi mesin baru.\n\nTandai Benar atau Salah untuk analisis dampaknya:", difficulty: 'SULIT', gridItems: [
                    { text: "Keputusan ini pasti akan menurunkan titik BEP.", answer: false }, 
                    { text: "Jika penurunan VC lebih dominan, BEP bisa turun.", answer: true }, 
                    { text: "Peningkatan FC selalu berarti BEP akan naik, tanpa memandang VC.", answer: false }, 
                    { text: "Perubahan VC memengaruhi Margin Kontribusi Rasio.", answer: true }
                ], points: SCORE_MAP.grid_tf },
                { id: 'q35_correct', type: 'multiple_correct', question: "Pilih dua (2) pernyataan yang TEPAT mengenai Biaya Variabel (VC) dalam konteks proyeksi BEP?", difficulty: 'SULIT', options: ["VC per unit dianggap konstan.", "Total VC akan meningkat seiring peningkatan produksi.", "VC harus selalu lebih besar dari FC.", "VC per unit akan berkurang seiring peningkatan produksi."], correctAnswers: ["VC per unit dianggap konstan.", "Total VC akan meningkat seiring peningkatan produksi."], points: SCORE_MAP.multiple_correct },
                { id: 'q36_mc', type: 'multiple_choice', question: "BEP Unit = FC / (P - VC). 'P' dalam rumus ini melambangkan?", difficulty: 'SULIT', options: ["Profit", "Penjualan Total", "Harga Jual per Unit", "Pajak"], answer: "Harga Jual per Unit", points: SCORE_MAP.multiple_choice },
                { id: 'q37_grid', type: 'grid_tf', question: "Narasi: Pengusaha X berencana menaikkan harga jual produk 5% dan gaji tetap (FC) staf 5%.\n\nTandai Benar atau Salah untuk dampak perubahan ini terhadap BEP Unit (asumsi VC tetap):", difficulty: 'SULIT', gridItems: [
                    { text: "Margin Kontribusi per unit pasti meningkat.", answer: true }, 
                    { text: "Peningkatan FC akan cenderung menaikkan BEP.", answer: true }, 
                    { text: "Kedua perubahan ini saling meniadakan, sehingga BEP tetap.", answer: false }, 
                    { text: "BEP unit mungkin akan naik atau turun tergantung perbandingan kenaikan FC dan Margin Kontribusi.", answer: true }
                ], points: SCORE_MAP.grid_tf },
                { id: 'q38_matching', type: 'matching', question: "Pasangkan data ini ke fungsinya dalam analisis BEP.", difficulty: 'SULIT', matches: [
                    { prompt: "Total biaya sewa pabrik", target: "Pembilang rumus BEP" }, 
                    { prompt: "Selisih harga jual dan VC per unit", target: "Penyebut rumus BEP unit" }, 
                    { prompt: "Total penjualan aktual", target: "Dasar perhitungan Margin of Safety" }
                ], points: SCORE_MAP.matching },
                { id: 'q39_tf', type: 'true_false', question: "Pernyataan: Dalam analisis BEP yang sederhana, struktur biaya (proporsi FC dan VC) dianggap selalu tetap dalam rentang volume produksi yang relevan.", difficulty: 'SULIT', answer: true, points: SCORE_MAP.true_false },

                // Q40 (HOTS - ESSAY)
                { id: 'q40_essay', type: 'essay', question: "Analisis: Jelaskan mengapa wirausaha perlu melakukan analisis BEP TIDAK HANYA dalam unit, tetapi juga dalam Rupiah, dan sebutkan 2 (dua) manfaat strategis utama dari Margin of Safety (MoS) bagi pengambilan keputusan manajemen.", difficulty: 'HOTS', minWords: 40, points: SCORE_MAP.essay } 
            ]
        };

        // --- FUNGSI UTILITY DAN KONFIGURASI API ---

        const base64ToArrayBuffer = (base64) => {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        const writeString = (view, offset, string) => {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }
        
        const pcmToWav = (pcm16, sampleRate = 24000) => {
            const buffer = new ArrayBuffer(44 + pcm16.length * 2);
            const view = new DataView(buffer);
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcm16.length * 2, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); 
            view.setUint16(22, 1, true); 
            view.setUint32(24, sampleRate, true); 
            view.setUint32(28, sampleRate * 2, true); 
            view.setUint16(32, 2, true); 
            view.setUint16(34, 16, true); 
            writeString(view, 36, 'data');
            view.setUint32(40, pcm16.length * 2, true);
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++, offset += 2) {
                view.setInt16(offset, pcm16[i], true);
            }
            return new Blob([buffer], { type: 'audio/wav' });
        }
        
        const generateAudioBlob = async (text) => {
            // FUNGSI INI DITINGGALKAN, NAMUN TOMBOL DI HTML SUDAH DIHIDDEN
            return new Blob(["Audio feature disabled for this content."], { type: 'text/plain' });
        }

        const playQuestionAudio = async (questionId) => {
            // FUNGSI INI DITINGGALKAN, NAMUN TOMBOL DI HTML SUDAH DIHIDDEN
            showModal('Informasi Audio', 'Fitur audio dinonaktifkan untuk quiz ini.');
        }

        const formatTime = (seconds) => {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            const pad = (num) => String(num).padStart(2, '0');
            return `${pad(minutes)}:${pad(remainingSeconds)}`;
        }
        
        const startMissionTimer = () => {
            // Mengganti 1200 dengan MISSION_TIME_LIMIT_SECONDS (2400)
            if (appState.missionElapsedTime >= MISSION_TIME_LIMIT_SECONDS) { return; }
            
            stopMissionTimer(); 
            missionActiveStartTimestamp = Date.now();
            const timeDisplay = document.getElementById('mission-time-display');

            const updateTimerDisplay = () => {
                const elapsedSinceStart = Math.floor((Date.now() - missionActiveStartTimestamp) / 1000);
                const currentElapsed = appState.missionElapsedTime + elapsedSinceStart;
                const timeRemaining = MISSION_TIME_LIMIT_SECONDS - currentElapsed;

                if (timeRemaining <= 0) {
                    stopMissionTimer();
                    appState.missionElapsedTime = MISSION_TIME_LIMIT_SECONDS;
                    timeDisplay.textContent = '00:00';
                    timeDisplay.classList.remove('time-critical');
                    
                    showModal(
                        'Waktu Habis!', 
                        'Waktu 40 menit untuk quiz ini telah habis. Quiz dihentikan dan skor Anda telah dicatat.',
                        () => finishQuiz(true) 
                    );
                    return;
                }

                timeDisplay.textContent = formatTime(timeRemaining);
                
                if (timeRemaining <= 120) {
                    timeDisplay.classList.add('time-critical');
                } else {
                    timeDisplay.classList.remove('time-critical');
                }
            };

            updateTimerDisplay();
            timerInterval = setInterval(updateTimerDisplay, 1000);
        }

        const stopMissionTimer = () => {
            if (timerInterval) {
                if (missionActiveStartTimestamp) {
                    const elapsedSinceStart = Math.floor((Date.now() - missionActiveStartTimestamp) / 1000);
                    appState.missionElapsedTime += elapsedSinceStart; 
                    missionActiveStartTimestamp = null; 
                }
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
        
        const stopCurrentAudio = () => {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                if (currentAudio.src.startsWith('blob:')) {
                    URL.revokeObjectURL(currentAudio.src);
                }
                currentAudio = null;
            }
        }
        
        const saveAppState = () => {
            try {
                const stateToSave = {
                    appState: {
                        ...appState,
                        missionActiveStartTimestamp: appState.screen === 'inMission' ? Date.now() : null,
                    },
                    userInfo,
                    totalTimeSeconds,
                    scores: JSON.parse(JSON.stringify(appState.scores)), 
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(stateToSave));
            } catch (e) {
                console.error('Gagal menyimpan state:', e);
            }
        }

        const calculateMissionScore = (missionName) => {
            if (!appState.scores[missionName]) return 0;
            return Object.values(appState.scores[missionName]).reduce((sum, qScore) => sum + qScore.score, 0);
        }

        const isMissionCompleted = (missionName) => {
            if (!appState.scores[missionName]) return 0;
            // Cek apakah semua 40 soal sudah completed
            return Object.values(appState.scores[missionName]).filter(q => q.completed).length === MAX_QUESTIONS;
        }

        const calculateGameScore = () => {
            // Karena hanya ada satu misi, ini adalah skor total
            return calculateMissionScore(appState.currentMission);
        }
        
        // --- LOGIKA ALUR BARU: MENGHILANGKAN PEMILIHAN MISI ---

        function updateAppScreen() {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('intro-screen').classList.add('hidden'); 
            // document.getElementById('mission-select-screen').classList.add('hidden'); // Dihapus
            document.getElementById('in-mission-screen').classList.add('hidden');
            document.getElementById('final-screen').classList.add('hidden');
            document.getElementById('penalty-screen').classList.add('hidden');

            
            if (appState.screen === 'loading') {
                document.getElementById('loading-screen').classList.remove('hidden');
            } else if (appState.screen === 'intro') { 
                document.getElementById('intro-screen').classList.remove('hidden');
            } else if (appState.screen === 'inMission') {
                document.getElementById('in-mission-screen').classList.remove('hidden');
                renderMissionState();
                startMissionTimer(); // Pastikan timer dimulai saat masuk misi
            } else if (appState.screen === 'finished') {
                document.getElementById('final-screen').classList.remove('hidden');
                renderFinalScreen();
            } else if (appState.screen === 'penalty') { 
                document.getElementById('penalty-screen').classList.remove('hidden');
            }
            
            saveAppState();
        }

        // Menggantikan fungsi navigateToMissionSelect
        function finishQuiz(timeExpired = false) {
            stopCurrentAudio(); 
            stopMissionTimer(); 

            const missionName = appState.currentMission;
            
            // Akumulasi sisa waktu misi yang terpause (hanya jika waktu habis/pelanggaran)
            if (missionName && appState.missionElapsedTime > 0) {
                 totalTimeSeconds += appState.missionElapsedTime;
                 appState.missionElapsedTime = 0;
            }

            if (timeExpired || appState.cheatingCount >= MAX_CHEATING_ATTEMPTS) {
                 // Tandai semua soal yang belum selesai sebagai selesai (skor 0)
                 if (missionName) {
                    appState.missions[missionName].forEach(q => {
                        if (!appState.scores[missionName][q.id].completed) {
                            appState.scores[missionName][q.id].completed = true;
                            appState.scores[missionName][q.id].score = 0;
                            appState.scores[missionName][q.id].skipped = true;
                        }
                    });
                }
            }
            
            appState.screen = 'finished';
            updateAppScreen();
        }

        function selectMission(name) {
            // Fungsi ini sekarang dipanggil dari handleProfileStart, jadi tidak perlu tombol di sini.
            triggerHaptics();
            stopCurrentAudio();
            appState.currentMission = name;

            appState.missionElapsedTime = 0; 
            
            appState.isCheatingListenerActive = true; 
            startMissionTimer();
            
            const missionQ = appState.missions[name]; 
            const firstUncompletedQuestion = missionQ.find(q => !appState.scores[name][q.id].completed);
            
            if (firstUncompletedQuestion) {
                goToQuestion(firstUncompletedQuestion.id);
            } else {
                goToQuestion(missionQ[0].id);
            }
            appState.screen = 'inMission';
            updateAppScreen();
        }

        // --- END LOGIKA ALUR BARU ---


        // --- PROFILE HANDLERS ---
        const checkProfileInputs = () => {
            const nama = document.getElementById('nama-input').value.trim();
            const jurusan = document.getElementById('jurusan-input').value;
            const kelas = document.getElementById('kelas-input').value;
            const startBtn = document.getElementById('start-profile-btn');
            
            if (nama && jurusan !== "" && kelas !== "") {
                startBtn.disabled = false;
            } else {
                startBtn.disabled = true;
            }
        }
        
        const handleProfileStart = () => {
            const nama = document.getElementById('nama-input').value.trim();
            const jurusan = document.getElementById('jurusan-input').value;
            const kelas = document.getElementById('kelas-input').value;

            if (nama && jurusan !== "" && kelas !== "") {
                triggerHaptics(100);
                userInfo = { nama, jurusan, kelas };
                totalTimeSeconds = 0; 
                appState.cheatingCount = 0;
                appState.missionElapsedTime = 0; 
                
                // Mulai misi otomatis
                const missionName = Object.keys(missionData)[0];
                appState.currentMission = missionName;
                const missionQ = appState.missions[missionName];
                
                if (missionQ && missionQ.length > 0) {
                     // Cari soal pertama yang belum selesai (jika ada)
                    const firstUncompletedQuestion = missionQ.find(q => !appState.scores[missionName][q.id].completed);

                    if (firstUncompletedQuestion) {
                        appState.currentQuestionId = firstUncompletedQuestion.id;
                    } else {
                        appState.currentQuestionId = missionQ[0].id; // Mulai dari Q1
                    }
                    
                    appState.screen = 'inMission';
                    appState.isCheatingListenerActive = true; 
                    updateAppScreen();
                } else {
                    showModal('Kesalahan Data', 'Data soal kuis tidak ditemukan.');
                }

            } else {
                showModal('Informasi Kurang', 'Mohon lengkapi semua data (Nama, Jurusan, Kelas) sebelum memulai quiz.');
            }
        }
        // --- END: PROFILE HANDLERS ---
        
        const loadAppState = () => {
            try {
                const savedState = localStorage.getItem(STORAGE_KEY);
                if (!savedState) return false;

                const loadedData = JSON.parse(savedState);
                
                appState = loadedData.appState || appState;
                appState.isCheatingListenerActive = false; 
                appState.missionElapsedTime = loadedData.appState.missionElapsedTime || 0;

                userInfo = loadedData.userInfo || userInfo;
                totalTimeSeconds = loadedData.totalTimeSeconds || 0;
                
                // Pastikan currentMission selalu menunjuk ke misi tunggal
                appState.currentMission = Object.keys(missionData)[0]; 

                if (loadedData.appState.missions) {
                    appState.missions = loadedData.appState.missions;
                }

                // Memperhitungkan waktu yang hilang saat aplikasi ditutup
                const savedTimestamp = loadedData.appState.missionActiveStartTimestamp;
                if ((appState.screen === 'inMission' || appState.screen === 'penalty') && savedTimestamp) {
                    const timeLostSeconds = Math.floor((Date.now() - savedTimestamp) / 1000);
                    appState.missionElapsedTime += timeLostSeconds; 
                    
                    if (appState.missionElapsedTime >= MISSION_TIME_LIMIT_SECONDS) {
                        appState.missionElapsedTime = MISSION_TIME_LIMIT_SECONDS;
                        // Paksa selesai jika waktu habis saat offline/background
                        if (appState.currentMission) {
                            appState.missions[appState.currentMission].forEach(q => {
                                if (!appState.scores[appState.currentMission][q.id].completed) {
                                    appState.scores[appState.currentMission][q.id].completed = true;
                                    appState.scores[appState.currentMission][q.id].score = 0;
                                }
                            });
                        }
                        appState.screen = 'finished'; // Langsung ke final
                    } else if (appState.screen === 'inMission') {
                         appState.isCheatingListenerActive = true; 
                    }
                    
                    missionActiveStartTimestamp = Date.now();
                } else {
                    missionActiveStartTimestamp = null;
                }

                if (loadedData.scores) {
                    for (const missionName in loadedData.scores) {
                        if (missionData[missionName]) {
                             Object.keys(loadedData.scores[missionName]).forEach(qId => {
                                 if (appState.scores[missionName] && appState.scores[missionName][qId]) {
                                     Object.assign(appState.scores[missionName][qId], loadedData.scores[missionName][qId]);
                                 }
                             });
                        }
                    }
                }
                
                // Pemulihan input profil (untuk tampilan)
                if (userInfo.nama) {
                    document.getElementById('nama-input').value = userInfo.nama;
                    document.getElementById('jurusan-input').value = userInfo.jurusan;
                    document.getElementById('kelas-input').value = userInfo.kelas;
                    checkProfileInputs(); 
                }

                console.log('State berhasil dimuat dari LocalStorage.');
                
                updateAppScreen(); 
                
                return true;
            } catch (e) {
                console.error('Kesalahan memuat state, memulai sesi baru:', e);
                localStorage.removeItem(STORAGE_KEY);
                return false;
            }
        }
        
        const showModal = (title, body, onClose = null) => {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').textContent = body;
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modal').classList.add('flex');
            modalCloseCallback = onClose;
        }

        const trackInputChanges = () => {
            if (!appState.currentMission || !appState.currentQuestionId) return;

            const missionQuestions = appState.missions[appState.currentMission];
            const q = missionQuestions.find(item => item.id === appState.currentQuestionId);

            if (!q) return;

            const qState = appState.scores[appState.currentMission][q.id];
            
            if (qState.completed) return; 

            const inputArea = document.getElementById('question-input-area');
            let currentAnswer = null;

            if (q.type === 'narrative_mc' || q.type === 'multiple_choice' || q.type === 'true_false') {
                const selectedButton = inputArea.querySelector('.option-button.bg-red-600');
                if (selectedButton) {
                    currentAnswer = selectedButton.getAttribute('data-value');
                }
            } else if (q.type === 'multiple_correct') {
                currentAnswer = Array.from(inputArea.querySelectorAll('input[name="multicorrect"]:checked')).map(cb => cb.value);
            } else if (q.type === 'matching') {
                currentAnswer = Array.from(inputArea.querySelectorAll('select')).map(select => select.value);
            } else if (q.type === 'essay') {
                const textarea = document.getElementById('essay-answer');
                currentAnswer = textarea ? textarea.value : '';
            } else if (q.type === 'grid_tf') { 
                const selections = {};
                inputArea.querySelectorAll('.grid-row').forEach(row => {
                    const itemId = row.getAttribute('data-id');
                    const selectedBtn = row.querySelector('.grid-option-btn.bg-red-600');
                    selections[itemId] = selectedBtn ? selectedBtn.getAttribute('data-value') : null;
                });
                currentAnswer = selections;
            }

            qState.currentAnswer = currentAnswer;
            saveAppState();
        }

        // FUNGSI PENGACAKAN
        const shuffleArray = (array) => {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // FUNGSI INI DIUBAH UNTUK MENGACAK URUTAN SOAL DAN OPSI JAWABAN SAAT START
        const initGameData = () => {
            const missionName = Object.keys(missionData)[0]; // Hanya satu misi

            let originalQuestions = missionData[missionName];
            
            // 1. Acak urutan soal Misi
            let shuffledQuestions = shuffleArray(originalQuestions);

            // 2. Pastikan Essay (q40_essay) selalu di akhir
            const essayQuestion = shuffledQuestions.find(q => q.type === 'essay');
            if (essayQuestion) {
                 shuffledQuestions = shuffledQuestions.filter(q => q.type !== 'essay');
                 shuffledQuestions.push(essayQuestion);
            }

            // 3. Pastikan Narrative MC (q3_narrative) selalu di awal (jika ada) - tidak ada di data baru, tapi jaga logika
            const narrativeQuestion = shuffledQuestions.find(q => q.type === 'narrative_mc');
            if (narrativeQuestion) {
                 shuffledQuestions = shuffledQuestions.filter(q => q.type !== 'narrative_mc');
                 shuffledQuestions.unshift(narrativeQuestion);
            }


            appState.missions[missionName] = [];
            appState.scores[missionName] = {}; 

            shuffledQuestions.forEach(q => {
                if (appState.missions[missionName].length >= MAX_QUESTIONS) return;

                q.missionName = missionName;
                appState.missions[missionName].push(q);
                
                appState.scores[missionName][q.id] = { 
                    score: 0, 
                    completed: false, 
                    skipped: false, 
                    isConsulted: false,
                    shuffledOptions: [], 
                    shuffledMatches: [],
                    currentAnswer: q.type === 'grid_tf' ? {} : null, 
                };
                
                const qState = appState.scores[missionName][q.id];

                // Acak Opsi Jawaban
                if (q.type === 'narrative_mc' || q.type === 'multiple_choice' || q.type === 'true_false' || q.type === 'multiple_correct') {
                    let options = (q.type === 'true_false') ? ["Benar", "Salah"] : (q.options ? [...q.options] : []);
                    if (options.length > 0 && q.type !== 'true_false') {
                         qState.shuffledOptions = shuffleArray(options);
                    } else {
                        qState.shuffledOptions = options;
                    }
                }

                if (q.type === 'matching') {
                    const targets = q.matches.map(m => m.target);
                    qState.shuffledMatches = shuffleArray(targets);
                }
            });
        }
        
        const renderQuestionNavigation = (missionQ) => {
            const navContainer = document.getElementById('question-navigation');
            navContainer.innerHTML = '';
            
            // Menggunakan missionQ yang sudah terpotong (hanya 40 soal)
            missionQ.forEach((q, index) => {
                const qState = appState.scores[appState.currentMission][q.id];
                const btn = document.createElement('button');
                
                let bgColor = 'bg-gray-600 text-gray-300'; 
                if (q.id === appState.currentQuestionId) {
                    bgColor = 'bg-red-500 text-white shadow-lg'; 
                } else if (qState.completed) {
                    bgColor = 'bg-green-500 text-white'; 
                } else if (qState.skipped && !qState.completed) {
                    bgColor = 'bg-yellow-500 text-gray-900'; 
                }

                btn.className = `w-10 h-10 rounded-full font-bold transition duration-150 transform hover:scale-110 ${bgColor}`;
                btn.textContent = index + 1;
                btn.onclick = () => goToQuestion(q.id);
                
                navContainer.appendChild(btn);
            });
        }

        const getExpertHint = (q) => {
            // New hints for Biaya Produksi & BEP
            if (q.id.startsWith('q1')) return `Ingat, Biaya Tetap (FC) tidak terpengaruh jumlah produksi (misal: sewa, gaji tetap), sedangkan Biaya Variabel (VC) berubah (misal: bahan baku, komisi).`;
            if (q.id.startsWith('q2')) return `BEP adalah titik nol, bukan maksimal.`;
            if (q.id.startsWith('q3')) return `Biaya bahan baku akan naik jika produksi naik.`;
            if (q.id.startsWith('q4')) return `Gaji manajer tetap sama, tidak peduli berapa banyak yang diproduksi.`;
            if (q.id.startsWith('q5')) return `BEP adalah titik impas. Apa yang terjadi di titik impas?`;
            if (q.id.startsWith('q6')) return `Margin kontribusi harus menutup biaya apa?`;
            if (q.id.startsWith('q7')) return `BEP unit adalah minimum yang harus dijual.`;
            if (q.id.startsWith('q8')) return `Cari biaya yang jumlah totalnya tetap, bukan yang berubah karena penjualan.`;
            if (q.id.startsWith('q9')) return `Cocokkan istilah dengan definisinya yang paling inti.`;
            if (q.id.startsWith('q10')) return `Margin Kontribusi adalah 'uang saku' per unit untuk menutup FC.`;
            if (q.id.startsWith('q11')) return `Rumus BEP Unit: FC / Margin Kontribusi Unit.`;
            if (q.id.startsWith('q12')) return `BEP Rupiah menggunakan rasio, bukan nilai unit.`;
            if (q.id.startsWith('q13')) return `Apa dua elemen utama dari total biaya?`;
            if (q.id.startsWith('q14')) return `Total Cost selalu sama dengan FC + VC.`;
            if (q.id.startsWith('q15')) return `Gaji administrasi (FC), komisi (VC), penyusutan (FC).`;
            if (q.id.startsWith('q16')) return `Rasio selalu membandingkan sebagian (Margin Kontribusi) terhadap keseluruhan (Harga Jual).`;
            if (q.id.startsWith('q17')) return `Pemisahan FC dan VC adalah kunci analisis BEP.`;
            if (q.id.startsWith('q18')) return `BEP naik jika Biaya naik atau Harga Jual turun.`;
            if (q.id.startsWith('q19')) return `Pasangkan rumus aljabar dasar.`;
            if (q.id.startsWith('q20')) return `Tergantung kontrak; biasanya variabel (berdasarkan jam/unit) atau semi-variabel. Dalam konteks umum produksi, seringnya variabel.`;
            if (q.id.startsWith('q21')) return `Margin Kontribusi: 20.000 - 12.000 = 8.000. BEP: 3.000.000 / 8.000 = 375.`;
            if (q.id.startsWith('q22')) return `Di bawah BEP berarti rugi. Harus meningkatkan apa yang menghasilkan pendapatan.`;
            if (q.id.startsWith('q23')) return `MCR = (P - VC) / P. Jika P dan VC naik persentase yang sama, rasio akan tetap.`;
            if (q.id.startsWith('q24')) return `MoS adalah zona aman antara penjualan saat ini dan BEP.`;
            if (q.id.startsWith('q25')) return `Cari kombinasi yang membuat pembilang (FC) turun atau penyebut (MCU) naik.`;
            if (q.id.startsWith('q26')) return `Unit untuk volume, Rupiah untuk nilai uang, Rasio untuk analisis perubahan.`;
            if (q.id.startsWith('q27')) return `Rumus Target Laba Unit: (FC + Target Laba) / MCU.`;
            if (q.id.startsWith('q28')) return `Asumsi stabilitas adalah batasan penting dalam analisis BEP dasar.`;
            if (q.id.startsWith('q29')) return `Kedua variabel ini mendefinisikan Margin Kontribusi.`;
            if (q.id.startsWith('q30')) return `MCU = Harga Jual dikurangi Biaya yang berubah per unit.`;
            if (q.id.startsWith('q31')) return `MoS Unit = Penjualan Aktual Unit - BEP Unit.`;
            if (q.id.startsWith('q32')) return `BEP Naik jika FC naik atau MCU turun.`;
            if (q.id.startsWith('q33')) return `BEP Rupiah = FC / MCR. (20.000.000 / 0.4).`;
            if (q.id.startsWith('q34')) return `BEP = FC / MCU. Keduanya berubah, perlu analisis perbandingan.`;
            if (q.id.startsWith('q35')) return `VC per unit tetap, tetapi Total VC berbanding lurus dengan kuantitas.`;
            if (q.id.startsWith('q36')) return `P adalah Price (Harga Jual).`;
            if (q.id.startsWith('q37')) return `Kenaikan Harga Jual menaikkan MCU. Kenaikan FC menaikkan pembilang. Sulit menentukan tanpa angka, tetapi peningkatan FC lebih kuat menaikkan BEP.`;
            if (q.id.startsWith('q38')) return `FC di atas (pembilang), MCU di bawah (penyebut).`;
            if (q.id.startsWith('q39')) return `Ya, ini adalah asumsi dasar BEP.`;
            if (q.id.startsWith('q40')) return `BEP Rupiah penting untuk perencanaan keuangan, MoS untuk manajemen risiko.`;
            
            return `Maaf, keterangan ahli tidak dapat ditemukan untuk soal ini.`;
        }

        // FUNGSI BARU UNTUK MENGAMBIL JAWABAN ESAI DARI STATE
        const getEssayAnswer = (missionName, questionId) => {
            const scoreData = appState.scores[missionName]?.[questionId];
            return (scoreData && typeof scoreData.currentAnswer === 'string') ? scoreData.currentAnswer.replace(/\n/g, ' ') : '- Belum Dijawab -';
        };
        
        // NEW UTILITY FUNCTION: Hitung Total Konsultasi Ahli
        const calculateTotalConsultations = () => {
            let count = 0;
            const missionName = appState.currentMission;
            const scores = appState.scores[missionName];
            if (scores) {
                for (const qId in scores) {
                    if (scores[qId].isConsulted) {
                        count++;
                    }
                }
            }
            return count;
        };


        const renderMissionState = () => {
            if (!appState.currentMission || !appState.currentQuestionId) {
                // Di sini, kita akan menganggap QUIZ SELESAI jika tidak ada currentQuestionId
                if (Object.values(appState.scores[appState.currentMission] || {}).filter(q => q.completed).length === MAX_QUESTIONS) {
                    return finishQuiz();
                }
                return; 
            }
            
            const missionQ = appState.missions[appState.currentMission];
            const currentQ = missionQ.find(q => q.id === appState.currentQuestionId);
            const currentQState = appState.scores[appState.currentMission][appState.currentQuestionId];
            
            const isAudioQuestion = currentQ.type === 'narrative_mc';
            const isCompleted = currentQState.completed;
            const currentMissionScore = calculateMissionScore(appState.currentMission);
            const currentQuestionIndex = missionQ.findIndex(q => q.id === currentQ.id) + 1;


            document.getElementById('user-name-display').textContent = `${userInfo.nama} (${userInfo.kelas} ${userInfo.jurusan})`;
            // Update skor total game
            document.getElementById('mission-current-score').textContent = currentMissionScore.toFixed(2); // Menampilkan dua desimal
            // Update Title (tetap statis di quiz tunggal)
            document.getElementById('mission-title').textContent = `Soal ${currentQuestionIndex}/${MAX_QUESTIONS} - Biaya Produksi & BEP`;
            
            // Perbarui tampilan waktu saat rendering state misi
            const timeRemaining = MISSION_TIME_LIMIT_SECONDS - appState.missionElapsedTime;
            const timeDisplay = document.getElementById('mission-time-display');
            timeDisplay.textContent = formatTime(timeRemaining);
            timeDisplay.classList.toggle('time-critical', timeRemaining <= 120);

            document.getElementById('question-type-display').textContent = `Tipe Soal: ${currentQ.type.toUpperCase().replace('_', ' ')}`;
            
            const difficultyDisplay = document.getElementById('question-difficulty');
            difficultyDisplay.textContent = `Kesulitan: ${currentQ.difficulty}`;
            
            if (currentQ.difficulty === 'MUDAH') difficultyDisplay.className = 'font-bold text-green-400';
            else if (currentQ.difficulty === 'SEDANG') difficultyDisplay.className = 'font-bold text-yellow-400';
            else if (currentQ.difficulty === 'SULIT') difficultyDisplay.className = 'font-bold text-orange-400';
            else if (currentQ.difficulty === 'HOTS') difficultyDisplay.className = 'font-bold text-red-500';


            const questionTextElement = document.getElementById('question-text');
            if (currentQ.type === 'grid_tf' && currentQ.question.includes('Narasi:')) {
                const parts = currentQ.question.split('\n\n');
                questionTextElement.textContent = parts[0]; 
                questionTextElement.classList.remove('italic', 'text-red-400', 'text-2xl', 'text-white');
                questionTextElement.classList.add('text-base', 'font-normal', 'text-gray-200'); 
            } else if (isAudioQuestion) {
                 questionTextElement.textContent = "Dengarkan narasi soal dari tombol audio di atas, lalu pilih jawaban di bawah.";
                 questionTextElement.classList.add('italic', 'text-red-400', 'text-xl');
                 questionTextElement.classList.remove('text-2xl', 'text-white', 'text-base', 'font-normal', 'text-gray-200');
            } else {
                 questionTextElement.textContent = currentQ.question;
                 questionTextElement.classList.remove('italic', 'text-red-400', 'text-base', 'font-normal', 'text-gray-200');
                 questionTextElement.classList.add('text-2xl', 'text-white');
            }
            
            document.getElementById('feedback-message').textContent = '';

            renderQuestionNavigation(missionQ); 
            renderQuestionInput(currentQ, currentQState); 

            // Tombol "Selesaikan Quiz" muncul jika semua soal selesai
            document.getElementById('finish-mission-btn').classList.toggle('hidden', Object.values(appState.scores[appState.currentMission]).filter(q => q.completed).length !== MAX_QUESTIONS);

            // Tombol Audio dihilangkan/dikelola
            document.getElementById('play-audio-btn').classList.add('hidden');
            
            // Tombol Jawab dan Lewati
            document.getElementById('submit-answer-btn').classList.toggle('hidden', isCompleted);
            document.getElementById('skip-btn').classList.toggle('hidden', isCompleted);
            document.getElementById('consult-expert-btn').classList.add('hidden'); 

            document.getElementById('submit-answer-btn').disabled = isCompleted;
            document.getElementById('skip-btn').disabled = isCompleted; 

            if (isCompleted) {
                document.getElementById('feedback-message').textContent = `Soal Selesai. Skor: ${currentQState.score.toFixed(2)}`;
                document.getElementById('feedback-message').classList.remove('text-red-400', 'text-yellow-500', 'text-orange-400');
                document.getElementById('feedback-message').classList.add('text-green-400');
            } else if (!isCompleted && currentQState.isConsulted) {
                document.getElementById('submit-answer-btn').classList.remove('hidden');
                document.getElementById('skip-btn').classList.remove('hidden');
                document.getElementById('submit-answer-btn').disabled = false;
                document.getElementById('skip-btn').disabled = false;
                document.getElementById('feedback-message').textContent = `Anda menggunakan Bantuan Ahli (Max ${CONSULT_HINT_SCORE} Poin). Pilih Jawaban Anda.`;
                document.getElementById('feedback-message').classList.add('text-orange-400');
            } else if (!isCompleted && currentQState.currentAnswer !== null) {
                document.getElementById('submit-answer-btn').classList.remove('hidden');
                document.getElementById('skip-btn').classList.remove('hidden');
                document.getElementById('submit-answer-btn').disabled = false;
                document.getElementById('skip-btn').disabled = false;
            }
        }
        
        const renderQuestionInput = (q, qState) => {
            const inputArea = document.getElementById('question-input-area');
            inputArea.innerHTML = '';
            inputArea.dataset.type = q.type;

            if (q.type === 'narrative_mc' || q.type === 'multiple_choice' || q.type === 'true_false') {
                const options = qState.shuffledOptions.length > 0 ? qState.shuffledOptions : (q.options || ["Benar", "Salah"]);
                
                options.forEach((option) => {
                    const btn = document.createElement('button');
                    btn.textContent = option;
                    
                    let btnClass = 'bg-gray-800 hover:bg-gray-600 text-white';
                    
                    if (qState.completed) {
                        const isAnswer = (q.type === 'true_false') 
                            ? (option === 'Benar' ? true : false) === q.answer 
                            : (option === q.answer);
                        
                        if (isAnswer) {
                            btnClass = 'bg-green-700 text-white border-green-500';
                        } else if (option === qState.currentAnswer) { 
                            btnClass = 'bg-red-900 text-red-300 border-red-500';
                        } else {
                            btnClass = 'bg-gray-800', 'text-gray-400';
                        }
                    } else if (qState.currentAnswer === option) { 
                        btnClass = 'bg-red-600 border-red-500';
                    }

                    btn.className = `option-button w-full text-left p-3 rounded-lg border border-gray-600 ${btnClass} shadow-md`;
                    btn.setAttribute('data-value', option);
                    btn.onclick = () => { selectOption(btn); trackInputChanges(); }; 
                    btn.disabled = qState.completed;
                    inputArea.appendChild(btn);
                });
                
            } else if (q.type === 'multiple_correct') {
                const currentAnswerArray = qState.currentAnswer || []; 
                const options = qState.shuffledOptions.length > 0 ? qState.shuffledOptions : q.options;

                options.forEach((option) => {
                    const isCorrect = q.correctAnswers.includes(option);
                    let labelClass = 'bg-gray-800 hover:bg-gray-600';
                    
                    if (qState.completed && isCorrect) {
                        labelClass = 'bg-green-700/50 hover:bg-green-700/50';
                    } else if (qState.completed && currentAnswerArray.includes(option) && !isCorrect) {
                         labelClass = 'bg-red-900/50 hover:bg-red-900/50'; 
                    } else if (qState.completed) {
                        labelClass = 'bg-gray-700';
                    }

                    const label = document.createElement('label');
                    label.className = `flex items-center p-3 rounded-lg border border-gray-600 shadow-md transition duration-150 ${labelClass}`;
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.name = 'multicorrect';
                    checkbox.value = option;
                    checkbox.checked = currentAnswerArray.includes(option); 
                    checkbox.className = 'w-5 h-5 text-red-500 border-gray-600 rounded focus:ring-red-500 bg-gray-700';
                    checkbox.disabled = qState.completed;
                    
                    checkbox.onchange = trackInputChanges; 

                    const span = document.createElement('span');
                    span.textContent = option;
                    span.className = 'ml-3 text-gray-200';
                    if (qState.completed && isCorrect) {
                        span.textContent += ' (BENAR)';
                    } else if (qState.completed && currentAnswerArray.includes(option) && !isCorrect) {
                        span.textContent += ' (SALAH)';
                    }

                    label.appendChild(checkbox);
                    label.appendChild(span);
                    inputArea.appendChild(label);
                });
                
            } else if (q.type === 'matching') {
                const shuffledTargets = qState.shuffledMatches || q.matches.map(m => m.target); 
                const currentAnswerArray = qState.currentAnswer || []; 
                
                q.matches.forEach((match, index) => {
                    const matchDiv = document.createElement('div');
                    matchDiv.className = 'flex flex-col md:flex-row items-center justify-between p-3 border-b border-gray-600';
                    
                    const promptText = document.createElement('span');
                    promptText.textContent = match.prompt;
                    promptText.className = 'font-medium text-gray-300 w-full md:w-1/2 mb-2 md:mb-0';
                    
                    const select = document.createElement('select');
                    select.name = `matching-${index}`;
                    select.className = 'w-full md:w-1/2 p-2 border border-gray-600 rounded-lg bg-gray-700 text-white focus:ring-red-500 focus:border-red-500';
                    select.disabled = qState.completed;
                    select.onchange = trackInputChanges; 

                    const defaultOption = document.createElement('option');
                    defaultOption.textContent = '-- Pilih Pasangan --';
                    defaultOption.value = '';
                    select.appendChild(defaultOption);

                    shuffledTargets.forEach(target => {
                        const option = document.createElement('option');
                        option.textContent = target;
                        option.value = target;
                        
                        let isUsersAnswer = false;
                        if (!qState.completed && currentAnswerArray[index] === target) {
                            isUsersAnswer = true;
                        }
                        
                        if (qState.completed && target === match.target) {
                             option.selected = true;
                             option.classList.add('bg-green-700', 'text-white');
                        } else if (isUsersAnswer) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                    
                    matchDiv.appendChild(promptText);
                    matchDiv.appendChild(select);
                    inputArea.appendChild(matchDiv);
                });
                
            } else if (q.type === 'essay') {
                const textarea = document.createElement('textarea');
                textarea.id = 'essay-answer';
                textarea.rows = 6;
                textarea.placeholder = `Tuliskan jawaban Anda di sini. Jawaban minimal ${q.minWords} kata. Soal HOTS ini memerlukan analisis mendalam.`;
                textarea.className = 'w-full p-3 border border-gray-600 rounded-lg focus:ring-red-500 focus:border-red-500 bg-gray-700 text-white';
                textarea.disabled = qState.completed;
                textarea.value = qState.currentAnswer || ''; 
                textarea.addEventListener('input', trackInputChanges); 
                inputArea.appendChild(textarea);
                
                const wordCount = document.createElement('p');
                wordCount.id = 'word-count';
                wordCount.className = 'text-sm text-gray-400 mt-2';

                const initialWordCount = textarea.value.trim() ? textarea.value.trim().split(/\s+/).filter(word => word.length > 0).length : 0;
                wordCount.textContent = `${initialWordCount} / ${q.minWords} Kata`;
                wordCount.classList.toggle('text-red-400', initialWordCount < q.minWords);
                wordCount.classList.toggle('text-green-400', initialWordCount >= q.minWords);


                textarea.addEventListener('input', () => {
                    const text = textarea.value.trim();
                    const words = text ? text.split(/\s+/).filter(word => word.length > 0) : [];
                    wordCount.textContent = `${words.length} / ${q.minWords} Kata`;
                    wordCount.classList.toggle('text-red-400', words.length < q.minWords);
                    wordCount.classList.toggle('text-green-400', words.length >= q.minWords);
                });
                
                inputArea.appendChild(wordCount); 

                if (qState.completed) {
                    const scoreDisplay = document.createElement('div');
                    scoreDisplay.className = 'mt-4 p-3 bg-red-800 rounded-lg text-sm';
                    scoreDisplay.textContent = `Jawaban Esai Dicatat. Skor: ${qState.score.toFixed(2)} Poin.`;
                    inputArea.appendChild(scoreDisplay);
                }
            } else if (q.type === 'grid_tf') { 
                const instruction = q.question.split('\n\n').pop();
                
                const instructionEl = document.createElement('p');
                instructionEl.className = 'text-base font-semibold text-gray-300 mb-3';
                instructionEl.textContent = instruction;
                inputArea.appendChild(instructionEl);

                const table = document.createElement('div');
                table.className = 'w-full border border-gray-600 rounded-lg overflow-hidden';
                
                const header = document.createElement('div');
                header.className = 'grid grid-cols-3 bg-red-900/70 font-extrabold text-sm border-b border-red-700';
                header.innerHTML = `
                    <div class="p-3 text-red-300">Pernyataan</div>
                    <div class="p-3 text-center text-green-300 border-l border-red-700">Benar</div>
                    <div class="p-3 text-center text-red-300 border-l border-red-700">Salah</div>
                `;
                table.appendChild(header);

                const currentSelections = qState.currentAnswer || {};

                q.gridItems.forEach((item, index) => {
                    const row = document.createElement('div');
                    row.className = 'grid grid-cols-3 items-center border-b border-gray-700 last:border-b-0 grid-row';
                    row.setAttribute('data-id', index);

                    const textDiv = document.createElement('div');
                    textDiv.className = 'p-3 text-sm text-gray-200';
                    textDiv.textContent = item.text;
                    row.appendChild(textDiv);

                    ['true', 'false'].forEach((value, colIndex) => {
                        const btnContainer = document.createElement('div');
                        btnContainer.className = `p-2 flex justify-center border-l border-gray-700`;

                        const btn = document.createElement('button');
                        btn.className = `grid-option-btn w-16`;
                        btn.setAttribute('data-value', value);
                        btn.textContent = value === 'true' ? 'B' : 'S'; 

                        const isSelected = currentSelections[index] === value;
                        const isCorrect = item.answer === (value === 'true');

                        if (qState.completed) {
                            btn.disabled = true;
                            if (isCorrect) {
                                btn.classList.add('bg-green-700', 'text-white', 'opacity-100');
                            } else if (isSelected && !isCorrect) {
                                btn.classList.add('bg-red-800', 'text-red-300', 'opacity-100');
                            } else {
                                btn.classList.add('bg-gray-800', 'text-gray-500');
                            }
                        } else {
                            btn.disabled = false;
                            if (isSelected) {
                                btn.classList.add('bg-red-600', 'text-white');
                            } else {
                                btn.classList.add('bg-gray-800', 'hover:bg-gray-600', 'text-white');
                            }
                            
                            btn.onclick = () => selectGridOption(row, value);
                        }

                        btnContainer.appendChild(btn);
                        row.appendChild(btnContainer);
                    });

                    table.appendChild(row);
                });

                inputArea.appendChild(table);
            }
        }
        
        const selectGridOption = (rowElement, value) => {
            triggerHaptics(20);
            rowElement.querySelectorAll('.grid-option-btn').forEach(btn => {
                btn.classList.remove('bg-red-600', 'text-white');
                btn.classList.add('bg-gray-800', 'text-white');
            });

            const selectedBtn = rowElement.querySelector(`[data-value="${value}"]`);
            selectedBtn.classList.remove('bg-gray-800');
            selectedBtn.classList.add('bg-red-600', 'text-white');
            
            trackInputChanges();
        }

        const selectOption = (button) => {
            triggerHaptics(20);
            const inputArea = document.getElementById('question-input-area');
            inputArea.querySelectorAll('.option-button').forEach(btn => {
                btn.classList.remove('bg-red-600', 'border-red-500'); 
            });
            button.classList.add('bg-red-600', 'border-red-500'); 
            trackInputChanges();
        }

        const goToQuestion = (questionId) => {
            if (appState.screen === 'penalty') {
                appState.screen = 'inMission';
                updateAppScreen(); 
            }
            
            stopCurrentAudio(); 
            stopMissionTimer(); 
            startMissionTimer();
            
            triggerHaptics(50);
            appState.currentQuestionId = questionId;
            renderMissionState();
            document.getElementById('in-mission-screen').scrollIntoView({ behavior: 'smooth' });
            saveAppState();
        }

        const navigateToNextQuestion = () => {
            stopMissionTimer(); 
            startMissionTimer();

            const missionQ = appState.missions[appState.currentMission];
            const currentIndex = missionQ.findIndex(q => q.id === appState.currentQuestionId);

            
            let nextQ = missionQ.slice(currentIndex + 1).find(q => !appState.scores[appState.currentMission][q.id].completed);

            if (!nextQ) {
                nextQ = missionQ.slice(0, currentIndex).find(q => !appState.scores[appState.currentMission][q.id].completed);
            }
            
            if (nextQ) {
                goToQuestion(nextQ.id);
            } else {
                 finishQuiz();
            }
            saveAppState();
        }
        
        const handleConsultExpert = () => {
            triggerHaptics(200);
            stopCurrentAudio();

            const missionQuestions = appState.missions[appState.currentMission];
            const q = missionQuestions.find(item => item.id === appState.currentQuestionId);
            const qState = appState.scores[appState.currentMission][q.id];

            qState.isConsulted = true; 
            
            const expertHint = getExpertHint(q);

            showModal('Bantuan Ahli (Konsekuensi: Max 5 Poin)', 
                        `Anda memilih menggunakan bantuan ahli. Skor maksimal untuk soal ini sekarang adalah ${CONSULT_HINT_SCORE} poin. \n\nKeterangan Ahli: ${expertHint}`, 
                        () => {
                                 document.getElementById('submit-answer-btn').disabled = false;
                                 document.getElementById('skip-btn').disabled = false;
                                 document.getElementById('play-audio-btn').disabled = false;
                                 document.getElementById('consult-expert-btn').classList.add('hidden');
                                 renderMissionState();
                                 saveAppState();
                            }
            );

            document.getElementById('submit-answer-btn').disabled = true;
            document.getElementById('skip-btn').disabled = true;
            document.getElementById('play-audio-btn').disabled = true;
            document.getElementById('consult-expert-btn').classList.add('hidden');
            saveAppState();
        }

        // --- FUNGSI BARU: Penilaian Esai Otomatis menggunakan Gemini API ---
        const gradeEssay = async (questionText, userAnswer, maxScore) => {
            const apiKey = TTS_API_KEY;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const systemPrompt = `Anda adalah Ahli Kewirausahaan dan Analisis BEP. Nilai esai dari 0 sampai ${maxScore}. Kriteria: 1. Akurasi Materi (Relevansi konsep BEP/Biaya). 2. Kejelasan Struktur Kalimat. 3. Analisis Kritis (Kedalaman interpretasi strategis). Berikan skor berdasarkan ketiga kriteria ini secara seimbang. Jawab HANYA dalam format JSON.`;

            const userQuery = `Pertanyaan: "${questionText}"\n\nJawaban Siswa: "${userAnswer}"\n\nBeri skor dan feedback (maksimal 3 kalimat).`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "score": { "type": "NUMBER", "description": "Skor yang diberikan, dari 0 hingga maksimal." },
                            "feedback": { "type": "STRING", "description": "Ulasan detail dan konstruktif tentang jawaban siswa." }
                        },
                        required: ["score", "feedback"]
                    }
                }
            };

            let lastDelay = 1000;
            const maxRetries = 3;

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), GRADING_TIMEOUT_MS);

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                        signal: controller.signal 
                    });

                    clearTimeout(timeoutId);

                    if (response.ok) {
                        const result = await response.json();
                        const jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (jsonText) {
                            const parsed = JSON.parse(jsonText);
                            parsed.score = Math.min(Math.round(parsed.score), maxScore);
                            return parsed;
                        }
                    }
                    
                    if (response.status === 429 || response.status >= 500) {
                        if (attempt < maxRetries - 1) {
                            await new Promise(resolve => setTimeout(resolve, lastDelay));
                            lastDelay *= 2;
                            continue; 
                        }
                        throw new Error(`Server error (${response.status}) setelah percobaan maksimum.`);
                    } else {
                         const errorResult = await response.json().catch(() => ({}));
                         throw new Error(`Panggilan API gagal: ${response.status}. Detail: ${JSON.stringify(errorResult)}`);
                    }

                } catch (error) {
                    clearTimeout(timeoutId);
                    
                    if (error.name === 'AbortError' || error.message.includes('fetch failed') || error.message.includes('Server error')) {
                         if (attempt < maxRetries - 1) {
                            console.warn(`[AI Grade] Timeout/Network error. Mencoba ulang dalam ${lastDelay}ms...`);
                            await new Promise(resolve => setTimeout(resolve, lastDelay));
                            lastDelay *= 2;
                            continue;
                         }
                    }

                    console.error("AI Grading Error (Final):", error);
                    return { score: 0, feedback: `Penilaian otomatis gagal total: ${error.message}. Skor 0 diberikan.` };
                }
            }
            return { score: 0, feedback: "Penilaian otomatis gagal total setelah beberapa kali percobaan. Skor 0 diberikan." };
        };
        // --- END FUNGSI GRADE ESSAY ---

        const handleSubmit = async () => { 
            triggerHaptics(100);
            stopCurrentAudio(); 
            
            const missionQuestions = appState.missions[appState.currentMission];
            const q = missionQuestions.find(item => item.id === appState.currentQuestionId);
            
            if (!q) {
                return showModal('Kesalahan', 'Soal tidak ditemukan. Mohon ulangi dari menu quiz.');
            }
            
            const qState = appState.scores[appState.currentMission][q.id];
            
            let score = 0;
            let feedback = '';
            let isCorrect = false;

            const maxScoreForQuestion = qState.isConsulted ? CONSULT_HINT_SCORE : q.points;

            trackInputChanges();

            if (q.type === 'essay') {
                const text = qState.currentAnswer || ''; 
                const wordCount = text ? text.split(/\s+/).filter(word => word.length > 0).length : 0;
                
                if (wordCount < q.minWords) {
                    showModal('Peringatan', `Jawaban esai Anda harus minimal ${q.minWords} kata. Kata saat ini: ${wordCount}.`);
                    return;
                }
                
                document.getElementById('feedback-message').innerHTML = '<div class="w-5 h-5 border-2 border-yellow-400 border-t-yellow-900 rounded-full animate-spin inline-block mr-2"></div> Menilai Esai Otomatis...';
                document.getElementById('feedback-message').classList.remove('text-red-400', 'text-green-400');
                document.getElementById('feedback-message').classList.add('text-yellow-400');
                document.getElementById('submit-answer-btn').disabled = true;

                const aiResult = await gradeEssay(q.question, text, maxScoreForQuestion);
                
                score = aiResult.score; 
                feedback = aiResult.feedback;
                
                let finalFeedback = `Penilaian AI (${score.toFixed(2)} Poin): ${aiResult.feedback}`;

                isCorrect = (score === maxScoreForQuestion); 
                
                appState.scores[appState.currentMission][q.id].score = score;
                appState.scores[appState.currentMission][q.id].completed = true;
                appState.scores[appState.currentMission][q.id].skipped = false;
                appState.scores[appState.currentMission][q.id].currentAnswer = qState.currentAnswer; 

                renderQuestionInput(q, appState.scores[appState.currentMission][q.id]);
                
                navigateToNextQuestion();
                
                document.getElementById('feedback-message').textContent = finalFeedback;
                document.getElementById('feedback-message').classList.toggle('text-green-400', isCorrect);
                document.getElementById('feedback-message').classList.toggle('text-red-400', !isCorrect && score === 0);
                document.getElementById('feedback-message').classList.remove('text-yellow-400', 'text-orange-400');
                document.getElementById('feedback-message').classList.toggle('text-orange-400', score > 0 && score < maxScoreForQuestion);
                document.getElementById('submit-answer-btn').disabled = false; 
                saveAppState();
                return; 

            } else if (q.type === 'grid_tf') { 
                const userSelections = qState.currentAnswer || {};
                const totalItems = q.gridItems.length;
                let correctCount = 0;

                const allAnswered = totalItems > 0 && Object.keys(userSelections).length === totalItems && Object.values(userSelections).every(v => v !== null);

                if (!allAnswered) {
                    showModal('Peringatan', 'Mohon lengkapi jawaban Benar/Salah untuk semua pernyataan di tabel.');
                    return;
                }

                q.gridItems.forEach((item, index) => {
                    const userAnswerValue = userSelections[index];
                    const correctAnswerValue = item.answer ? 'true' : 'false';
                    if (userAnswerValue === correctAnswerValue) {
                        correctCount++;
                    }
                });

                // Menggunakan pembulatan 2 desimal agar tetap 40 soal * 2.5 = 100
                score = (correctCount / totalItems) * maxScoreForQuestion;
                isCorrect = (correctCount === totalItems);
                
            } else { 
                let userAnswer = qState.currentAnswer;

                if (q.type === 'narrative_mc' || q.type === 'multiple_choice' || q.type === 'true_false') {
                    if (!userAnswer) {
                        showModal('Peringatan', 'Pilih salah satu jawaban terlebih dahulu.');
                        return;
                    }
                    isCorrect = (q.type === 'true_false') ? (userAnswer === 'Benar' ? true : false) === q.answer : (userAnswer === q.answer);
                    score = isCorrect ? maxScoreForQuestion : 0;
                    
                } else if (q.type === 'multiple_correct') {
                    const checkedBoxes = userAnswer || [];
                    const correctAnswers = q.correctAnswers;
                    const correctlySelected = checkedBoxes.filter(val => correctAnswers.includes(val)).length;
                    const incorrectlySelected = checkedBoxes.filter(val => !correctAnswers.includes(val)).length;
                    
                    if (correctAnswers.length > 0) {
                        if (incorrectlySelected === 0 && correctlySelected === correctAnswers.length) {
                            score = maxScoreForQuestion; isCorrect = true;
                        } else if (incorrectlySelected === 0 && correctlySelected > 0) {
                            const ratio = (correctlySelected / correctAnswers.length);
                            score = ratio * maxScoreForQuestion; // Menggunakan skor desimal
                            isCorrect = false;
                        } else { score = 0; isCorrect = false; }
                    }

                } else if (q.type === 'matching') {
                    const selectedTargets = userAnswer || [];
                    if (selectedTargets.some(s => s === '' || s === undefined || s === null)) {
                        showModal('Peringatan', 'Mohon lengkapi semua pasangan pencocokan terlebih dahulu.');
                        return;
                    }
                    let correctMatches = 0;
                    q.matches.forEach((match, index) => {
                        if (selectedTargets[index] === match.target) correctMatches++;
                    });
                    score = (correctMatches / q.matches.length) * maxScoreForQuestion; // Menggunakan skor desimal
                    isCorrect = (score === maxScoreForQuestion);
                }
            }
                
            if (q.type !== 'essay') { 
                if (isCorrect) {
                    feedback = qState.isConsulted ? `Jawaban Benar dengan Bantuan Ahli! Mendapat ${score.toFixed(2)} Poin.` : 'Jawaban Benar! üéâ';
                } else {
                    if (qState.isConsulted) {
                        feedback = `Jawaban salah, meskipun sudah menggunakan Ahli. Mendapat ${score.toFixed(2)} Poin.`;
                    } else {
                        feedback = 'Jawaban Salah. Anda bisa coba Tanya Ahli (Max 5 Poin), atau Lewati Soal.';
                    }
                }
            } 
            
            if (isCorrect || qState.isConsulted || score > 0) { 
                appState.scores[appState.currentMission][q.id].score = score;
                appState.scores[appState.currentMission][q.id].completed = true;
                appState.scores[appState.currentMission][q.id].skipped = false;
                appState.scores[appState.currentMission][q.id].currentAnswer = qState.currentAnswer; 

                renderQuestionInput(q, appState.scores[appState.currentMission][q.id]);
                
                navigateToNextQuestion();

            } else {
                document.getElementById('submit-answer-btn').disabled = true;
                document.getElementById('skip-btn').disabled = false; 
                document.getElementById('play-audio-btn').disabled = true;
                if (!qState.isConsulted) {
                    document.getElementById('consult-expert-btn').classList.remove('hidden');
                }
            }
            
            document.getElementById('feedback-message').textContent = feedback;
            document.getElementById('feedback-message').classList.toggle('text-green-400', isCorrect);
            document.getElementById('feedback-message').classList.toggle('text-red-400', !isCorrect && score === 0);
            document.getElementById('feedback-message').classList.remove('text-yellow-500', 'text-orange-400');
            document.getElementById('feedback-message').classList.toggle('text-orange-400', score > 0 && score < maxScoreForQuestion); 
            
            saveAppState();
        }
        
        const handleSkip = () => {
            triggerHaptics(50);
            stopCurrentAudio();
            
            const missionQuestions = appState.missions[appState.currentMission];
            const q = missionQuestions.find(item => item.id === appState.currentQuestionId);
            
            if (!q) return;

            trackInputChanges();

            appState.scores[appState.currentMission][q.id].score = 0;
            appState.scores[appState.currentMission][q.id].completed = false; 
            appState.scores[appState.currentMission][q.id].skipped = true;

            document.getElementById('feedback-message').textContent = 'Soal dilewati. Mendapat 0 Poin. Anda dapat kembali mengerjakannya.';
            document.getElementById('feedback-message').classList.add('text-yellow-500');
            document.getElementById('feedback-message').classList.remove('text-green-400', 'text-red-400');
            
            document.getElementById('consult-expert-btn').classList.add('hidden'); 

            navigateToNextQuestion();
        }

        const sendDataToGoogleSheet = async (data) => {
            console.log("Mencoba mengirim data ke Google Sheets...");
            if (APPS_SCRIPT_URL.includes('GANTI_DENGAN_URL')) {
                console.error("ERROR: Harap ganti APPS_SCRIPT_URL dengan URL Web App Anda.");
                showModal('Peringatan Data', 'URL Apps Script belum diatur. Data tidak disimpan.');
                return;
            }

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });
                console.log("Data berhasil dikirim ke Apps Script (asumsi berhasil karena no-cors).");

            } catch (error) {
                console.error("Gagal mengirim data ke Apps Script:", error);
                showModal('Kesalahan Penyimpanan', 'Gagal terhubung ke server penyimpanan (Apps Script). Cek koneksi atau URL Web App Anda.');
            }
        }
        
        const clearInputFields = () => {
            document.getElementById('nama-input').value = '';
            document.getElementById('jurusan-input').value = '';
            document.getElementById('kelas-input').value = '';
            checkProfileInputs();
            saveAppState();
        }
        
        const handleCheatingAttempt = (message) => {
            if (isAppInitializing) {
                console.warn('[AC] Diabaikan (INIT): Event terjadi saat aplikasi memuat ulang.');
                return;
            }
            
            if (appState.screen === 'penalty') {
                return;
            }

            if (appState.screen !== 'inMission' || !appState.isCheatingListenerActive || document.getElementById('modal').classList.contains('flex')) {
                 return; 
            }

            console.warn(`[AC] PELANGGARAN TERDETEKSI: ${message}. Count: ${appState.cheatingCount + 1}`);

            stopMissionTimer(); 

            appState.cheatingCount++;
            
            if (appState.cheatingCount >= MAX_CHEATING_ATTEMPTS) {
                const failureMessage = 'ANDA TELAH MELEBIHI BATAS PELANGGARAN!'; 
                
                appState.isCheatingListenerActive = false; 

                showModal(failureMessage, 
                        `Anda telah melakukan ${MAX_CHEATING_ATTEMPTS} pelanggaran. Pengerjaan dihentikan dan dicatat.`, 
                        () => {
                               // Tandai semua soal yang belum selesai sebagai selesai (skor 0)
                               const missionName = appState.currentMission;
                               if (missionName) {
                                   appState.missions[missionName].forEach(q => {
                                       if (!appState.scores[missionName][q.id].completed) {
                                           appState.scores[missionName][q.id] = { 
                                               score: 0, 
                                               completed: true, 
                                               skipped: true, 
                                               isConsulted: false, 
                                               currentAnswer: q.type === 'grid_tf' ? {} : null 
                                           };
                                       }
                                   });
                               }
                               appState.screen = 'finished';
                               updateAppScreen();
                            }
                );
                return;
            }
            
            document.getElementById('penalty-reason').textContent = message;
            document.getElementById('penalty-count').textContent = appState.cheatingCount;
            appState.screen = 'penalty'; 
            updateAppScreen();
        }

        const renderFinalScreen = async () => {
            stopMissionTimer();
            
            appState.isCheatingListenerActive = false; 

            const missionName = appState.currentMission;

            if (appState.missionElapsedTime > 0) {
                 totalTimeSeconds += appState.missionElapsedTime;
                 appState.missionElapsedTime = 0;
            }

            const finalScore = calculateGameScore(); 
            const totalConsultations = calculateTotalConsultations();

            document.getElementById('mission-final-title').textContent = missionName;
            document.getElementById('mission-final-score').textContent = finalScore.toFixed(2); // Menampilkan dua desimal
            document.getElementById('max-game-score').textContent = MAX_GAME_SCORE;
            document.getElementById('final-user-info').textContent = `${userInfo.nama} dari ${userInfo.jurusan} (${userInfo.kelas})`;
            document.getElementById('total-time-display').textContent = formatTime(totalTimeSeconds); 
            
            const essayQuestionId = appState.missions[missionName].find(q => q.type === 'essay')?.id;
            const essayAnswer = essayQuestionId ? getEssayAnswer(missionName, essayQuestionId) : '- Tidak Ditemukan -';


            const dataToSave = {
                timestamp: new Date().toLocaleString('id-ID'),
                nama_lengkap: userInfo.nama,
                kelas: userInfo.kelas,
                jurusan: userInfo.jurusan,
                skor_total: finalScore.toFixed(2),
                waktu_total: formatTime(totalTimeSeconds), 
                status: appState.cheatingCount >= MAX_CHEATING_ATTEMPTS ? `GAGAL KARENA ${appState.cheatingCount} PELANGGARAN` : 'SELESAI NORMAL',
                
                // JAWABAN ESAI
                essay_jawaban: essayAnswer, // Menggunakan kolom tunggal
                
                // DATA TAMBAHAN
                jumlah_pelanggaran: appState.cheatingCount,     
                jumlah_tanya_ahli: totalConsultations,          
            };
            
            sendDataToGoogleSheet(dataToSave);

            const nextActionBtn = document.getElementById('next-action-btn');
            
            nextActionBtn.textContent = 'Keluar & Mulai Sesi Baru';
            nextActionBtn.onclick = () => {
                triggerHaptics(50);
                resetGameStateAndUser();
                appState.screen = 'intro';
                updateAppScreen();
            };
        }
        
        // --- EVENT LISTENERS ---

        document.getElementById('submit-answer-btn').addEventListener('click', handleSubmit);
        document.getElementById('skip-btn').addEventListener('click', handleSkip);
        document.getElementById('consult-expert-btn').addEventListener('click', handleConsultExpert);
        document.getElementById('finish-mission-btn').addEventListener('click', () => {
            triggerHaptics(150);
            finishQuiz(); 
        });
        
        document.getElementById('next-action-btn').addEventListener('click', function() {
            triggerHaptics(50);
            resetGameStateAndUser(); 
            appState.screen = 'intro';
            updateAppScreen();
        });
        
        document.getElementById('penalty-continue-btn').addEventListener('click', () => {
            triggerHaptics(150);
            
            if (!appState.currentMission) {
                return finishQuiz();
            }
            
            appState.isCheatingListenerActive = true; 
            goToQuestion(appState.currentQuestionId); 
        });

        document.getElementById('nama-input').addEventListener('input', checkProfileInputs);
        document.getElementById('jurusan-input').addEventListener('change', checkProfileInputs); 
        document.getElementById('kelas-input').addEventListener('change', checkProfileInputs); 
        document.getElementById('start-profile-btn').addEventListener('click', handleProfileStart);
        document.getElementById('start-profile-btn').disabled = true; 
        
        document.getElementById('question-input-area').addEventListener('input', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                trackInputChanges();
            }
        });
        
        const hideModal = () => {
            document.getElementById('modal').classList.add('hidden');
            document.getElementById('modal').classList.remove('flex');
            if (modalCloseCallback) {
                modalCloseCallback();
                modalCloseCallback = null;
            }
        }
        document.getElementById('modal-close-btn').addEventListener('click', hideModal);

        // --- Anti-Cheating Event Listeners ---
        
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden' && appState.screen === 'inMission') {
                handleCheatingAttempt("Anda terdeteksi berpindah Tab/Aplikasi saat misi berlangsung. Sesi dibatalkan dan skor direset.");
            }
        });

        window.addEventListener('blur', () => {
            if (appState.screen === 'inMission' && !document.getElementById('modal').classList.contains('flex')) {
                if (!isAppInitializing && !document.hasFocus()) {
                    handleCheatingAttempt("Anda terdeteksi berpindah Aplikasi atau Split-Screen saat misi berlangsung. Sesi dibatalkan dan skor direset.");
                } else if (isAppInitializing) {
                    console.warn('[AC] Diabaikan (INIT-BLUR): Event terjadi saat aplikasi memuat ulang.');
                }
            }
        });

        document.addEventListener('keyup', (e) => {
            if (appState.screen === 'inMission' && (e.key === 'PrintScreen' || e.keyCode === 44)) {
                handleCheatingAttempt("Anda terdeteksi mencoba mengambil tangkapan layar (screenshot). Sesi dibatalkan dan skor direset.");
            }
        });
        
        // --- Inisialisasi Aplikasi ---
        window.onload = () => {
            if (Object.keys(firebaseConfig).length > 0) {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);

                async function authenticate() {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                        userId = auth.currentUser?.uid || crypto.randomUUID();
                    } catch (error) {
                        console.error("Gagal autentikasi Firebase:", error);
                    }
                }
                authenticate();
            } else {
                console.warn("Firebase config tidak tersedia.");
            }
            
            // 1. Inisialisasi data game (Hanya satu misi)
            initGameData();

            // 2. Muat state yang tersimpan
            if (!loadAppState()) { 
                // Data baru
                appState.screen = 'intro';
                clearInputFields();
                updateAppScreen(); 
            }

            // 3. Set App Initializing flag
            setTimeout(() => {
                isAppInitializing = false; 
                console.log("[AC] Inisialisasi Selesai. Anti-Cheating Aktif.");
            }, 500); 
        }

    </script>
</body>
</html>
